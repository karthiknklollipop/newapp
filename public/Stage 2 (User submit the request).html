<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ETG Travel ‚Äì New Request (Enhanced)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      /* üå± Theme C ‚Äì Soft Mint + Teal */
      --bg: #e8f5f3; /* soft mint background */
      --bg-elev: #ffffff; /* card surface */
      --muted: #5b7a78; /* soft desaturated teal/grey */
      --text: #123c3d; /* deep teal text */
      --accent: #0fb9b1; /* primary teal */
      --accent-2: #45dfc3; /* lighter mint accent */
      --border: #bcd6d3; /* subtle mint-grey border */
      --ring: #9cefe6; /* focus ring */
      --danger: #d9534f; /* errors */
      --danger-bg:#fcebea; /* error bg */
      --success: #16a34a; /* success */
      --warning: #f59e0b; /* warning */
      --shadow: 0 10px 25px rgba(0, 80, 70, 0.08);
      --radius: 16px;
    }

    @media (prefers-color-scheme: dark){
      :root{
        --bg:#021615;
        --bg-elev:#041f20;
        --text:#e5f6f5;
        --muted:#7aa5a2;
        --border:#0b2e30;
        --accent:#34d1c5;
        --accent-2:#4ff0cf;
        --ring:#36cfc9;
        --shadow: 0 16px 30px rgba(0,0,0,.55);
        --danger-bg:#2a1414;
      }
    }

    *{box-sizing:border-box}
    html,body{font-size:14px;height:100%}
    body{font-size:14px;
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:var(--bg);
      color:var(--text);
      margin:0
    }

    /* Header */
    .header{
      position:sticky;top:0;z-index:40;
      background:linear-gradient(180deg,rgba(232,245,243,.96),rgba(232,245,243,.80));
      backdrop-filter: blur(8px);
      border-bottom:1px solid var(--border);
    }
    @media (prefers-color-scheme: dark){
      .header{
        background:linear-gradient(180deg,rgba(2,22,21,.96),rgba(2,22,21,.88));
      }
    }
    .header-inner{
      max-width:1180px;margin:0 auto;
      padding:14px 20px;
      display:flex;align-items:center;gap:14px
    }
    .logo{
      display:grid;place-items:center;
      width:36px;height:36px;border-radius:10px;
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:white;font-weight:800;box-shadow:var(--shadow)
    }
    .brand{font-weight:800;letter-spacing:.2px}
    .header-left{display:flex;align-items:center;gap:14px;}
    .main-nav{display:flex;align-items:center;gap:18px;margin-left:24px;}
    .nav-link{font-size:14px;font-weight:500;color:var(--muted);text-decoration:none;padding:6px 10px;border-radius:999px;transition:background .15s ease,color .15s ease;}
    .nav-link.active,.nav-link:hover{color:var(--accent);background:rgba(249,115,22,.08);}
    .header-actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .user-menu{
      position:relative;
    }
    .user-avatar{
      border:none;
      background:var(--accent);
      color:#fff;
      width:32px;height:32px;
      border-radius:50%;
      display:grid;place-items:center;
      font-weight:700;
      font-size:14px;
      letter-spacing:0.04em;
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .user-avatar:focus-visible{
      outline:2px solid var(--ring);
      outline-offset:2px;
    }
    .user-dropdown{
      position:absolute;
      right:0;
      margin-top:8px;
      min-width:220px;
      background:var(--bg-elev);
      border-radius:12px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:10px;
      display:none;
      z-index:50;
    }
    .user-dropdown.open{display:block;}
    .user-info{
      display:flex;
      align-items:center;
      gap:10px;
      padding-bottom:8px;
      border-bottom:1px dashed var(--border);
      margin-bottom:6px;
    }
    .user-initials{
      display:grid;place-items:center;
      width:32px;height:32px;
      border-radius:50%;
      background:rgba(15,185,177,.08);
      color:var(--accent);
      font-weight:700;
    }
    .user-initials.large{
      width:40px;height:40px;
    }
    .user-name{font-weight:700;}
    .user-role{
      font-size:12px;
      color:var(--muted);
    }
    .dropdown-item{
      width:100%;
      text-align:left;
      border:none;
      background:transparent;
      padding:6px 4px;
      border-radius:8px;
      font-size:14px;
      cursor:pointer;
      color:var(--text);
      font-weight:500;
    }
    .dropdown-item:hover{
      background:rgba(15,185,177,.06);
    }

    .profile-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:80;
    }
    .profile-modal.open{display:flex;}
    .profile-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.25);
    }
    .profile-panel{
      position:relative;
      max-width:960px;
      width:90%;
      max-height:90vh;
      overflow:auto;
      background:var(--bg-elev);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:20px 24px 24px;
    }
    .profile-header{
      display:flex;
      gap:24px;
      margin-bottom:18px;
      align-items:center;
    }
    .profile-avatar{
      width:72px;height:72px;
      border-radius:50%;
      display:grid;place-items:center;
      background:var(--accent);
      color:#fff;
      font-size:28px;
      font-weight:700;
    }
    .profile-mainname{
      font-size:20px;
      font-weight:800;
      margin-bottom:2px;
    }
    .profile-header-sub{
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .profile-meta{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:10px;
      font-size:14px;
    }
    .profile-label{
      font-size:11px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      margin-bottom:2px;
    }
    .profile-value{
      font-weight:600;
    }
    .profile-layout{
      display:grid;
      grid-template-columns:220px minmax(0,1fr);
      gap:18px;
    }
    .profile-nav{
      border-right:1px solid var(--border);
      padding-right:14px;
    }
    .profile-nav-title{
      font-size:12px;
      font-weight:700;
      color:var(--muted);
      margin-bottom:10px;
      text-transform:uppercase;
    }
    .profile-tabs-list{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .profile-tab{
      border:none;
      background:transparent;
      width:100%;
      text-align:left;
      padding:6px 8px;
      border-radius:8px;
      font-size:14px;
      cursor:pointer;
      color:var(--text);
    }
    .profile-tab[disabled]{
      opacity:.45;
      cursor:not-allowed;
    }
    .profile-tab.active{
      background:rgba(15,185,177,.08);
      font-weight:600;
    }
    .profile-content-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:12px;
    }
    .profile-content-header h3{
      margin:0;
      font-size:16px;
    }
    .profile-edit{
      border:1px solid var(--border);
      background:transparent;
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      color:var(--muted);
    }
    .profile-edit:hover{background:rgba(15,185,177,.06);}
    .profile-edit[disabled]{opacity:.45;cursor:not-allowed;}
    .profile-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:12px;
    }
    .profile-field{
      padding:10px 12px;
      border-radius:10px;
      border:1px dashed var(--border);
      background:rgba(255,255,255,0.6);
    }
    .profile-mainname[contenteditable="true"],
    .profile-header-sub[contenteditable="true"],
    .profile-value[contenteditable="true"]:not(.profile-value-select){
      outline:none;
      border-bottom:1px dashed var(--border);
      cursor:text;
    }

    .profile-close{
      position:absolute;
      top:10px;
      right:14px;
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      color:var(--muted);
    }

    .kbd{
      font:600 12px/1 Inter;
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:8px;
      color:var(--muted);
      background:rgba(255,255,255,0.6);
    }
    .theme-toggle{
      appearance:none;border:1px solid var(--border);
      background:var(--bg-elev);padding:8px 10px;
      border-radius:10px;cursor:pointer
    }

    /* Layout */
    main{max-width:1180px;margin:22px auto;padding:0 20px 50px}
    .page-intro{display:flex;gap:14px;align-items:flex-start;margin-bottom:16px}
    .stepper{flex:1;display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .step{
      position:relative;padding:12px;border:1px solid var(--border);
      background:var(--bg-elev);border-radius:12px;display:flex;
      gap:10px;align-items:center;box-shadow:var(--shadow)
    }
    .step .num{
      width:28px;height:28px;border-radius:50%;
      display:grid;place-items:center;font-weight:800;border:1px solid var(--border);
    }
    .step .txt{font-weight:700}
    .step[aria-current="true"]{outline:2px solid rgba(156,239,230,.8)}
    .step.done .num{
      background:linear-gradient(135deg,var(--accent),var(--accent-2));
      color:#fff;border:none
    }

    /* Cards */
    .card{
      background:var(--bg-elev);border:1px solid var(--border);
      border-radius:var(--radius);padding:20px;margin-bottom:22px;box-shadow:var(--shadow);
    }
    .subcard{
      border:1px dashed var(--border);
      background:rgba(15,185,177,0.04);
      border-radius:14px;padding:16px
    }
    .title{font-weight:800;margin-bottom:8px;letter-spacing:.2px}
    .hint{font-size:13px;color:var(--muted)}

    /* Grid */
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-2{grid-column:span 2}
    .col-3{grid-column:span 3}
    .col-4{grid-column:span 4}
    .col-5{grid-column:span 5}
    .col-6{grid-column:span 6}
    .col-8{grid-column:span 8}
    .col-12{grid-column:span 12}
    @media (max-width:960px){
      .col-2,.col-3,.col-4,.col-5,.col-6,.col-8{grid-column:span 12}
    }

    label{
      display:block;font-size:12px;color:var(--muted);
      margin:0 0 6px 2px;font-weight:600;letter-spacing:.2px
    }
    input,select,textarea{
      width:100%;padding:12px 14px;
      border:1px solid var(--border);border-radius:12px;
      background:var(--bg-elev);color:var(--text);
      transition: box-shadow .15s ease,border-color .15s ease,transform .06s ease
    }
    input:focus,select:focus,textarea:focus{
      outline:none;border-color:var(--ring);
      box-shadow:0 0 0 4px rgba(156,239,230,.55)
    }
    input:hover,select:hover,textarea:hover{border-color:#90c5be}
    input:active,select:active,textarea:active{transform: translateY(1px)}

    /* Make date/time picker icon clearly visible */
    input[type="date"], input[type="time"]{
      padding-right:40px;
    }
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator{
      opacity:1;
      filter:invert(0.25);
      cursor:pointer;
    }

    .actions{
      display:flex;gap:12px;justify-content:flex-end;margin-top:14px;
      position:sticky;bottom:0;padding-top:12px;
      background:linear-gradient(180deg,rgba(232,245,243,0),var(--bg) 40%)
    }
    .btn{
      background:linear-gradient(90deg,var(--accent),var(--accent-2));
      color:#fff;border:none;border-radius:12px;
      padding:12px 16px;font-weight:800;cursor:pointer;box-shadow:var(--shadow)
    }
    .btn.secondary{background:transparent;color:var(--text);border:1px solid var(--border)}
    .btn.ghost{background:transparent;color:var(--muted);border:none}
    .btn:focus{outline:3px solid rgba(156,239,230,.8)}
    .divider{height:1px;background:var(--border);margin:14px 0}
    .kv{display:flex;gap:8px;align-items:center;margin:6px 0}
    .kv b{min-width:180px}
    
    /* --- Enterprise Review Summary (Step 4: Review & Submit) --- */
    .review-top{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;margin:8px 0 14px}
    .review-h{font-size:18px;font-weight:900;letter-spacing:-.01em}
    .review-sub{color:var(--muted);font-size:13px;margin-top:4px}
    .review-links{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .review-link{background:transparent;border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:800;font-size:13px}
    .review-link:hover{border-color:rgba(16,185,129,.55);box-shadow:0 10px 24px rgba(2,6,23,.06)}
    .review-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .review-card{grid-column:span 12;background:rgba(255,255,255,.65);border:1px solid var(--border);border-radius:18px;padding:14px 14px 10px;box-shadow:0 10px 24px rgba(2,6,23,.06)}
    @media (min-width: 900px){
      .review-card.half{grid-column:span 6}
      .review-card.third{grid-column:span 4}
    }
    .review-card-title{display:flex;gap:10px;align-items:center;font-weight:900;margin-bottom:10px}
    .review-card-title small{color:var(--muted);font-weight:800}
    .review-rows{display:flex;flex-direction:column;gap:8px}
    .review-row{display:grid;grid-template-columns:180px 1fr;gap:10px;align-items:start;padding:6px 0;border-top:1px dashed rgba(148,163,184,.35)}
    .review-row:first-child{border-top:none;padding-top:0}
    .review-label{color:var(--muted);font-weight:800}
    .review-value{font-weight:900}
    .review-value .stack{display:flex;flex-direction:column;gap:6px}
    .review-chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid rgba(148,163,184,.45);font-size:12px;font-weight:900}
    .review-chip.ok{border-color:rgba(16,185,129,.45)}
    .review-chip.warn{border-color:rgba(245,158,11,.55);background:rgba(245,158,11,.08)}
    .doc-link{display:inline-flex;align-items:center;gap:6px;font-weight:900;text-decoration:none;border-bottom:1px dashed rgba(16,185,129,.55)}
    .doc-link:hover{opacity:.9}

.field-error{font-size:12px;color:var(--danger);margin-top:6px}
    .is-invalid{border-color:var(--danger)!important;background:var(--danger-bg)}

    .segTabs{
      display:flex;gap:8px;
      background:rgba(15,185,177,0.04);
      padding:6px;border-radius:12px;border:1px solid var(--border);flex-wrap:wrap
    }
    .segTab{
      appearance:none;border:1px solid var(--border);
      background:var(--bg-elev);padding:10px 14px;border-radius:12px;
      font-weight:800;color:var(--text);cursor:pointer
    }
    .segTab[aria-pressed="true"]{
      outline:2px solid rgba(156,239,230,.7);
      background:var(--bg-elev)
    }
    .hidden{display:none}
    .badge{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 8px;border-radius:999px;
      border:1px solid var(--border);font-size:12px;color:var(--muted);
      background:rgba(255,255,255,0.8);
    }

    /* Swap button layout between From and To */
    .route-row{align-items:end;}
    .route-swap-col{display:flex;justify-content:center;align-items:center;margin-bottom:4px;}
    .swap-btn{
      width:44px;
      height:44px;
      border-radius:999px;
      border:1px solid var(--accent);
      background:var(--bg-elev);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      line-height:1;
      color:var(--accent);
      cursor:pointer;
      box-shadow:var(--shadow);
    }
    .swap-btn:focus{outline:3px solid rgba(156,239,230,.8)}
    [data-theme='dark'] .swap-btn{
      border-color:var(--accent-2);
      color:var(--accent-2);
    }
    .swap-btn:focus{outline:3px solid rgba(156,239,230,.8)}

    /* Toast */
    .toast{position:fixed;right:20px;bottom:20px;z-index:50;display:grid;gap:10px}
    .toast .note{
      background:var(--bg-elev);border:1px solid var(--border);
      box-shadow:var(--shadow);border-radius:12px;
      padding:10px 12px;font-weight:600
    }

    /* Animations */
    .fade-in{animation:fade .2s ease both}
    @keyframes fade{
      from{opacity:0;transform:translateY(6px)}
      to{opacity:1;transform:none}
    }
    @media (prefers-reduced-motion: reduce){.fade-in{animation:none}}

    /* Help line */
    .help{
      display:flex;align-items:center;gap:10px;padding:12px;
      border:1px solid var(--border);border-radius:12px;background:var(--bg-elev)
    }

    .visually-hidden{
      position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;
      overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0
    }

    /* HERO / HOME SECTION */
    .hero{
      background:#ffe9d6;
      border-bottom:1px solid rgba(0,0,0,.04);
    }
    .hero-inner{
      max-width:1180px;
      margin:0 auto;
      padding:40px 24px 32px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:32px;
    }
    .hero-text{
      max-width:560px;
    }
    .hero-kicker{
      font-size:13px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted);
      margin-bottom:8px;
    }
    .hero-title{
      font-size:32px;
      line-height:1.25;
      font-weight:800;
      margin-bottom:8px;
    }
    .hero-subtitle{
      font-size:15px;
      color:var(--muted);
      max-width:480px;
    }
    .hero-actions{
      margin-top:20px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .btn-hero{
      background:#f97316;
      color:#fff;
      border:none;
      padding:10px 20px;
      border-radius:999px;
      font-weight:600;
      font-size:14px;
      cursor:pointer;
      box-shadow:0 8px 18px rgba(0,0,0,.1);
    }
    .btn-hero:hover{
      transform:translateY(-1px);
      box-shadow:0 10px 22px rgba(0,0,0,.16);
    }
    .hero-note{
      font-size:12px;
      color:var(--muted);
    }
    .hero-graphic{
      flex:1;
      min-width:240px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .hero-card{
      background:#fff;
      border-radius:20px;
      padding:16px;
      box-shadow:var(--shadow-soft);
      font-size:13px;
    }
    .hidden{
      display:none !important;
    }

.profile-phone-select {
  padding: 6px 8px !important;
  font-size: 14px !important;
  height: 34px !important;
}


/* Smaller profile modal font */
.profile-panel, .profile-panel * {
  font-size: 14px !important;
}
.profile-mainname { font-size: 20px !important; }
.profile-header-sub { font-size: 14px !important; }
.profile-label { font-size: 12px !important; }
.profile-value { font-size: 14px !important; }
  
    /* My Trips UI polish */
    .container{max-width:1180px;margin:0 auto;padding:22px 20px 50px;}
    .section-header{margin-bottom:14px;}
    .section-title{margin:0;font-size:28px;font-weight:800;letter-spacing:.2px;}
    .section-subtitle{margin:6px 0 0;color:var(--muted);}
    .card-body{padding:0;}
    .form-row{display:flex;flex-wrap:wrap;}
    .form-field{display:flex;flex-direction:column;gap:6px;}
    .form-label{font-size:12px;color:var(--muted);font-weight:600;letter-spacing:.2px;margin-left:2px;}
    .form-input,.form-select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;background:var(--bg-elev);color:var(--text);}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:800;cursor:pointer;box-shadow:var(--shadow);}
    .btn-secondary{background:transparent;color:var(--text);border:1px solid var(--border);border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer;}
    .btn-sm{padding:8px 12px;border-radius:10px;font-weight:800;}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:var(--muted);background:rgba(255,255,255,.8);}
    .trip-card{border:1px solid var(--border);border-radius:14px;padding:14px 14px 12px;margin:10px 0;background:rgba(255,255,255,.85);box-shadow:0 8px 18px rgba(0,80,70,.06);}
    .trip-card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;}
    .trip-card-title{font-size:16px;font-weight:800;margin-bottom:2px;}
    .trip-card-sub{font-size:13px;color:var(--muted);}
    .trip-card-actions{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}

    /* Option A card enhancements */
    .trip-left{display:flex;align-items:center;gap:12px;min-width:220px;}
    .trip-avatar{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;
      font-weight:900;letter-spacing:0.5px;background:linear-gradient(135deg, rgba(26,188,156,.18), rgba(45,106,79,.12));
      border:1px solid rgba(26,188,156,.35);color:#0d3b2f;flex:0 0 auto;}
    .trip-meta-grid{margin-top:12px;display:grid;grid-template-columns:repeat(12,1fr);gap:10px;}
    .trip-meta-grid .meta-item{grid-column:span 6;display:flex;align-items:center;gap:10px;
      padding:10px 12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.72);}
    .trip-meta-grid .meta-item .pill{margin:0;white-space:nowrap;}
    .trip-meta-grid .meta-text{font-size:13px;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
    
    /* Trip list (Option A - header + rows) */
    /*
      Trips list: enable BOTH horizontal and vertical scrolling.
      This ensures columns like "View Details" are reachable even when the viewport is narrow.
    */
    .trip-list{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:auto;              /* <- both scrollbars when needed */
      max-height:420px;           /* vertical scroll within dashboard */
      background:rgba(255,255,255,.82);
    }

    /* Give the grid a minimum width so horizontal scrolling appears instead of clipping columns */
    .trip-list-header,.trip-list-row{min-width:1200px;}
    .trip-list-header,.trip-list-row{display:grid;grid-template-columns: 140px 190px 170px 190px 140px 120px 130px 160px 170px 220px;align-items:center;}
    .trip-list-header{background:rgba(240,250,248,.8);border-bottom:1px solid var(--border);font-size:12px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-weight:800;}
    .trip-list-header .col{padding:12px 14px;}
    .trip-list-row{border-bottom:1px solid rgba(0,0,0,.04);}
    .trip-list-row:last-child{border-bottom:none;}
    .trip-list-row .col{padding:12px 14px;font-size:14px;}
    .user-cell{display:flex;align-items:center;gap:10px;min-width:0;}
    .user-avatar{width:34px;height:34px;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;font-weight:900;border:1px solid var(--border);background:rgba(236,252,248,.9);color:var(--text);flex:0 0 auto;}
    .user-name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .actions-cell{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;}
    .col-actions{justify-self:stretch;}
    .pill-success{background:rgba(236,252,248,.95);}
    .pill-warning{background:rgba(255,247,237,.95);}

    @media (max-width: 1100px){
      .trip-list-header,.trip-list-row{grid-template-columns: 120px 160px 150px 170px 120px 100px 110px 140px 150px 200px;}
    }
    @media (max-width: 920px){
      .trip-list{border-radius:16px;}
      .trip-list-header{display:none;}
      .trip-list-row{grid-template-columns: 1fr;gap:8px;padding:12px 14px;}
      .trip-list-row .col{padding:0;}
      .trip-list-row .col::before{
        content: attr(data-label);
        display:block;
        font-size:11px;
        letter-spacing:.08em;
        text-transform:uppercase;
        color:var(--muted);
        font-weight:900;
        margin-bottom:2px;
      }
      .actions-cell{justify-content:flex-start;}
    }

@media (max-width: 820px){
      .trip-meta-grid .meta-item{grid-column:span 12;}
      .trip-left{min-width:0;}
    }

    /* Option A list-style meta */
    .trip-meta-list{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;}
    .trip-meta-list .meta-chip{display:flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--border);border-radius:14px;background:rgba(255,255,255,.72);}
    .trip-meta-list .meta-chip .k{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);font-weight:900;white-space:nowrap;}
    .trip-meta-list .meta-chip .v{font-size:13px;color:var(--text);font-weight:700;white-space:nowrap;}
    .trip-meta-list .meta-chip .v.mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;font-weight:800;}
    @media (max-width: 820px){
      .trip-meta-list .meta-chip{flex:1 1 100%;}
      .trip-meta-list .meta-chip .v{white-space:normal;}
    }

    /* Reports */
    .report-metrics{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;}
    .report-metrics .metric{border:1px solid var(--border);border-radius:16px;padding:12px 14px;background:rgba(255,255,255,.72);}
    .report-metrics .metric .k{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
    .report-metrics .metric .v{font-size:24px;font-weight:900;color:var(--text);line-height:1;}
    @media (max-width: 900px){ .report-metrics{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 520px){ .report-metrics{grid-template-columns:1fr;} }

    .report-table-wrap{width:100%;}
    .report-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;font-size:13px;}
    .report-table th,.report-table td{padding:12px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle;}
    .report-table th{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:800;}
    .report-table tr:hover td{background:rgba(26,188,156,.06);}


    /* Analytics */
    .analytics-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:8px;}
    .analytics-grid .metric{border:1px solid var(--border);border-radius:16px;padding:12px 14px;background:rgba(255,255,255,.72);}
    .analytics-grid .metric .k{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
    .analytics-grid .metric .v{font-size:22px;font-weight:900;color:var(--text);line-height:1;}
    .analytics-grid .metric .s{margin-top:6px;font-size:12px;color:var(--muted);}
    @media (max-width: 900px){ .analytics-grid{grid-template-columns:repeat(2,1fr);} }
    @media (max-width: 520px){ .analytics-grid{grid-template-columns:1fr;} }

    .analytics-layout{display:grid;grid-template-columns:1.15fr .85fr;gap:12px;margin-top:14px;}
    @media (max-width: 980px){ .analytics-layout{grid-template-columns:1fr;} }

    .chart-card{border:1px solid var(--border);border-radius:18px;background:rgba(255,255,255,.72);padding:14px;}
    .chart-title{margin:0 0 10px;font-size:13px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:900;}
    .barlist{display:grid;gap:8px;}
    .barrow{display:grid;grid-template-columns:130px 1fr 46px;gap:10px;align-items:center;}
    .barlabel{font-size:13px;color:var(--text);font-weight:700;}
    .bartrack{height:10px;border-radius:999px;border:1px solid var(--border);background:rgba(15,185,177,.06);overflow:hidden;}
    .barfill{height:100%;border-radius:999px;background:linear-gradient(90deg, rgba(15,185,177,.95), rgba(26,188,156,.55));width:0%;}
    .barvalue{font-size:12px;color:var(--muted);text-align:right;font-weight:800;}
    .analytics-table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px;font-size:13px;}
    .analytics-table th,.analytics-table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top;}
    .analytics-table th{font-size:12px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);font-weight:800;}
    .analytics-table tr:hover td{background:rgba(26,188,156,.06);}

    .trip-card-body{margin-top:10px;display:grid;gap:8px;}
    .meta{font-size:13px;color:var(--text);}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-top:14px;margin-bottom:8px;}
    .tabBtn{border:1px solid var(--border);background:var(--bg-elev);padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer;color:var(--text);}
    .tabBtn.active{outline:2px solid rgba(156,239,230,.7);background:rgba(15,185,177,.06);}
    .empty-state{border:1px dashed var(--border);border-radius:14px;padding:18px;text-align:center;background:rgba(15,185,177,0.04);margin-top:14px;}
    .empty-state-icon{font-size:28px;margin-bottom:6px;}
    .empty-state-title{font-size:16px;font-weight:800;margin-bottom:4px;}
    .empty-state-text{color:var(--muted);margin-bottom:10px;}
    /* Trip details modal */
    .trip-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:90;}
    .trip-modal.open{display:flex;}
    .trip-modal .backdrop{position:absolute;inset:0;background:rgba(0,0,0,.25);}
    .trip-modal .panel{position:relative;max-width:860px;width:92%;max-height:88vh;overflow:auto;background:var(--bg-elev);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px 20px;}
    .trip-modal h3{margin:0 0 10px;font-size:18px;}
    .trip-modal .close{position:absolute;top:10px;right:12px;border:none;background:transparent;font-size:18px;cursor:pointer;color:var(--muted);}
    .trip-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;}
    .trip-field{border:1px dashed var(--border);border-radius:12px;padding:10px 12px;background:rgba(255,255,255,.6);}
    .trip-field .k{font-size:11px;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:2px;}
    .trip-field .v{font-weight:700;word-break:break-word;}

  
    
    .mytrips-footer{margin-top:14px;display:flex;justify-content:flex-start;}
/* Policy Document Modal */
    .policy-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:85;
    }
    .policy-modal.open{display:flex;}
    .policy-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.25);
    }
    .policy-panel{
      position:relative;
      max-width:980px;
      width:92%;
      max-height:90vh;
      overflow:auto;
      background:var(--bg-elev);
      border-radius:var(--radius);
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      padding:18px 20px 20px;
    }
    .policy-close{
      position:absolute;
      top:10px;
      right:14px;
      border:none;
      background:transparent;
      font-size:18px;
      cursor:pointer;
      color:var(--muted);
    }
    .policy-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .policy-title{
      font-size:18px;
      font-weight:800;
      margin:0;
    }
    .policy-meta{
      font-size:12px;
      color:var(--muted);
      margin-top:4px;
    }
    .policy-actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .policy-actions .btn-secondary{
      padding:8px 12px;
    }
    .policy-uploader{
      border:1px dashed var(--border);
      border-radius:14px;
      padding:12px;
      background:rgba(15,185,177,0.04);
      margin:12px 0;
      display:grid;
      gap:10px;
    }
    .policy-preview{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:rgba(255,255,255,0.65);
    }
    .policy-preview iframe{
      width:100%;
      height:70vh;
      border:0;
    }
    .policy-empty{
      padding:16px;
      text-align:center;
      color:var(--muted);
    }

</style>
</head>
<body>
  <div class="header">
    <div class="header-inner">
      <div class="header-left">
        <div class="logo" aria-hidden="true">ET</div>
        <div class="brand">ETG Travel</div>
        <nav class="main-nav" aria-label="Primary">
          <a href="#" class="nav-link active" id="navHome">Home</a>
          <a href="#" class="nav-link" id="navTrips">Trips</a>
          <a href="#" class="nav-link" id="navApprovals">Approvals</a>
          <a href="#" class="nav-link" id="navReport">Report</a>
          <a href="#" class="nav-link" id="navAnalytics">Analytics</a>
        </nav>
      </div>
      <div class="header-actions">
        <span class="badge" title="Your entries are autosaved locally">Autosave On <span style="margin-left:10px;font-size:11px;font-weight:700;color:#0f766e;background:rgba(13,148,136,.12);border:1px solid rgba(13,148,136,.25);padding:4px 8px;border-radius:999px;">Stage2 FIX v2</span></span>
        <button class="theme-toggle" id="toggleTheme" aria-label="Toggle theme">üåó</button>
        <span class="kbd" title="Keyboard shortcut">Press ‚èé to continue</span>
        <div class="user-menu">
          <button class="user-avatar" id="userAvatar" aria-haspopup="true" aria-expanded="false">--</button>
          <div class="user-dropdown" id="userDropdown">
            <div class="user-info">
              <div class="user-initials large" id="userInitialsLarge">--</div>
              <div>
                <div class="user-name" id="userNameText">‚Äî</div>
                <div class="user-role" id="userRoleText">‚Äî</div>
              </div>
            </div>
            <button class="dropdown-item" id="openProfile" type="button">My Profile</button>
                        <button class="dropdown-item" id="openRolesApprovers" type="button">Roles &amp; Approvers</button>
<button class="dropdown-item" id="openPolicy" type="button">Policy Document</button>
            <button class="dropdown-item" type="button">Help &amp; Support</button>
            <button class="dropdown-item" id="btnSignOut" type="button">Sign Out</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <main>
    <!-- HOME / HERO -->
    <section class="hero" id="heroSection">
      <div class="hero-inner">
        <div class="hero-text">
          <div class="hero-kicker">Welcome, <span id="welcomeName">‚Äî</span></div>
          <h1 class="hero-title">Your business trips in a breeze, create your trip now!</h1>
          <p class="hero-subtitle">Just add all your travel products in the trip for seamless booking experience. It&apos;s that simple.</p>
          <div class="hero-actions">
            <button class="btn-hero" id="createTripBtn" type="button">Create Trip</button>
            <button class="btn-hero" id="myTripsBtn" type="button" style="background:#4b5563;">My Trips</button>
            <div class="hero-note">No trips yet ‚Äì start by creating your first trip.</div>
          </div>
        </div>
      </div>
    </section>

    <!-- REQUEST WIZARD (HIDDEN UNTIL CREATE TRIP) -->

   

    <section id="myTripsSection" class="hidden">
    <div class="container">
      <div class="section-header">
        <h2 class="section-title">My Trips</h2>
        <p class="section-subtitle">Trips you've created in this browser.</p>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="form-row" style="gap:12px; align-items:flex-end;">
            <div class="form-field" style="flex:1;">
              <label class="form-label" for="tripsSearch">Search</label>
              <input id="tripsSearch" class="form-input" placeholder="Search by title, requester, destination‚Ä¶" />
            </div>
            <div class="form-field" style="width:220px;">
              <label class="form-label" for="tripsSort">Sort</label>
              <select id="tripsSort" class="form-select">
                <option value="new">Newest</option>
                <option value="old">Oldest</option>
                <option value="title">Title (A‚ÄìZ)</option>
              </select>
            </div>
          </div>

          
          <div class="tabs" aria-label="Trip filters">
            <button class="tabBtn active" id="tabAllTrips" type="button">Completed Trip Details</button>
            <button class="tabBtn" id="tabPendingTrips" type="button">Pending Trip Details</button>
          </div>

          <div id="allTripsList" style="margin-top:8px;"></div>
          <div id="pendingTripsList" class="hidden" style="margin-top:8px;"></div>


          <div id="myTripsEmpty" class="empty-state hidden">
            <div class="empty-state-icon">üß≥</div>
            <div class="empty-state-title">No trips yet</div>
            <div class="empty-state-text">Create a trip to see it here.</div>
            <button id="myTripsCreateBtn" class="btn btn-primary" type="button">Create Trip</button>
          </div>
        
          <div class="mytrips-footer">
            <button id="myTripsBackBtn" class="btn-secondary" type="button">Back</button>
          </div>
</div>
      </div>
    </div>
  
  <!-- Trip Details Modal -->
  <div id="tripModal" class="trip-modal" aria-hidden="true">
    <div class="backdrop" id="tripModalBackdrop" aria-hidden="true"></div>
    <div class="panel fade-in" role="dialog" aria-modal="true" aria-labelledby="tripModalTitle">
      <button class="close" id="tripModalClose" type="button" aria-label="Close">‚úï</button>
      <h3 id="tripModalTitle">Trip Details</h3>
      <div class="trip-grid" id="tripModalGrid"></div>
    </div>
  </div>

</section>

 
    <!-- APPROVALS (PLACEHOLDER) -->
    <section id="approvalsSection" class="hidden">
      <div class="container">
        <div class="section-header">
          <h2 class="section-title">Approvals</h2>
          <p class="section-subtitle">Coming soon. This section will show pending approvals routed to you.</p>
        </div>
        <div class="panel" style="padding:18px;">
          <p style="margin:0;color:#516a65;">Nothing to approve right now.</p>
        </div>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="reportSection" class="hidden">
      <div class="container">
        <div class="section-header">
          <div>
            <h2 class="section-title">Report</h2>
            <p class="section-subtitle">Summary of your trips in this browser (demo mode).</p>
          </div>
        </div>

        <div class="card" style="padding:18px;">
          <div class="report-metrics" aria-label="Report summary">
            <div class="metric"><div class="k">Total Trips</div><div class="v" id="repTotalTrips">0</div></div>
            <div class="metric"><div class="k">Completed</div><div class="v" id="repCompletedTrips">0</div></div>
            <div class="metric"><div class="k">Pending</div><div class="v" id="repPendingTrips">0</div></div>
            <div class="metric"><div class="k">International</div><div class="v" id="repInternationalTrips">0</div></div>
          </div>

          <div class="divider" style="margin:16px 0;"></div>

          <div class="report-actions" style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin:8px 0 14px;">
            <button id="reportExportCsvBtn" class="btn btn-secondary btn-sm" type="button">Download Excel</button>
            <button id="reportExportPdfBtn" class="btn btn-secondary btn-sm" type="button">Download PDF</button>
          </div>

          <div class="report-table-wrap">
            <table class="report-table" aria-label="Trip report table">
              <thead>
                <tr>
                  <th>Trip</th>
                  <th>Route</th>
                  <th>Travel Type</th>
                  <th>Status</th>
                  <th>Created</th>
                </tr>
              </thead>
              <tbody id="reportTableBody"></tbody>
            </table>

            <div id="reportEmpty" class="empty-state hidden" style="margin-top:14px;">
              <div class="empty-state-icon">üìä</div>
              <div class="empty-state-title">No report data yet</div>
              <div class="empty-state-text">Create a trip to see your report summary here.</div>
              <button id="reportCreateBtn" class="btn btn-primary" type="button">Create Trip</button>
            </div>
          </div>
        </div>
      </div>
    </section>


    <section id="analyticsSection" class="hidden">
      <div class="container">
        <div class="section-header">
          <div>
            <h2 class="section-title">Analytics</h2>
            <p class="section-subtitle">Corporate analytics view based on your local trip data (demo mode).</p>
          </div>
          <div class="report-actions" style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap; margin-top:6px;">
            <button id="analyticsExportCsvBtn" class="btn btn-secondary btn-sm" type="button">Download Excel</button>
            <button id="analyticsExportPdfBtn" class="btn btn-secondary btn-sm" type="button">Download PDF</button>
          </div>
        </div>

        <div class="card" style="padding:18px;">
          <div class="form-row" style="gap:12px; align-items:flex-end;">
            <div class="form-field" style="width:260px;">
              <label class="form-label" for="analyticsRange">Date Range</label>
              <select id="analyticsRange" class="form-select">
                <option value="all" selected>All time</option>
                <option value="30">Last 30 days</option>
                <option value="90">Last 90 days</option>
                <option value="365">Last 12 months</option>
              </select>
            </div>
            <div class="form-field" style="flex:1;">
              <div class="form-label">Note</div>
              <div style="color:var(--muted);font-size:13px;">This view auto-syncs from the same source as <b>My Trips</b> and <b>Report</b>.</div>
            </div>
          </div>

          <div class="analytics-grid" aria-label="Analytics summary">
            <div class="metric"><div class="k">Total Trips</div><div class="v" id="anTotalTrips">0</div><div class="s" id="anTotalTripsSub">‚Äî</div></div>
            <div class="metric"><div class="k">Completed</div><div class="v" id="anCompletedTrips">0</div><div class="s" id="anCompletedTripsSub">‚Äî</div></div>
            <div class="metric"><div class="k">Pending</div><div class="v" id="anPendingTrips">0</div><div class="s" id="anPendingTripsSub">‚Äî</div></div>
            <div class="metric"><div class="k">Avg. Total Cost</div><div class="v" id="anAvgCost">‚Äî</div><div class="s" id="anAvgCostSub">Based on trips with cost</div></div>
          </div>

          <div class="analytics-layout">
            <div class="chart-card">
              <div class="chart-title">Trips by Month</div>
              <div class="barlist" id="anByMonthBars"></div>
            </div>

            <div class="chart-card">
              <div class="chart-title">Breakdown</div>
              <div style="display:grid; gap:14px;">
                <div>
                  <div class="chart-title" style="margin:0 0 8px;">By Status</div>
                  <div class="barlist" id="anByStatusBars"></div>
                </div>
                <div>
                  <div class="chart-title" style="margin:0 0 8px;">By Travel Type</div>
                  <div class="barlist" id="anByTypeBars"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="divider" style="margin:16px 0;"></div>

          <div class="chart-card">
            <div class="chart-title">Top Routes</div>
            <table class="analytics-table" aria-label="Top routes table">
              <thead>
                <tr>
                  <th>Route</th>
                  <th>Trips</th>
                  <th>Completed</th>
                  <th>Pending</th>
                </tr>
              </thead>
              <tbody id="anTopRoutesBody"></tbody>
            </table>

            <div id="analyticsEmpty" class="empty-state hidden" style="margin-top:14px;">
              <div class="empty-state-icon">üìà</div>
              <div class="empty-state-title">No analytics yet</div>
              <div class="empty-state-text">Create a trip to generate analytics.</div>
              <button id="analyticsCreateBtn" class="btn btn-primary" type="button">Create Trip</button>
            </div>
          </div>

        </div>
      </div>
    </section>


<section id="wizardSection" class="wizard-section hidden">
      <div style="margin:16px 0 8px;">
        <button class="btn secondary" id="btnBackDashboard" type="button">‚Üê Back to Dashboard</button>
      </div>

      <div class="page-intro">
        <div class="stepper" id="stepper" aria-label="Progress">
          <div class="step" data-step="1" aria-current="true"><span class="num">1</span><span class="txt">Employee Details</span></div>
          <div class="step" data-step="2"><span class="num">2</span><span class="txt">Trip Details</span></div>
          <div class="step" data-step="3"><span class="num">3</span><span class="txt">Review & Submit</span></div>
          <div class="step" data-step="4"><span class="num">4</span><span class="txt">Confirmation</span></div>
        </div>
      </div>

      <div class="help card fade-in" role="note" aria-live="polite">
        <div>üí° Tip: You can fill the flight first ‚Äî hotel & cab will auto-suggest dates and cities from it.</div>
      </div>

      <!-- STEP 1 -->
      <div id="step1" class="card fade-in">
        <h2 class="title">Step 1: Employee Details</h2>
        <p class="hint">We‚Äôll use this to contact you and route approvals. Fields marked with * are required.</p>

        <div class="subcard">
          <div class="title">Contact Information</div>
          <div class="row">
            <div class="col-6">
              <label for="fullName">Full Name (as per passport) *</label>
              <input id="fullName" placeholder="e.g., Jane Smith" autocomplete="name"/>
              <div id="err_fullName" class="field-error hidden"></div>
            </div>
            <div class="col-6">
              <label for="email">Email id *</label>
              <input id="email" type="email" placeholder="name@company.com" autocomplete="email"/>
              <div id="err_email" class="field-error hidden"></div>
            </div>
            <div class="col-3">
              <label for="phoneCode">Phone Code</label>
              <select id="phoneCode" autocomplete="tel-country-code">
                <option value="+91" selected>üáÆüá≥ +91</option>
                <option value="+1">üá∫üá∏ +1</option>
                <option value="+44">üá¨üáß +44</option>
                <option value="+971">üá¶üá™ +971</option>
                <option value="+65">üá∏üá¨ +65</option>
                <option value="+61">üá¶üá∫ +61</option>
                <option value="+27">üáøüá¶ +27</option>
              </select>
            </div>
            <div class="col-3">
              <label for="phone">Phone Number *</label>
              <input id="phone" type="tel" placeholder="e.g., 98765 43210" inputmode="numeric" autocomplete="tel-national" maxlength="13"/>
              <div id="err_phone" class="field-error hidden"></div>
            </div>
            <div class="col-3">
              <label for="travelerType">Traveler Type</label>
              <select id="travelerType">
                <option>Employee</option>
                <option>Contractor</option>
                <option>Guest</option>
              </select>
            </div>
            <div class="col-3">
              <label for="nationalityEmp">Nationality</label>
              <select id="nationalityEmp">
                <option value="IN" selected>Indian</option>
                <option value="US">American</option>
                <option value="GB">British</option>
                <option value="AE">Emirati</option>
                <option value="SG">Singaporean</option>
                <option value="ZA">South African</option>
                <option value="AU">Australian</option>
              </select>
            </div>
          </div>
        </div>

        <div class="subcard" style="margin-top:14px;">
          <div class="title">Organization</div>
          <div class="row">
            <div class="col-4">
              <label for="costCenter">Business Unit Name *</label>
              <select id="costCenter" required>
<option value="">Select Business Unit</option>
<option value="AGRI INPUTS">AGRI INPUTS</option>
<option value="AGRI INPUTS - CURECHEM">AGRI INPUTS - CURECHEM</option>
<option value="AGRI INPUTS - POLYMER">AGRI INPUTS - POLYMER</option>
<option value="AGRI INPUTS - NON EIHL">AGRI INPUTS - NON EIHL</option>
<option value="PULSES">PULSES</option>
<option value="NUTRISCO">NUTRISCO</option>
<option value="EXCHANGE TRADED">EXCHANGE TRADED</option>
<option value="VAMARA">VAMARA</option>
<option value="WAREHOUSING &amp; LOGISTICS">WAREHOUSING &amp; LOGISTICS</option>
<option value="PUREOIL">PUREOIL</option>
<option value="PARROGATE">PARROGATE</option>
<option value="DAVID WHITEHEAD">DAVID WHITEHEAD</option>
<option value="NON TRADING BUSINESS">NON TRADING BUSINESS</option>
<option value="PESA CAPITAL">PESA CAPITAL</option>
<option value="NUFORTH">NUFORTH</option>
<option value="KYOSK">KYOSK</option>
<option value="GROUP FUNCTION">GROUP FUNCTION</option>
</select>
              <div id="err_costCenter" class="field-error hidden"></div>
            </div>
            <div class="col-4">
              <label for="subBusinessUnitName">Sub Business Unit Name *</label>
              <select id="subBusinessUnitName" required>
<option value="">Select Sub Business Unit</option>
<option value="AGRO CHEMICALS">AGRO CHEMICALS</option>
<option value="PACSYS">PACSYS</option>
<option value="FERTILIZER">FERTILIZER</option>
<option value="ONE STOP SHOP">ONE STOP SHOP</option>
<option value="SEEDS">SEEDS</option>
<option value="SPECIALITY FERTILIZER">SPECIALITY FERTILIZER</option>
<option value="INDUSTRIAL CHEMICALS">INDUSTRIAL CHEMICALS</option>
<option value="MINING CHEMICALS">MINING CHEMICALS</option>
<option value="POLYMER POLYOLEFIN">POLYMER POLYOLEFIN</option>
<option value="AGRI INPUTS - NON EIHL (ACF)">AGRI INPUTS - NON EIHL (ACF)</option>
<option value="AGRI INPUTS - NON EIHL (OTHERS)">AGRI INPUTS - NON EIHL (OTHERS)</option>
<option value="PULSES OTHERS">PULSES OTHERS</option>
<option value="PRODUCT BASKET EIGHT">PRODUCT BASKET EIGHT</option>
<option value="PRODUCT BASKET FIVE">PRODUCT BASKET FIVE</option>
<option value="PRODUCT BASKET FOUR">PRODUCT BASKET FOUR</option>
<option value="PRODUCT BASKET NINE">PRODUCT BASKET NINE</option>
<option value="PRODUCT BASKET ONE">PRODUCT BASKET ONE</option>
<option value="PRODUCT BASKET SEVEN">PRODUCT BASKET SEVEN</option>
<option value="PRODUCT BASKET SIX">PRODUCT BASKET SIX</option>
<option value="PRODUCT BASKET TEN">PRODUCT BASKET TEN</option>
<option value="PRODUCT BASKET THREE">PRODUCT BASKET THREE</option>
<option value="PRODUCT BASKET TWO">PRODUCT BASKET TWO</option>
<option value="COCOA">COCOA</option>
<option value="EDIBLE NUTS - ALWAL">EDIBLE NUTS - ALWAL</option>
<option value="EDIBLE NUTS - CKN">EDIBLE NUTS - CKN</option>
<option value="PEANUTS">PEANUTS</option>
<option value="RAW CASHEWNUT">RAW CASHEWNUT</option>
<option value="RICE">RICE</option>
<option value="SESAME SEEDS">SESAME SEEDS</option>
<option value="OTHER NUTRI COMMODITIES">OTHER NUTRI COMMODITIES</option>
<option value="ETCV - AFRICA ENERGY">ETCV - AFRICA ENERGY</option>
<option value="ETCV - AFRICA FARMING">ETCV - AFRICA FARMING</option>
<option value="ETCV - AFRICA GRAINS">ETCV - AFRICA GRAINS</option>
<option value="ETCV - AFRICA OILSEEDS">ETCV - AFRICA OILSEEDS</option>
<option value="ETCV - APAC AUSTRALIA">ETCV - APAC AUSTRALIA</option>
<option value="ETCV - APAC INDIA">ETCV - APAC INDIA</option>
<option value="ETCV - APAC SINGAPORE">ETCV - APAC SINGAPORE</option>
<option value="ETCV - APAC VEGOIL">ETCV - APAC VEGOIL</option>
<option value="ETCV - CORPORATE">ETCV - CORPORATE</option>
<option value="ETCV - FINANCE">ETCV - FINANCE</option>
<option value="ETCV - GROUP">ETCV - GROUP</option>
<option value="ETCV - IBERICAFE">ETCV - IBERICAFE</option>
<option value="ETCV - IFRS">ETCV - IFRS</option>
<option value="ETCV - MECA KAZAKHSTAN">ETCV - MECA KAZAKHSTAN</option>
<option value="ETCV - MECA RUSSIA">ETCV - MECA RUSSIA</option>
<option value="ETCV - MECA UKRAINE">ETCV - MECA UKRAINE</option>
<option value="ETCV - NORTH AMERICA USA">ETCV - NORTH AMERICA USA</option>
<option value="ETCV - RAND AGRI">ETCV - RAND AGRI</option>
<option value="ETCV - SOUTH AFRICA GRAIN">ETCV - SOUTH AFRICA GRAIN</option>
<option value="ETCV - SOUTH AFRICA OILSEEDS">ETCV - SOUTH AFRICA OILSEEDS</option>
<option value="ETCV - SPAIN">ETCV - SPAIN</option>
<option value="ETCV - SUNSHINE SUGAR">ETCV - SUNSHINE SUGAR</option>
<option value="ETCV CAM">ETCV CAM</option>
<option value="PL CAM METALS">PL CAM METALS</option>
<option value="PL CASHBOOK SPECIALITY PRODUCTS">PL CASHBOOK SPECIALITY PRODUCTS</option>
<option value="PL CLIMATE DESK">PL CLIMATE DESK</option>
<option value="PL COFFEE">PL COFFEE</option>
<option value="PL COPPER">PL COPPER</option>
<option value="PL COTTON">PL COTTON</option>
<option value="PL DIRECTIONAL GRAINS">PL DIRECTIONAL GRAINS</option>
<option value="PL FALCON">PL FALCON</option>
<option value="PL FUND">PL FUND</option>
<option value="PL GRAINS">PL GRAINS</option>
<option value="PL MULTI PRODUCT SAF">PL MULTI PRODUCT SAF</option>
<option value="PL OILSEEDS">PL OILSEEDS</option>
<option value="PL PRICING SOLUTIONS">PL PRICING SOLUTIONS</option>
<option value="PL RISK">PL RISK</option>
<option value="PL ROCK">PL ROCK</option>
<option value="PL SPECIALIZED DESKS">PL SPECIALIZED DESKS</option>
<option value="PL STEEL">PL STEEL</option>
<option value="PL SUGAR">PL SUGAR</option>
<option value="PL SUGAR DIRECTIONAL">PL SUGAR DIRECTIONAL</option>
<option value="PL VEGOIL">PL VEGOIL</option>
<option value="ETCV- JVD">ETCV- JVD</option>
<option value="FL360">FL360</option>
<option value="PL BASE &amp; REFINED METALS">PL BASE &amp; REFINED METALS</option>
<option value="PL FREIGHT PHYSICAL">PL FREIGHT PHYSICAL</option>
<option value="PL FREIGHT SPECIALIZED">PL FREIGHT SPECIALIZED</option>
<option value="PL MULTI PRODUCT GLOBAL">PL MULTI PRODUCT GLOBAL</option>
<option value="RESTRUCTURING">RESTRUCTURING</option>
<option value="ETCV - VAMARA">ETCV - VAMARA</option>
<option value="SPECIALISED SEGMENT">SPECIALISED SEGMENT</option>
<option value="VAMARA">VAMARA</option>
<option value="DISTRIBUTION">DISTRIBUTION</option>
<option value="ETGL CORPORATE">ETGL CORPORATE</option>
<option value="FREIGHT FORWARDING">FREIGHT FORWARDING</option>
<option value="ROAD TRANSPORT OR FLEET OPERATIONS">ROAD TRANSPORT OR FLEET OPERATIONS</option>
<option value="WAREHOUSING">WAREHOUSING</option>
<option value="PUREOIL">PUREOIL</option>
<option value="PARROGATE - VAMARA">PARROGATE - VAMARA</option>
<option value="PARROGATE - PARROGATE">PARROGATE - PARROGATE</option>
<option value="DAVID WHITEHEAD">DAVID WHITEHEAD</option>
<option value="INSURANCE &amp; RISK SOLUTIONS">INSURANCE &amp; RISK SOLUTIONS</option>
<option value="PESA CAPITAL">PESA CAPITAL</option>
<option value="NUFORTH">NUFORTH</option>
<option value="KYOSK">KYOSK</option>
<option value="GROUP CEO">GROUP CEO</option>
<option value="GROUP CORPORATE FINANCE">GROUP CORPORATE FINANCE</option>
<option value="GROUP CORPORATE GUARANTEE FEE">GROUP CORPORATE GUARANTEE FEE</option>
<option value="GROUP CPD">GROUP CPD</option>
<option value="GROUP DIRECTOR">GROUP DIRECTOR</option>
<option value="GROUP HQ COST">GROUP HQ COST</option>
<option value="GROUP HR &amp; ADMIN">GROUP HR &amp; ADMIN</option>
<option value="GROUP INTERNAL AUDIT">GROUP INTERNAL AUDIT</option>
<option value="GROUP IT &amp; ERP">GROUP IT &amp; ERP</option>
<option value="GROUP LEGAL &amp; COMPLIANCE">GROUP LEGAL &amp; COMPLIANCE</option>
<option value="GROUP MANAGEMENT TRAINEE">GROUP MANAGEMENT TRAINEE</option>
<option value="GROUP RISK &amp; INSURANCE">GROUP RISK &amp; INSURANCE</option>
<option value="GROUP SHARED SERVICE">GROUP SHARED SERVICE</option>
<option value="GROUP SUSTAINABILITY">GROUP SUSTAINABILITY</option>
<option value="GROUP OTHERS">GROUP OTHERS</option>
<option value="GROUP TREASURY">GROUP TREASURY</option>
</select>
              <div id="err_subBusinessUnitName" class="field-error hidden"></div>
            </div>
            <div class="col-4">
              <label for="costCenterLocation">Cost Center Location *</label>
              <input id="costCenterLocation" placeholder="e.g., Bangalore / Chennai / Dubai"/>
              <div id="err_costCenterLocation" class="field-error hidden"></div>
            </div>

            <div class="col-6">
              <label for="employeeId">Employee ID *</label>
              <input id="employeeId" placeholder="e.g., ETG-10293" />
              <div id="err_employeeId" class="field-error hidden"></div>
            </div>
            <div class="col-6">
              <label for="managerEmail">Manager Email (for approvals) *</label>
              <input id="managerEmail" type="email" placeholder="manager@something.com" autocomplete="email"/>
              <div id="err_managerEmail" class="field-error hidden"></div>
            </div>

          </div>

        <div class="actions">
          <button class="btn ghost" id="btnClear">Reset</button>
          <button class="btn" id="btnNext">Next ‚Üí</button>
        </div>
      </div>
    </div>

      <!-- STEP 2 -->
      <div id="step2" class="card hidden fade-in" aria-hidden="true">
        <h2 class="title">Step 2: Trip Details</h2>

        <div class="subcard">
          <div class="title">Services Required</div>
          <div class="row">
            <div class="col-12" style="display:flex;gap:16px;flex-wrap:wrap">
              <label class="badge"><input type="checkbox" id="svcFlight" checked>‚úàÔ∏è Flight</label>
              <label class="badge"><input type="checkbox" id="svcHotel"> üè® Hotel</label>
              <label class="badge"><input type="checkbox" id="svcCab"> üöñ Cab</label>
            </div>
          </div>
          <div id="err_services" class="field-error hidden" style="margin-top:8px"></div>
        </div>

        <div id="flightBlock" class="subcard" style="margin-top:14px;">
          <div class="title">Flight</div>
          <div class="row">
            <div class="col-6">
              <label>Trip Type</label>
              <div class="segTabs" role="tablist">
                <button type="button" class="segTab" id="ttRound" aria-pressed="true" role="tab">
                  Return
                  <span style="display:block;font-size:11px;color:#64748b">Round-trip</span>
                </button>
                <button type="button" class="segTab" id="ttOne" aria-pressed="false" role="tab">One-way</button>
                <button type="button" class="segTab" id="ttMulti" aria-pressed="false" role="tab">Multi-city</button>
              </div>
              <select id="tripType" class="hidden" aria-hidden="true">
                <option value="round" selected>Round</option>
                <option value="oneway">One-way</option>
                <option value="multi">Multi</option>
              </select>
            </div>
            <div class="col-2">
              <label for="purpose">Purpose</label>
              <select id="purpose">
                <option>Customer Meeting</option>
                <option>Project Delivery</option>
                <option>Training</option>
                <option>Internal</option>
              </select>
            </div>
            <div class="col-2">
              <label for="travelType">Travel Type</label>
              <select id="travelType">
                <option value="Domestic">Domestic</option>
                <option value="International">International</option>
              </select>
            </div>

            <!-- ‚úÖ NEW: Visa Document link next to Travel Type -->
            <div class="col-2">
              <label for="visaDocLink">Visa Document</label>
              <div style="display:flex;gap:10px;align-items:center;">
                <input id="visaDocLink" type="url" value="https://www.traveldoc.aero/" placeholder="Paste website link (optional)" style="flex:1;"/>
                <a id="visaDocOpenBtn" class="btn-secondary btn-sm" href="https://www.traveldoc.aero/" target="_blank" rel="noopener" style="white-space:nowrap;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;">Open</a>
              </div>
              <div id="err_visaDocLink" class="field-error hidden"></div>
            </div>
          </div>

          <div id="routeSimple" style="margin-top:10px;">
            <div class="row route-row">
              <div class="col-5">
                <label for="fromCity">From *</label>
                <input id="fromCity" list="airportList" placeholder="City, Airport or IATA (e.g., BLR)"/>
                <div id="err_fromCity" class="field-error hidden"></div>
              </div>
              <div class="col-2 route-swap-col">
                <button class="swap-btn" id="swapBtn" type="button" title="Swap From and To" aria-label="Swap From and To">‚áÑ</button>
              </div>
              <div class="col-5">
                <label for="toCity">To *</label>
                <input id="toCity" list="airportList" placeholder="City, Airport or IATA (e.g., DEL)"/>
                <div id="err_toCity" class="field-error hidden"></div>
              </div>

              <div class="col-4">
                <label for="seatClassSimple">Seat Class *</label>
                <select id="seatClassSimple">
                  <option>Economy</option>
                  <option>Premium Economy</option>
                  <option>Business</option>
                </select>
              </div>
              <div class="col-4">
                <label for="departDate">Departure Date *</label>
                <input id="departDate" type="date"/>
                <div id="err_departDate" class="field-error hidden"></div>
              </div>
              <div class="col-4" id="returnWrap">
                <label for="returnDate">Return Date *</label>
                <input id="returnDate" type="date"/>
                <div id="err_returnDate" class="field-error hidden"></div>
              </div>
            </div>

          </div>

          <div id="routeMulti" class="hidden" style="margin-top:10px;">
            <div id="segments"></div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
              <button type="button" class="btn secondary" id="btnAddSeg">‚ûï Add Segment</button>
              <button type="button" class="btn ghost" id="btnClearSegs">Clear all</button>
            </div>
            <div id="err_segments" class="field-error hidden" style="margin-top:8px"></div>
          </div>
        
        
        </div>

<div id="hotelBlock" class="subcard hidden" style="margin-top:14px;">
          <div class="title">Hotel</div>
          <div id="hotelSimple">

          <div class="row">
            <div class="col-6">
              <label for="hotelCity">City *</label>
              <input id="hotelCity" type="text" placeholder="e.g., New Delhi" />
            </div>
            <div class="col-3">
              <label for="checkIn">Check-in *</label>
              <input id="checkIn" type="date" />
            </div>
            <div class="col-3">
              <label for="checkOut">Check-out *</label>
              <input id="checkOut" type="date" />
            </div>
          </div>
          <div class="row">
            
            <div class="col-4">
              <label for="hotelNights">Number of Nights</label>
              <input id="hotelNights" type="number" min="1" placeholder="Auto (from dates)" readonly />
              <div class="hint" style="margin-top:6px;">Auto-calculated from Check-in and Check-out.</div>
            </div>
            <div class="col-4">
              <label for="hotelGuests">Guests</label>
              <input id="hotelGuests" type="number" min="1" value="1" />
            </div>
            <div class="col-4">
              <label for="hotelNotes">Notes</label>
              <input id="hotelNotes" type="text" placeholder="Any preferences (optional)" />
            </div>
          </div>
          </div>

          <div id="hotelMulti" class="hidden" style="margin-top:10px;">
            <div id="hotelSegments"></div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
              <button type="button" class="btn secondary" id="btnAddHotelSeg">‚ûï Add Segment</button>
              <button type="button" class="btn ghost" id="btnClearHotelSegs">Clear all</button>
            </div>
            <div id="err_hotelSegments" class="field-error hidden" style="margin-top:8px"></div>
          </div>


        </div>

        <div id="cabBlock" class="subcard hidden" style="margin-top:14px;">
          <div class="title">Cab</div>
          <div id="cabSimple">

          <div class="row">
            <div class="col-3">
              <label for="cabPickup">Pickup *</label>
              <input id="cabPickup" type="text" placeholder="Pickup location" />
            </div>
            <div class="col-3">
              <label for="cabPickupLink">Pickup location link</label>
              <input id="cabPickupLink" type="url" placeholder="https://maps.google.com/..." />
            </div>
            <div class="col-3">
              <label for="cabDrop">Drop *</label>
              <input id="cabDrop" type="text" placeholder="Drop location" />
            </div>
            <div class="col-3">
              <label for="cabDropLink">Drop location link</label>
              <input id="cabDropLink" type="url" placeholder="https://maps.google.com/..." />
            </div>
          </div>
          <div class="row">
            <div class="col-4">
              <label for="cabDate">Date *</label>
              <input id="cabDate" type="date" />
            </div>
            <div class="col-4">
              <label for="cabTime">Time</label>
              <input id="cabTime" type="time" />
            </div>
            <div class="col-4">
              <label for="cabNotes">Notes</label>
              <input id="cabNotes" type="text" placeholder="e.g., airport pickup" />
            </div>
          </div>
        </div>
          </div>

          <div id="cabMulti" class="hidden" style="margin-top:10px;">
            <div id="cabSegments"></div>
            <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px">
              <button type="button" class="btn secondary" id="btnAddCabSeg">‚ûï Add Segment</button>
              <button type="button" class="btn ghost" id="btnClearCabSegs">Clear all</button>
            </div>
            <div id="err_cabSegments" class="field-error hidden" style="margin-top:8px"></div>
          </div>


<div class="actions">
          <button class="btn secondary" id="btnBack1">‚Üê Back</button>
          <button class="btn" id="btnNext2">Next ‚Üí</button>
        </div>
      </div>

      <!-- STEP 3A (International Docs) -->
      <div id="step3docs" class="card hidden fade-in" aria-hidden="true">
        <h2 class="title">Step 3: Passport &amp; Visa</h2>
        <div id="travelDocsBlock" class="subcard hidden" aria-hidden="true" style="margin-top:14px;">
          <div class="title">Passport &amp; Visa Details</div>

          <div class="row" style="align-items:flex-end;">
            <div class="col-6">
              <label>Attach Passport</label>
              <input id="passportFile" type="file" accept=".pdf,.png,.jpg,.jpeg" />
              <div class="hint" style="margin-top:6px;">Upload a scan/photo (PDF/JPG/PNG).</div>
            </div>
            <div class="col-6">
              <label for="visaDocLink2">Visa Document (link) *</label>
              <div style="display:flex;gap:10px;align-items:center;">
                <input id="visaDocLink2" type="url" value="https://www.traveldoc.aero/" placeholder="Paste visa document link" style="flex:1;" />
                <a id="visaDocOpenBtn2" class="btn-secondary btn-sm" href="https://www.traveldoc.aero/" target="_blank" rel="noopener" style="white-space:nowrap;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;">Open</a>
              </div>
              <div id="err_visaDocLink2" class="field-error hidden"></div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <label for="passportNumber">Passport Number *</label>
              <input id="passportNumber" placeholder="e.g., A1234567" />
              <div id="err_passportNumber" class="field-error hidden"></div>
            </div>
            <div class="col-6">
              <label for="passportExpiry">Passport Expiry Date *</label>
              <input id="passportExpiry" type="date" />
              <div id="err_passportExpiry" class="field-error hidden"></div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <label for="passportNationality">Nationality *</label>
              <select id="passportNationality">
                <option value="">Select</option>
                <option>Indian</option>
                <option>United States</option>
                <option>United Kingdom</option>
                <option>UAE</option>
                <option>Singapore</option>
                <option>Other</option>
              </select>
              <div id="err_passportNationality" class="field-error hidden"></div>
            </div>
            <div class="col-6">
              <label for="issuingCountry">Issuing Country *</label>
              <select id="issuingCountry">
                <option value="">Select</option>
                <option>India</option>
                <option>United States</option>
                <option>United Kingdom</option>
                <option>UAE</option>
                <option>Singapore</option>
                <option>Other</option>
              </select>
              <div id="err_issuingCountry" class="field-error hidden"></div>
            </div>
          </div>

          <div class="row">
            <div class="col-6">
              <label for="visaStatus">Visa Type *</label>
              <select id="visaStatus" required>
                <option value="">Select</option>
                <option value="VisaOnArrival">Visa On Arrival</option>
                <option value="VisaFree">Visa Free Country</option>
                <option value="NoVisa">Do Not Have Visa</option>
                <option value="ValidVisa">Have A Valid Visa</option>
              </select>
              <div id="err_visaStatus" class="field-error hidden"></div>
            </div>
            <div class="col-6">
              <label for="visaNumber">Visa Number *</label>
              <select id="visaNumber">
                <option value="">Select Visa Number</option>
                <option>VISA-001234</option>
                <option>VISA-009876</option>
                <option>N/A</option>
              </select>
              <div id="err_visaNumber" class="field-error hidden"></div>
              <div class="hint">Choose N/A only if you don‚Äôt have a visa number.</div>
            </div>
          </div>

          <div class="hint">Note: These fields appear only for International trips.</div>
        </div>
        <div class="actions">
          <button class="btn secondary" id="btnBackDocs">‚Üê Back</button>
          <button class="btn" id="btnNextDocs">Next ‚Üí</button>
        </div>
      </div>

<!-- STEP 3 -->
      <div id="step3" class="card hidden fade-in" aria-hidden="true">
        <h2 class="title">Step 4: Review & Submit</h2>

        <!-- ‚úÖ International Travel Documents (shown only when Travel Type = International) -->
        

        <div id="reviewBox"></div>

        <div class="actions">
          <button class="btn secondary" id="btnBack2">‚Üê Back</button>
          <button class="btn" id="btnSubmit">Submit Request</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div id="step4" class="card hidden fade-in" aria-hidden="true">
        <h2 class="title">Request Submitted</h2>
        <p>Your request <b id="reqId">TR-XXXXXX</b> has been submitted.</p>
        <p class="hint">You‚Äôll also get an email confirmation shortly.</p>
        <p class="hint">If your email client doesn‚Äôt open automatically, <a href="#" id="mailtoLink" target="_blank" rel="noopener">open the email draft</a>.</p>
        <div class="actions">
          <button class="btn secondary" id="btnStartOver">Create another</button>
          <button class="btn" id="btnGoDesk">Go to Travel Desk Dashboard ‚Üí</button>
        </div>
      </div>
    </section>
  </main>

  <!-- AIRPORT list for flight fields -->
  <datalist id="airportList">
    <!-- Populated automatically with global airports (City ‚Äî Airport Name (IATA)) -->
  </datalist>



    
  <!-- Profile Modal -->
  <div id="profileModal" class="profile-modal" aria-hidden="true">
    <div class="profile-backdrop" id="profileBackdrop" aria-hidden="true"></div>

    <div class="profile-panel fade-in" role="dialog" aria-modal="true" aria-labelledby="profileTitle">
      <button class="profile-close" id="closeProfileBtn" type="button" aria-label="Close">‚úï</button>

      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">--</div>
        <div>
          <div class="profile-mainname" id="profileTitle">My Profile</div>
          <div class="profile-header-sub" id="profileSub">‚Äî</div>
        </div>
      </div>

      <div class="profile-grid" id="profileFields">
        <!-- Filled by JS -->
      </div>

      <div class="divider"></div>
      <div class="hint">Tip: Your profile data is stored locally in this browser (demo mode).</div>
    </div>
  </div>
  
  <!-- Roles & Approvers Modal -->
  <div id="rolesApproversModal" class="profile-modal" aria-hidden="true">
    <div class="profile-backdrop" id="rolesApproversBackdrop" aria-hidden="true"></div>

    <div class="profile-panel fade-in" role="dialog" aria-modal="true" aria-labelledby="rolesApproversTitle">
      <button class="profile-close" id="closeRolesApproversBtn" type="button" aria-label="Close">‚úï</button>

      <div class="profile-header">
        <div class="profile-avatar" id="rolesApproversAvatar">--</div>
        <div>
          <div class="profile-mainname" id="rolesApproversTitle">Roles &amp; Approvers</div>
          <div class="profile-header-sub" id="rolesApproversSub">Set default approver emails for requests</div>
        </div>
      </div>

            <div class="profile-grid" id="rolesApproversFields">
        <div class="profile-field">
          <div class="profile-label">Reporting manager</div>
          <input id="ra-reportingManagerEmail" type="email" placeholder="name@etgworld.com" />
        </div>

        <div class="profile-field">
          <div class="profile-label">Travel desk</div>
          <input id="ra-travelDeskEmail" type="email" placeholder="traveldesk@etgworld.com" />
        </div>

        <div class="profile-field">
          <div class="profile-label">Finance</div>
          <input id="ra-financeEmail" type="email" placeholder="finance@etgworld.com" />
        </div>

        <div class="profile-field">
          <div class="profile-label">Exceptional approver</div>
          <input id="ra-exceptionalApproverEmail" type="email" placeholder="exception@etgworld.com" />
        </div>

        <div class="profile-field">
          <div class="profile-label">App super admin</div>
          <input id="ra-appSuperAdminEmail" type="email" placeholder="admin@etgworld.com" />
        </div>
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px;">
        <button class="btn secondary" id="raCancelBtn" type="button">Cancel</button>
        <button class="btn" id="raSaveBtn" type="button">Save</button>
      </div>

      <div class="divider"></div>
      <div class="hint">Tip: These approver emails will be used to auto-fill the workflow and approvals (demo mode).</div>
    </div>
  </div>


  <!-- Policy Document Modal -->
  <div id="policyModal" class="policy-modal" aria-hidden="true">
    <div class="policy-backdrop" id="policyBackdrop" aria-hidden="true"></div>

    <div class="policy-panel fade-in" role="dialog" aria-modal="true" aria-labelledby="policyTitleEl">
      <button class="policy-close" id="closePolicyBtn" type="button" aria-label="Close">‚úï</button>

      <div class="policy-top">
        <div>
          <h3 class="policy-title" id="policyTitleEl">Travel Policy Document</h3>
          <div class="policy-meta" id="policyMetaEl">‚Äî</div>
        </div>

        <div class="policy-actions">
          <a class="btn-secondary btn-sm" id="policyOpenLink" href="#" target="_blank" rel="noopener" style="display:none;text-decoration:none;">Open</a>
          <a class="btn-secondary btn-sm" id="policyDownloadLink" href="#" download style="display:none;text-decoration:none;">Download</a>
        </div>
      </div>

      <div id="policyAdminBlock" class="policy-uploader hidden" aria-hidden="true">
        <div class="title" style="margin:0;">Admin Upload</div>
        <div class="hint" style="margin:0;">Upload the latest travel policy (PDF recommended). This will be saved locally in the browser (demo mode).</div>

        <div class="row" style="align-items:end;">
          <div class="col-8">
            <label for="policyFile">Choose file</label>
            <input id="policyFile" type="file" accept=".pdf,.doc,.docx,.png,.jpg,.jpeg" />
            <div class="hint" style="margin-top:6px;">Max 8 MB. Accepted: PDF/DOC/DOCX/PNG/JPG.</div>
            <div id="policyErr" class="field-error hidden"></div>
          </div>
          <div class="col-4" style="display:flex;gap:10px;justify-content:flex-end;">
            <button class="btn secondary" id="policyClearBtn" type="button">Clear</button>
            <button class="btn" id="policySaveBtn" type="button">Save Policy</button>
          </div>
        </div>
      </div>

      <div class="policy-preview" id="policyPreviewWrap">
        <div id="policyEmpty" class="policy-empty">Travel policy is available below (view-only).</div>
        <iframe id="policyFrame" title="Policy Document Preview" style="display:none;"></iframe>
      </div>

      <div class="divider"></div>
      <div class="hint">Tip: Employees can open this from the profile menu to understand travel limits and rules.</div>
    </div>
  </div>





  






  <script>

(function(){
  const heroSection = document.getElementById('heroSection');
  const wizardSection = document.getElementById('wizardSection');
  const myTripsSection = document.getElementById('myTripsSection');

  
  const approvalsSection = document.getElementById('approvalsSection');
  const reportSection = document.getElementById('reportSection');
  const analyticsSection = document.getElementById('analyticsSection');
const navHome = document.getElementById('navHome');
  const navTrips = document.getElementById('navTrips');
    const navApprovals = document.getElementById('navApprovals');
  const navReport = document.getElementById('navReport');
  const navAnalytics = document.getElementById('navAnalytics');
const navCreate = document.getElementById('navCreate');

  const createTripBtn = document.getElementById('createTripBtn');
    const myTripsBtn = document.getElementById('myTripsBtn');
const myTripsCreateBtn = document.getElementById('myTripsCreateBtn');

  const profileMenuBtn = document.getElementById('userAvatar');
  const profileDropdown = document.getElementById('userDropdown');
  const openProfileBtn = document.getElementById('openProfile');
  const openPolicyBtn = document.getElementById('openPolicy');
  const policyModal = document.getElementById('policyModal');
  const closePolicyBtn = document.getElementById('closePolicyBtn');
  const policyBackdrop = document.getElementById('policyBackdrop');
  const policyAdminBlock = document.getElementById('policyAdminBlock');
  const policyFile = document.getElementById('policyFile');
  const policySaveBtn = document.getElementById('policySaveBtn');
  const policyClearBtn = document.getElementById('policyClearBtn');
  const policyErr = document.getElementById('policyErr');
  const policyMetaEl = document.getElementById('policyMetaEl');
  const policyFrame = document.getElementById('policyFrame');
  const policyEmpty = document.getElementById('policyEmpty');
  const policyOpenLink = document.getElementById('policyOpenLink');
  const policyDownloadLink = document.getElementById('policyDownloadLink');

  const POLICY_KEY = 'etg-travel-policy';


  
  // Default bundled policy (served as view-only for users)
  const DEFAULT_POLICY = {
    name: 'Travel & Business Expense Policy 2025',
    type: 'application/pdf',
    size: 0,
    dataUrl: 'travel-policy-2025.pdf',
    uploadedAt: '2025-03-11T00:00:00.000Z',
    uploadedBy: 'HR'
  };

const profileModal = document.getElementById('profileModal');
  const closeProfileBtn = document.getElementById('closeProfileBtn');
  const profileBackdrop = document.getElementById('profileBackdrop');
  const profileAvatarEl = document.getElementById('profileAvatar');
  const profileSub = document.getElementById('profileSub');
  const profileFields = document.getElementById('profileFields');

  const tripsSearch = document.getElementById('tripsSearch');
  const tripsSort = document.getElementById('tripsSort');
  const allTripsList = document.getElementById('allTripsList');
  const pendingTripsList = document.getElementById('pendingTripsList');
  const tabAllTrips = document.getElementById('tabAllTrips');
  const tabPendingTrips = document.getElementById('tabPendingTrips');
  const myTripsEmpty = document.getElementById('myTripsEmpty');

  // Shared keys across all stages
  const TRIPS_KEY = 'etg-user-trips';
  var GLOBAL_TRIPS_KEY = window.GLOBAL_TRIPS_KEY || 'etg-trips-global'; window.GLOBAL_TRIPS_KEY = GLOBAL_TRIPS_KEY; // ‚úÖ global trips by Trip ID for cross-role access       // ‚úÖ used by Stage 3/4/5/6/7/8
  const USERS_KEY = 'etg-users';       // ‚úÖ created/maintained in Stage 1
  const LOGIN_KEY = 'etg-login';       // ‚úÖ created in Stage 1

  const roleDisplay = {
    EMPLOYEE: 'Employee',
    MANAGER: 'Manager',
    TRAVEL_DESK: 'Travel Desk'
  };

  function getLoginContext(){
    try{
      const local = localStorage.getItem(LOGIN_KEY);
      const sess  = sessionStorage.getItem(LOGIN_KEY);
      return local ? JSON.parse(local) : (sess ? JSON.parse(sess) : null);
    }catch(e){
      return null;
    }
  }

  function saveLoginContext(ctx){
    if(!ctx || !ctx.email) return;
    try{
      const remember = !!ctx.remember;
      const payload = Object.assign({}, ctx, { loggedAt: ctx.loggedAt || new Date().toISOString() });
      if(remember){
        localStorage.setItem(LOGIN_KEY, JSON.stringify(payload));
        sessionStorage.removeItem(LOGIN_KEY);
      }else{
        sessionStorage.setItem(LOGIN_KEY, JSON.stringify(payload));
        localStorage.removeItem(LOGIN_KEY);
      }
    }catch(e){}
  }

  function requireLogin(){
    const ctx = getLoginContext();
    if(!ctx || !ctx.email){
      window.location.href = 'Stage 1 (User log in Template).html';
      return null;
    }
    return ctx;
  }

  function loadUserStore(){
    try{ return JSON.parse(localStorage.getItem(USERS_KEY) || '{}'); }catch(e){ return {}; }
  }
  function saveUserStore(store){
    try{ localStorage.setItem(USERS_KEY, JSON.stringify(store || {})); }catch(e){}
  }
  function normalizeEmail(email){
    return String(email || '').trim().toLowerCase();
  }
  function upsertUser(email, patch){
    const key = normalizeEmail(email);
    if(!key) return;
    const store = loadUserStore();
    const existing = store[key] || {};
    store[key] = Object.assign({}, existing, patch, { updatedAt: new Date().toISOString() });
    if(!store[key].createdAt) store[key].createdAt = existing.createdAt || new Date().toISOString();
    saveUserStore(store);
  }
  function getUserByEmail(email){
    const key = normalizeEmail(email);
    if(!key) return null;
    const store = loadUserStore();
    return store[key] || null;
  }

  // ‚úÖ Ensure password/name/role captured into the persistent user store on every visit.
  // This prevents "No password is set for this user" after signing out and logging in again.
  (function bootstrapPersistLoginToUserStore(){
    try{
      const ctx = getLoginContext();
      if(!ctx || !ctx.email) return;
      const pwd = ctx.password || ctx.pass || ctx.pwd;
      const patch = {};
      if(ctx.role) patch.role = ctx.role;
      if(ctx.name){
        // Best-effort split; keeps any existing stored values if split is ambiguous
        const parts = String(ctx.name).trim().split(/\s+/).filter(Boolean);
        if(parts.length >= 1) patch.firstName = parts[0];
        if(parts.length >= 2) patch.lastName = parts.slice(1).join(' ');
      }
      if(pwd) patch.password = String(pwd);
      if(Object.keys(patch).length) upsertUser(ctx.email, patch);
    }catch(e){}
  })();


  function fallbackNameFromEmail(email){
    const base = String(email || '').split('@')[0] || 'User';
    return base.split(/[._-]+/g).filter(Boolean).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  function computeInitials(nameOrEmail){
    const str = String(nameOrEmail || '').trim();
    if(!str) return 'U';
    const parts = str.split(/\s+/).filter(Boolean);
    const initials = parts.map(p=>p.charAt(0).toUpperCase()).join('');
    return (initials || 'U').slice(0,2);
  }

  function hydrateUserUi(){
    const ctx = requireLogin();
    if(!ctx) return;

    const user = getUserByEmail(ctx.email) || {};
    const fullName = (user.fullName || user.name || user.displayName || user.profileName) ? String(user.fullName || user.name || user.displayName || user.profileName).trim() : ((user.firstName || user.lastName)
      ? [user.firstName || '', user.lastName || ''].join(' ').trim()
      : (ctx.name || fallbackNameFromEmail(ctx.email)));


    const roleLabel = roleDisplay[ctx.role] || ctx.role || 'User';
    const initials = computeInitials(fullName);

    const avatarBtn = document.getElementById('userAvatar');
    const initialsLarge = document.getElementById('userInitialsLarge');
    const nameText = document.getElementById('userNameText');
    const roleText = document.getElementById('userRoleText');
    const welcomeName = document.getElementById('welcomeName');

    if(avatarBtn) avatarBtn.textContent = initials;
    if(initialsLarge) initialsLarge.textContent = initials;
    if(nameText) nameText.textContent = fullName;
    if(roleText) roleText.textContent = roleLabel;
    if(welcomeName) welcomeName.textContent = fullName;

    
    // Render Profile (card style)
    if(profileAvatarEl) profileAvatarEl.textContent = initials;
    if(profileSub) profileSub.textContent = ctx.email || '‚Äî';

    const safe = (v)=> (v===undefined || v===null || v==='') ? '‚Äî' : v;
    const u = Object.assign({}, user);

    const dob = safe(u.dob || u.dateOfBirth);
    const gender = safe(u.gender);
    const mobile = safe(u.mobile || (u.phoneCode && u.phone ? (u.phoneCode + ' ' + u.phone) : u.phone));
    const dept = safe(u.department || u.dept);
    const empId = safe(u.employeeId || u.empId);
    const passMask = (u.password && String(u.password).length) ? '‚Ä¢'.repeat(10) : '‚Äî';

    const rows = [
      { key:'name', label:'Name', value: fullName, editable:true, field:'fullName', type:'prompt' },

      // ‚úÖ Requested changes:
      // - Date of Birth: calendar picker
      // - Gender: dropdown
      // - Employee ID: mandatory
      { key:'dob', label:'Date of Birth', value: dob, editable:true, field:'dob', type:'date' },
      { key:'gender', label:'Gender', value: gender, editable:true, field:'gender', type:'select', options:['Male','Female','Other','Prefer not to say'] },
      { key:'email', label:'Email', value: ctx.email || '‚Äî', editable:false, field:'email', type:'readonly' },

      { key:'mobile', label:'Mobile Number', value: mobile, editable:true, field:'mobile', type:'prompt' },
      { key:'password', label:'Password', value: passMask, editable:true, field:'password', type:'prompt' },
      { key:'dept', label:'Department', value: dept, editable:true, field:'department', type:'prompt' },
      { key:'empid', label:'Employee ID *', value: empId, editable:true, field:'employeeId', type:'text', required:true, placeholder:'e.g., ETG-10293' },
    ];

    const toDateValue = (v)=>{
      const s = String(v ?? '').trim();
      if(!s || s === '‚Äî') return '';
      // accept yyyy-mm-dd directly
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
      // try parse other date strings
      const d = new Date(s);
      if(isNaN(d)) return '';
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    };

    if(profileFields){
      profileFields.innerHTML = rows.map(r => {
        const vSafe = safe(r.value);

        // Control rendering for specific fields
        if(r.type === 'date'){
          return `
            <div class="profile-field">
              <div class="profile-label">${r.label}</div>
              <input class="profile-input" id="pf_in_${r.key}" type="date" value="${escapeHtml(toDateValue(vSafe))}" />
              <div id="pf_err_${r.key}" class="field-error hidden"></div>
            </div>
          `;
        }

        if(r.type === 'select'){
          const current = String(vSafe ?? '').trim();
          const opts = (r.options || []).map(o=>{
            const sel = (o.toLowerCase() === current.toLowerCase()) ? 'selected' : '';
            return `<option ${sel}>${escapeHtml(o)}</option>`;
          }).join('');
          return `
            <div class="profile-field">
              <div class="profile-label">${r.label}</div>
              <select class="profile-input" id="pf_in_${r.key}">
                <option value="" ${current==='‚Äî' || !current ? 'selected' : ''}>Select</option>
                ${opts}
              </select>
              <div id="pf_err_${r.key}" class="field-error hidden"></div>
            </div>
          `;
        }

        if(r.type === 'text'){
          const val = (vSafe === '‚Äî') ? '' : String(vSafe);
          return `
            <div class="profile-field">
              <div class="profile-label">${r.label}</div>
              <input class="profile-input" id="pf_in_${r.key}" type="text" value="${escapeHtml(val)}" placeholder="${escapeHtml(r.placeholder || '')}" ${r.required ? 'required' : ''}/>
              <div id="pf_err_${r.key}" class="field-error hidden"></div>
            </div>
          `;
        }

        // Default: read value with optional edit button (prompt)
        return `
          <div class="profile-field">
            <div class="profile-label">${r.label}</div>
            <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
              <div class="profile-value" id="pf_${r.key}">${escapeHtml(vSafe)}</div>
              <button class="profile-edit" type="button" data-edit="${r.key}" ${r.editable && r.type==='prompt' ? '' : 'disabled'} title="${r.editable ? 'Edit' : 'Not editable'}">‚úé</button>
            </div>
          </div>
        `;
      }).join('');

      // Inline-save controls
      const emailKey = normalizeEmail(ctx.email);

      const dobEl = document.getElementById('pf_in_dob');
      if(dobEl){
        dobEl.addEventListener('change', ()=>{
          const val = String(dobEl.value || '').trim();
          upsertUser(emailKey, { dob: val });
          hydrateUserUi();
        });
      }

      const genderEl = document.getElementById('pf_in_gender');
      if(genderEl){
        genderEl.addEventListener('change', ()=>{
          const val = String(genderEl.value || '').trim();
          upsertUser(emailKey, { gender: val });
          hydrateUserUi();
        });
      }

      const empEl = document.getElementById('pf_in_empid');
      if(empEl){
        const validateEmp = ()=>{
          const v = String(empEl.value || '').trim();
          const err = document.getElementById('pf_err_empid');
          if(!v){
            empEl.classList.add('is-invalid');
            if(err){ err.textContent = 'Employee ID is required'; err.classList.remove('hidden'); }
            return false;
          }
          empEl.classList.remove('is-invalid');
          if(err){ err.textContent=''; err.classList.add('hidden'); }
          return true;
        };
        empEl.addEventListener('blur', validateEmp);
        empEl.addEventListener('change', ()=>{
          if(!validateEmp()) return;
          upsertUser(emailKey, { employeeId: String(empEl.value || '').trim() });
          hydrateUserUi();
        });
      }

      // Prompt-based edits (Name/Mobile/Password/Department)
      profileFields.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const k = btn.getAttribute('data-edit');
          if(!k) return;
          const row = rows.find(x=>x.key===k);
          if(!row || !row.editable || row.type!=='prompt') return;

          let current = (u[row.field] ?? '');
          if(row.field === 'fullName'){
            current = fullName || '';
          }
          const label = row.label;
          const next = prompt(`Edit ${label}:`, String(current ?? ''));
          if(next === null) return; // cancelled

          const trimmed = String(next).trim();

          if(row.field === 'fullName'){
            const parts = trimmed.split(/\s+/).filter(Boolean);
            const firstName = parts.shift() || '';
            const lastName = parts.join(' ');
            upsertUser(emailKey, { firstName, lastName, fullName: trimmed });
            ctx.name = trimmed || ctx.name;
            saveLoginContext(ctx);
          }else if(row.field === 'password'){
            upsertUser(emailKey, { password: trimmed });
          }else if(row.field === 'mobile'){
            upsertUser(emailKey, { mobile: trimmed });
          }else{
            const patch = {}; patch[row.field] = trimmed;
            upsertUser(emailKey, patch);
          }

          hydrateUserUi();
        });
      });
    }
try{
      // Contact Information (Create Trip)
      const fullNameEl = document.getElementById('fullName');
      const emailEl = document.getElementById('email');
      const phoneCodeEl = document.getElementById('phoneCode');
      const phoneEl = document.getElementById('phone');
      const travelerTypeEl = document.getElementById('travelerType');
      const nationalityEl = document.getElementById('nationalityEmp');

      if(fullNameEl && fullName) fullNameEl.value = fullName;
      if(emailEl && ctx.email) emailEl.value = ctx.email;

      const pc = user.phoneCode || user.countryCode || ctx.phoneCode;
      const ph = user.phone || user.phoneNumber || user.mobile || ctx.phone;

      if(phoneCodeEl && pc) phoneCodeEl.value = String(pc);
      if(phoneEl && ph) phoneEl.value = String(ph);

      const tt = user.travelerType || ctx.travelerType;
      if(travelerTypeEl && tt) travelerTypeEl.value = String(tt);

      const nat = user.nationality || user.country || ctx.nationality;
      if(nationalityEl && nat) nationalityEl.value = String(nat);

      // Organization
      const costCenterEl = document.getElementById('costCenter');
      const subBusinessUnitNameEl = document.getElementById('subBusinessUnitName');
      const costCenterLocationEl = document.getElementById('costCenterLocation');
      const employeeIdEl = document.getElementById('employeeId');
      const managerEmailEl = document.getElementById('managerEmail');

      const cc = user.businessUnitName || user.costCenter || user.department || user.dept || ctx.businessUnitName || ctx.costCenter;
      const emp = user.employeeId || user.empId || ctx.employeeId;
      const mgr = user.managerEmail || user.approverEmail || ctx.managerEmail;

      if(costCenterEl && cc) costCenterEl.value = String(cc);
      const subBu = user.subBusinessUnitName || user.subBusinessUnit || user.subDepartment || ctx.subBusinessUnitName;
      if(subBusinessUnitNameEl && subBu) subBusinessUnitNameEl.value = String(subBu);
      const ccLoc = user.costCenterLocation || user.ccLocation || user.location || ctx.costCenterLocation;
      if(costCenterLocationEl && ccLoc) costCenterLocationEl.value = String(ccLoc);
      if(employeeIdEl && emp) employeeIdEl.value = String(emp);
      if(managerEmailEl && mgr) managerEmailEl.value = String(mgr);
    }catch(e){}

    if(!ctx.name || ctx.name !== fullName){
      ctx.name = fullName;
      saveLoginContext(ctx);
    }
  }



  function showOnly(section){
    [heroSection, wizardSection, myTripsSection, approvalsSection, reportSection, analyticsSection].forEach(s => s && s.classList.add('hidden'));
    if(section) section.classList.remove('hidden');
    window.scrollTo({top:0, behavior:'smooth'});

    // Keep section data in sync no matter how the user navigates
    try{
      if(section === myTripsSection && typeof renderTrips === 'function') renderTrips();
      if(section === reportSection && typeof renderReport === 'function') renderReportSafe();
      if(section === analyticsSection && typeof renderAnalyticsSafe === 'function') renderAnalyticsSafe();
    }catch(e){}
  }

  
  function setActiveNav(activeId){
    try{
      document.querySelectorAll('.main-nav .nav-link').forEach(a=>{
        a.classList.remove('active');
        a.removeAttribute('aria-current');
      });
      const el = document.getElementById(activeId);
      if(el){
        el.classList.add('active');
        el.setAttribute('aria-current','page');
      }
    }catch(e){}
  }

  // Primary navigation
  navHome?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(heroSection); setActiveNav('navHome'); });
  navTrips?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(myTripsSection); setActiveNav('navTrips'); renderTrips(); });
  navApprovals?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(approvalsSection); setActiveNav('navApprovals'); });
  navReport?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(reportSection); setActiveNav('navReport'); renderReportSafe(); });
  navAnalytics?.addEventListener('click', (e)=>{ e.preventDefault(); showOnly(analyticsSection); setActiveNav('navAnalytics'); renderAnalyticsSafe(); });

  // Hero quick actions
  myTripsBtn?.addEventListener('click', ()=>{ showOnly(myTripsSection); setActiveNav('navTrips'); renderTrips(); });


    const myTripsBackBtn = document.getElementById('myTripsBackBtn');
  myTripsBackBtn?.addEventListener('click', ()=>{ showOnly(heroSection); setActiveNav('navHome'); });


// ‚úÖ Global trip store (single source of truth across roles)
// Storage schema in localStorage[GLOBAL_TRIPS_KEY]:
// {
//   byId: { "<TRIP_ID>": { ...trip } },
//   pending:   [ { ...trip }, ... ],
//   completed: [ { ...trip }, ... ]
// }
// This keeps compatibility with pages that read pending/completed buckets,
// while giving user pages a reliable byId index for status syncing.

function _readGlobalStore(){
  let raw = {};
  try{ raw = JSON.parse(localStorage.getItem(GLOBAL_TRIPS_KEY) || '{}'); }catch(e){ raw = {}; }
  if(!raw || typeof raw !== 'object' || Array.isArray(raw)) raw = {};

  // If current global key is empty but legacy key has data, migrate once (keeps dashboards in sync)
  try{
    const legacyKey = 'etg-trips-global';
    if(Object.keys(raw).length === 0){
      const legacy = JSON.parse(localStorage.getItem(legacyKey) || '{}');
      if(legacy && typeof legacy === 'object' && !Array.isArray(legacy) && Object.keys(legacy).length){
        raw = legacy;
        try{ localStorage.setItem(GLOBAL_TRIPS_KEY, JSON.stringify(raw)); }catch(e){}
      }
    }
  }catch(e){}


  const byId = {};
  const pending = Array.isArray(raw.pending) ? raw.pending.slice() : [];
  const completed = Array.isArray(raw.completed) ? raw.completed.slice() : [];

  // 1) harvest from buckets
  pending.concat(completed).forEach(t=>{
    if(t && t.id) byId[String(t.id)] = t;
  });

  // 2) merge from raw.byId (if present)
  if(raw.byId && typeof raw.byId === 'object' && !Array.isArray(raw.byId)){
    Object.keys(raw.byId).forEach(k=>{
      const t = raw.byId[k];
      if(t && (t.id || k)) byId[String(t.id || k)] = t;
    });
  }

  // 3) backward-compat: if raw is a plain byId map (trip ids as keys)
  Object.keys(raw).forEach(k=>{
    if(k === 'pending' || k === 'completed' || k === 'byId') return;
    const v = raw[k];
    if(v && typeof v === 'object' && !Array.isArray(v)){
      const id = String(v.id || k);
      byId[id] = Object.assign({}, byId[id] || {}, v, { id });
    }
  });

  // Rebuild buckets from byId (status-driven) to avoid drift
  const p = [];
  const c = [];
  Object.keys(byId).forEach(id=>{
    const t = byId[id];
    const st = String((t && t.status) || '').toLowerCase();
    const isDone = st.includes('completed') || st.includes('booked') || st.includes('ticketed');
    (isDone ? c : p).push(t);
  });

  // Sort newest first
  const score = (t)=>{
    const d = t?.updatedAt || t?.createdAt || '';
    const ms = Date.parse(d);
    return isNaN(ms) ? 0 : ms;
  };
  p.sort((a,b)=>score(b)-score(a));
  c.sort((a,b)=>score(b)-score(a));

  return { byId, pending: p, completed: c };
}

function _writeGlobalStore(store){
  const safe = store && typeof store === 'object' ? store : { byId:{}, pending:[], completed:[] };
  try{
    localStorage.setItem(GLOBAL_TRIPS_KEY, JSON.stringify({
      byId: safe.byId || {},
      pending: Array.isArray(safe.pending) ? safe.pending : [],
      completed: Array.isArray(safe.completed) ? safe.completed : []
    }));
  }catch(e){}
}

// Used by user pages: returns byId map
function loadGlobalTrips(){
  return _readGlobalStore().byId || {};
}

// Used when a page wants full buckets too
function loadGlobalTripStore(){
  return _readGlobalStore();
}

function upsertGlobalTrip(trip){
  if(!trip || !trip.id) return;

  const id = String(trip.id);
  const store = _readGlobalStore();
  const existing = store.byId[id] || {};

  const merged = Object.assign({}, existing, trip, {
    id,
    updatedAt: new Date().toISOString(),
    createdAt: existing.createdAt || trip.createdAt || new Date().toISOString()
  });

  store.byId[id] = merged;
  _writeGlobalStore(store);
}

// Find a trip by id across global + per-user buckets (global wins)
function findTripById(rid){
  if(!rid) return null;
  const key = String(rid);
  const g = loadGlobalTrips();
  if(g && g[key]) return g[key];

  const list = loadTrips();
  const found = Array.isArray(list) ? list.find(t => String(t.id) === key) : null;
  return found || null;
}
window.findTripById = findTripById;



  function loadTrips(){
    // Runtime cache fallback (helps when running via file:// where localStorage can be restricted)
    if(window.__TRIPS_RUNTIME && Array.isArray(window.__TRIPS_RUNTIME)){
      return window.__TRIPS_RUNTIME;
    }
    const ctx = requireLogin();
    const emailKey = normalizeEmail(ctx?.email || 'default');

    // 1) user-bucket store (legacy)
    let store = {};
    try{ store = JSON.parse(localStorage.getItem(TRIPS_KEY) || '{}'); }catch(e){ store = {}; }

    // Backward-compat: if someone has an array in storage, migrate it under this user
    if(Array.isArray(store)){
      const migrated = {};
      migrated[emailKey] = store;
      store = migrated;
      try{ localStorage.setItem(TRIPS_KEY, JSON.stringify(store)); }catch(e){}
    }

    const legacyList = Array.isArray(store[emailKey]) ? store[emailKey] : [];

    // 2) global store (realtime visibility across roles)
    const g = loadGlobalTrips();
    const globalList = Object.keys(g).map(k => g[k]).filter(Boolean).filter(t=>{
      const reqEmail = normalizeEmail(t.requesterEmail || t.requester?.email || '');
      // if requester email not present, still include if trip id exists in legacy list
      if(reqEmail) return reqEmail === emailKey;
      return legacyList.some(x => x && String(x.id) === String(t.id));
    });

    // 3) merge by Trip ID (global wins)
    const map = new Map();
    legacyList.forEach(t=>{ if(t && t.id) map.set(String(t.id), t); });
    globalList.forEach(t=>{ if(t && t.id) map.set(String(t.id), t); });

    return Array.from(map.values());
  }


  
  function saveTrips(list){
    const ctx = requireLogin();
    const emailKey = normalizeEmail(ctx?.email || 'default');

    let store = {};
    try{ store = JSON.parse(localStorage.getItem(TRIPS_KEY) || '{}'); }catch(e){ store = {}; }
    if(Array.isArray(store)){
      const migrated = {};
      migrated[emailKey] = store;
      store = migrated;
    }
    store[emailKey] = Array.isArray(list) ? list : [];
    // keep runtime cache in sync
    window.__TRIPS_RUNTIME = store[emailKey];
    try{ localStorage.setItem(TRIPS_KEY, JSON.stringify(store)); }catch(e){}

    // Also upsert into global store so TravelDesk/Manager can see immediately.
    try{
      (store[emailKey] || []).forEach(t=>{
        if(!t || !t.id) return;
        if(typeof upsertGlobalTrip === 'function') upsertGlobalTrip(t);
      });
    }catch(e){}
  }


  // Expose for other scripts (used by submit handler below)
  window.loadTrips = loadTrips;
  window.saveTrips = saveTrips;

  // ‚úÖ Expose login + user helpers for other scripts (submit handler)
  window.getLoginContext = getLoginContext;
  window.getUserByEmail = getUserByEmail;
  window.upsertGlobalTrip = upsertGlobalTrip;
  window.normalizeEmail = normalizeEmail;

  function formatDate(dt){
    try{
      const d = new Date(dt);
      if(isNaN(d)) return '';
      return d.toLocaleString();
    }catch(e){
      // fallback (keep app running)
      return (dt === undefined || dt === null) ? '' : String(dt);
    }
  }

    
  // --- Status normalization for cross-stage syncing ---
  const STATUS_CODE_LABELS = {
    'DRAFT': 'Draft',
    'SUBMITTED': 'Submitted',
    'PENDING_TRAVEL_DESK': 'Pending with Travel Desk',
    'TRAVEL_DESK_PENDING': 'Pending with Travel Desk',
    'OPTIONS_SHARED': 'Options shared by Travel Desk',
    'VOUCHER_SENT': 'Pending with User (Voucher sent)',
    'PENDING_USER': 'Pending with User',
    'USER_CONFIRMED': 'Pending Manager Approval',
    'PENDING_MANAGER': 'Pending Manager Approval',
    'MANAGER_APPROVED': 'Approved',
    'APPROVED': 'Approved',
    'TICKETED': 'Ticketed',
    'BOOKED': 'Booked',
    'COMPLETED': 'COMPLETED',
    'CLOSED': 'Closed'
  };
  function _deriveStatusFromTrip(t){
    if(!t || typeof t !== 'object') return '';
    const rawStatus = String(t.status || '').trim();
    const code = String(t.statusCode || t.workflowStatus || t.workflowCode || '').trim().toUpperCase();
    // Prefer explicit status text when meaningful
    let out = rawStatus;
    if(!out && code && STATUS_CODE_LABELS[code]) out = STATUS_CODE_LABELS[code];

    // Heuristics: if TravelDesk shared options but status wasn't updated, reflect it
    const hasOptions = Array.isArray(t.options) ? t.options.length>0
      : Array.isArray(t.travelDeskOptions) ? t.travelDeskOptions.length>0
      : Array.isArray(t.proposedOptions) ? t.proposedOptions.length>0
      : false;
    if(hasOptions){
      const s = (out || rawStatus || '').toLowerCase();
      if(!s || s.includes('pending with travel desk') || s.includes('travel desk pending')){
        out = 'Options shared by Travel Desk';
      }
    }
    return out;
  }

function normalizeTripForView(trip){
      const t = Object.assign({}, trip || {});
      // normalize id
      t.id = t.id || t.requestId || t.rid || t.tripId || '';

      // --- Pull current login/user context as a reliable fallback (fixes blank fields) ---
      let ctx = null, u = null;
      try{ ctx = getLoginContext(); }catch(e){}
      try{ u = getUserByEmail(ctx?.email || '') || null; }catch(e){}

      const ctxName  = (ctx && (ctx.name || ctx.fullName)) ? String(ctx.name || ctx.fullName) : '';
      const ctxEmail = (ctx && ctx.email) ? String(ctx.email) : '';
      const ctxEmpId = (ctx && (ctx.employeeId || ctx.empId)) ? String(ctx.employeeId || ctx.empId) : '';
      const ctxMgr   = (ctx && (ctx.managerEmail || ctx.reportingManagerEmail || ctx.rmEmail)) ? String(ctx.managerEmail || ctx.reportingManagerEmail || ctx.rmEmail) : '';

      const uName  = u ? String([u.firstName, u.lastName].filter(Boolean).join(' ') || u.name || '') : '';
      const uEmail = u ? String(u.email || '') : '';
      const uEmpId = u ? String(u.employeeId || u.empId || '') : '';
      const uMgr   = u ? String(u.managerEmail || u.reportingManagerEmail || '') : '';

      // common field aliases (plus strong fallbacks)
      t.requesterName  = t.requesterName  || t.requester || t.userName || (t.profile && t.profile.name) || t.travelerName || t.employeeName || '' || uName || ctxName;
      t.requesterEmail = t.requesterEmail || t.email || t.userEmail || (t.profile && t.profile.email) || '' || uEmail || ctxEmail;
      t.employeeId     = t.employeeId     || t.empId || t.employeeID || '' || uEmpId || ctxEmpId;
      t.managerEmail   = t.managerEmail   || t.reportingManagerEmail || t.rmEmail || t.manager || '' || uMgr || ctxMgr;

      t.fromCity       = t.fromCity       || t.from || t.origin || t.departureCity || '';
      t.toCity         = t.toCity         || t.to || t.destination || t.arrivalCity || '';

      // Dates (support all known names)
      t.departDate     = t.departDate     || t.departureDate || t.departure || t.fromDate || '';
      t.returnDate     = t.returnDate     || t.returnOn || t.return || t.toDate || '';

      t.travelType     = t.travelType     || t.tripType || '';

      // Hotel
      t.hotelCity      = t.hotelCity      || t.city || t.hotelLocation || '';
      t.checkIn        = t.checkIn        || t.checkInDate || '';
      t.checkOut       = t.checkOut       || t.checkOutDate || '';
      t.hotelNights    = t.hotelNights    || t.nights || t.numberOfNights || t.numNights || t.hotelNight || '';

      // Visa link
      t.visaDocLink    = t.visaDocLink    || t.visa || t.visaURL || '';
      t.visaDocLink2   = t.visaDocLink2   || '';

      // Human-friendly title
      t.tripTitle      = t.tripTitle      || t.title || t.tripName || (t.toCity ? (`${t.fromCity||''} ‚Üí ${t.toCity||''}`.trim()) : '') || '';
      t.destinationCity    = t.destinationCity    || t.toCity || t.to || t.destination || '';
      t.destinationCountry = t.destinationCountry || t.country || t.destCountry || '';

      // Total cost (optional)
      t.totalCost      = t.totalCost      || t.total || t.total_amount || t.totalAmount || t.estimatedCost || t.estimatedTotal || t.costTotal || '';
      try{
        if(!t.totalCost){
          const nums = [
            t.flightCost, t.hotelCost, t.cabCost, t.miscCost,
            t.flight_amount, t.hotel_amount, t.cab_amount
          ].map(x=> Number(x)).filter(x=> !isNaN(x));
          if(nums.length) t.totalCost = nums.reduce((a,b)=>a+b,0);
        }
      }catch(e){}


      // Status: normalize so Dashboard reflects TravelDesk / Manager workflow updates
      try{
        const derived = (typeof _deriveStatusFromTrip === 'function') ? _deriveStatusFromTrip(t) : '';
        if(derived) t.status = derived;
      }catch(e){}

      return t;
    }


  // ‚úÖ Report rendering (synced with My Trips)
  // Uses the same data sources as My Trips (user-bucket + global store) and de-dups by Trip ID.
  function loadTripsForReportSafe(){
    let merged = [];
    try{ merged = merged.concat(loadTrips() || []); }catch(e){}
    try{
      const gstore = loadGlobalTripStore ? loadGlobalTripStore() : null;
      if(gstore){
        if(Array.isArray(gstore.pending)) merged = merged.concat(gstore.pending);
        if(Array.isArray(gstore.completed)) merged = merged.concat(gstore.completed);
        if(gstore.byId && typeof gstore.byId === 'object'){
          merged = merged.concat(Object.keys(gstore.byId).map(k=>gstore.byId[k]));
        }
      }else{
        const g = loadGlobalTrips ? loadGlobalTrips() : null;
        if(g && typeof g === 'object'){
          merged = merged.concat(Object.keys(g).map(k=>g[k]));
        }
      }
    }catch(e){}
    const map = new Map();
    merged.forEach(t=>{ if(t && t.id) map.set(String(t.id), t); });
    return Array.from(map.values());
  }

  function renderReportSafe(){
    let trips = [];
    try{ trips = loadTripsForReportSafe(); }catch(e){ trips = []; }

    const total = trips.length;
    const completed = trips.filter(t => String(t.status||'').toLowerCase().includes('complete')).length;
    const pending = total - completed;
    const international = trips.filter(t => String(t.travelType||'').toLowerCase()==='international').length;

    // keep Analytics data source in sync with Report/My Trips
    try{ window.__analyticsTrips = trips.map(normalizeTripForView); }catch(e){}

    const elTotal = document.getElementById('repTotalTrips');
    const elCompleted = document.getElementById('repCompletedTrips');
    const elPending = document.getElementById('repPendingTrips');
    const elIntl = document.getElementById('repInternationalTrips');
    if(elTotal) elTotal.textContent = String(total);
    if(elCompleted) elCompleted.textContent = String(completed);
    if(elPending) elPending.textContent = String(pending);
    if(elIntl) elIntl.textContent = String(international);

    const body = document.getElementById('reportTableBody');
    const empty = document.getElementById('reportEmpty');
    if(!body) return;

    body.innerHTML = '';
    if(total === 0){
      empty?.classList.remove('hidden');
      return;
    }
    empty?.classList.add('hidden');

    const sorted = [...trips].sort((a,b)=>{
      const ta = a.updatedAt || a.createdAt || '';
      const tb = b.updatedAt || b.createdAt || '';
      const ma = Date.parse(ta); const mb = Date.parse(tb);
      return (isNaN(mb)?0:mb) - (isNaN(ma)?0:ma);
    });

    // Prefer a human title if available; otherwise show the Trip/Request ID (so it never appears as "Untitled Trip").
    const getTripDisplayName = (t)=>{
      const rawTitle = (t.tripTitle || '').trim();
      if(rawTitle && rawTitle.toLowerCase() !== 'untitled trip') return rawTitle;
      const id = (t.id || t.tripId || t.requestId || t.requestID || t.reqId || '').toString().trim();
      if(id) return `Trip ${id}`;
      return 'Trip';
    };

    body.innerHTML = sorted.map(t=>{
      const title = escapeHtml(getTripDisplayName(t));
      const route = escapeHtml([t.fromCity || t.origin || '‚Äî', t.toCity || t.destination || '‚Äî'].join(' ‚Üí '));
      const ttype = escapeHtml(t.travelType || '‚Äî');
      const status = escapeHtml(t.status || 'Draft');
      const created = t.createdAt ? escapeHtml(formatDate(t.createdAt)) : '‚Äî';
      return `<tr>
        <td>${title}</td>
        <td>${route}</td>
        <td>${ttype}</td>
        <td><span class="pill">${status}</span></td>
        <td>${created}</td>
      </tr>`;
    }).join('');
  }

  function renderTrips(){
    const trips = loadTrips().map(normalizeTripForView);
    const q = (tripsSearch?.value || '').trim().toLowerCase();
    const sort = tripsSort?.value || 'new';

    let filtered = trips.filter(t => {
      if(!q) return true;
      const hay = [
        t.tripTitle, t.requesterName, t.requesterEmail, t.destinationCity, t.destinationCountry,
        t.employeeId, t.department, t.status
      ].filter(Boolean).join(' ').toLowerCase();
      return hay.includes(q);
    });

    if(sort === 'title'){
      filtered.sort((a,b)=> (a.tripTitle||'').localeCompare(b.tripTitle||''));
    }else if(sort === 'old'){
      filtered.sort((a,b)=> (new Date(a.createdAt||0)) - (new Date(b.createdAt||0)));
    }else{
      filtered.sort((a,b)=> (new Date(b.createdAt||0)) - (new Date(a.createdAt||0)));
    }

    const isPending = (t)=>{
      const s = String(t.status || 'Draft').toLowerCase();
      if(s.includes('completed') || s.includes('closed') || s.includes('cancel')) return false;
      return s.includes('pending') || s.includes('submitted') || s === 'draft' || s.includes('travel desk') || s.includes('with user');
    };

    const pending = filtered.filter(isPending);
    const completed = filtered.filter(t=>!isPending(t));

    // Empty state (no trips at all)
    if(!trips.length){
      allTripsList && (allTripsList.innerHTML = '');
      pendingTripsList && (pendingTripsList.innerHTML = '');
      myTripsEmpty?.classList.remove('hidden');
      return;
    }
    myTripsEmpty?.classList.add('hidden');

    const cardsHtml = (list, scope)=>{
      // Corporate list view with header + rows
      if(!list || !list.length){
        return `
          <div class="empty-state">
            <div class="empty-title">No trips found</div>
            <div class="empty-sub">Try switching tabs or clearing search.</div>
          </div>
        `;
      }

      const header = `
        <div class="trip-list-header" role="row">
          <div class="col col-id">Trip ID</div>
          <div class="col col-user">User</div>
          <div class="col col-route">Route</div>
          <div class="col col-date">Travel Date</div>
          <div class="col col-type">Travel Type</div>
          <div class="col col-cost">Total Cost</div>
          <div class="col col-status">Status</div>
          <div class="col col-viewdetail">View Details</div>
          <div class="col col-created">Created</div>
          <div class="col col-actions">Actions</div>
        </div>
      `;

      const rows = list.map((raw, idx) => {
        const t = normalizeTripForView(raw);

        const tripId = escapeHtml(String(t.id || '‚Äî'));
        const requesterName = escapeHtml(t.requesterName || '‚Äî');

        const from = escapeHtml(t.fromCity || '‚Äî');
        const to = escapeHtml(t.toCity || '‚Äî');
        const route = (from !== '‚Äî' || to !== '‚Äî') ? `${from} ‚Üí ${to}` : '‚Äî';

        const depart = escapeHtml(t.departDate || t.departureDate || '‚Äî');
        const ret = escapeHtml(t.returnDate || '‚Äî');
        const travelDate = (ret && ret !== '‚Äî' && String(ret).trim() !== '') ? `${depart} ‚Üí ${ret}` : `${depart}`;

        const travelType = escapeHtml(t.travelType || '‚Äî');
        const statusLabel = escapeHtml(t.status || 'Draft');
        const statusClass = (String(t.status||'').toLowerCase().includes('pend') || String(t.status||'').toLowerCase().includes('draft') || String(t.status||'').toLowerCase().includes('submit') || String(t.status||'').toLowerCase().includes('progress'))
          ? 'pill-warning'
          : 'pill-success';

        let totalCost = t.totalCost ?? t.estimatedTotal ?? t.estimateTotal ?? t.totalAmount ?? t.amount ?? null;
        if(typeof totalCost === 'number') totalCost = totalCost.toFixed(0);
        totalCost = (totalCost === undefined || totalCost === null || String(totalCost).trim() === '' || (typeof totalCost === 'number' && isNaN(totalCost)))
          ? '‚Äî'
          : String(totalCost);
        const totalCostView = escapeHtml(totalCost);

        const created = t.createdAt ? formatDate(t.createdAt) : '‚Äî';

        return `
          <div class="trip-list-row" role="row">
            <div class="col col-id" data-label="Trip ID">${tripId}</div>
            <div class="col col-user" data-label="User">
              <div class="user-cell">
                <span class="user-avatar" aria-hidden="true">${escapeHtml((t.requesterName||'TR').split(/\s+/).slice(0,2).map(s=>s[0]||'').join('').toUpperCase() || 'TR')}</span>
                <span class="user-name">${requesterName}</span>
              </div>
            </div>
            <div class="col col-route" data-label="Route">${route}</div>
            <div class="col col-date" data-label="Travel Date">${travelDate}</div>
            <div class="col col-type" data-label="Travel Type">${travelType}</div>
            <div class="col col-cost" data-label="Total Cost">${totalCostView}</div>
            <div class="col col-status" data-label="Status"><span class="pill ${statusClass}">${statusLabel}</span></div>
            <div class="col col-viewdetail" data-label="View Details">
              <button class="btn btn-secondary btn-sm btn-viewdetail" data-viewdetail-trip="${idx}" data-scope="${scope}" type="button">${(String(t.status||'').toLowerCase().includes('complete')||String(t.status||'').toLowerCase().includes('approved')||String(t.status||'').toLowerCase().includes('closed')||String(t.status||'').toLowerCase().includes('confirm')||String(t.status||'').toLowerCase().includes('ticket')||String(t.status||'').toLowerCase().includes('done')) ? 'Confirmation' : 'Details'}</button>
            </div>
            
            <div class="col col-created" data-label="Created">${escapeHtml(created)}</div>
            <div class="col col-actions" data-label="Actions">
              <div class="actions-cell">
                <button class="btn btn-secondary btn-sm" data-open-trip="${idx}" data-scope="${scope}" type="button">View</button>
                <button class="btn btn-secondary btn-sm" data-view-itin="${idx}" data-scope="${scope}" type="button">Itinerary</button>
                <button class="btn btn-secondary btn-sm" data-view-confirmv="${idx}" data-scope="${scope}" type="button">Confirmation Voucher</button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      return `<div class="trip-list" role="table" aria-label="Trips list">${header}${rows}</div>`;
    };

    if(allTripsList) allTripsList.innerHTML = cardsHtml(completed, 'all');
    if(pendingTripsList) pendingTripsList.innerHTML = cardsHtml(pending, 'pending');

    
  // Report section rendering (demo mode: based on locally saved trips)
  
  // Report should stay in sync with My Trips.
  // In demo mode, trips may exist in:
  //  - user-bucket store (TRIPS_KEY)
  //  - global store (GLOBAL_TRIPS_KEY)
  // This helper merges ALL sources by Trip ID so Report never shows 0 when trips exist.
  function loadTripsForReport(){
    let merged = [];
    // runtime cache
    try{ if(window.__TRIPS_RUNTIME && Array.isArray(window.__TRIPS_RUNTIME)) merged = merged.concat(window.__TRIPS_RUNTIME); }catch(e){}
    // current user's merged view
    try{ merged = merged.concat(loadTrips() || []); }catch(e){}
    // global store (all)
    try{
      const g = loadGlobalTrips();
      if(g && typeof g === 'object'){
        merged = merged.concat(Object.keys(g).map(k=>g[k]).filter(Boolean));
      }
    }catch(e){}
    // legacy user-bucket store (all users)
    try{
      const store = JSON.parse(localStorage.getItem(TRIPS_KEY) || '{}');
      if(store && typeof store === 'object' && !Array.isArray(store)){
        Object.keys(store).forEach(k=>{
          const arr = store[k];
          if(Array.isArray(arr)) merged = merged.concat(arr.filter(Boolean));
        });
      } else if(Array.isArray(store)){
        merged = merged.concat(store.filter(Boolean));
      }
    }catch(e){}
    // de-dup by Trip ID
    const map = new Map();
    merged.forEach(t=>{ if(t && t.id) map.set(String(t.id), t); });
    return Array.from(map.values());
  }

  function getReportRows(){
    // Use the same normalization as the dashboard list
    const trips = (window.__reportTrips && Array.isArray(window.__reportTrips)) ? window.__reportTrips : (loadTripsForReport().map(normalizeTripForView));
    return trips.map(t=>{
      const tripId = t.id || t.requestId || t.tripId || '';
      const user = t.requesterName || t.userName || '';
      const route = (t.fromCity || t.originCity || t.from || '') + ' ‚Üí ' + (t.toCity || t.destinationCity || t.to || '');
      const travelDate = t.departureDate || t.departDate || t.travelDate || '';
      const travelType = t.travelType || '';
      const totalCost = t.totalCost || t.estimatedTotal || t.grandTotal || '';
      const status = t.status || '';
      const created = t.createdAt || t.created || '';
      return { tripId, user, route: route.replace(/^\s*‚Üí\s*$/,'‚Äî'), travelDate: travelDate || '‚Äî', travelType: travelType || '‚Äî', totalCost: (totalCost!=='' && totalCost!=null)? totalCost : '‚Äî', status: status || '‚Äî', created: created || '‚Äî' };
    });
  }

  function downloadTextFile(filename, content, mime){
    const blob = new Blob([content], {type: mime || 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
  }

  function exportReportExcel(){
    const rows = getReportRows();
    const headers = ['Trip ID','User','Route','Travel Date','Travel Type','Total Cost','Status','Created'];
    const csv = [
      headers.join(','),
      ...rows.map(r=>[
        r.tripId, r.user, r.route, r.travelDate, r.travelType, r.totalCost, r.status, r.created
      ].map(v=>'"'+String(v||'').replace(/"/g,'""')+'"').join(','))
    ].join('\n');
    // Excel opens CSV nicely; name kept as .csv for compatibility
    downloadTextFile('Trip_Report.csv', csv, 'text/csv;charset=utf-8');
  }

    function exportReportPdf(){
    const rows = getReportRows();

    // Build a simple printable HTML (no popups). We print via a hidden iframe.
    const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Trip Report</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:18px;color:#111;}
    h1{font-size:16px;margin:0 0 10px;}
    table{width:100%;border-collapse:collapse;}
    th,td{border:1px solid #cfd8dc;padding:6px 8px;text-align:left;vertical-align:top;}
    th{background:#f3f6f8;}
  </style>
</head>
<body>
  <h1>Trip Report</h1>
  <table>
    <thead>
      <tr>
        <th>Trip ID</th>
        <th>Route</th>
        <th>Travel Date</th>
        <th>Type</th>
        <th>Total Cost</th>
        <th>Status</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody>
      ${(rows||[]).map(r=>`
        <tr>
          <td>${escapeHtml(r.id)}</td>
          <td>${escapeHtml(r.route)}</td>
          <td>${escapeHtml(r.travelDate)}</td>
          <td>${escapeHtml(r.travelType)}</td>
          <td>${escapeHtml(r.totalCost)}</td>
          <td>${escapeHtml(r.status)}</td>
          <td>${escapeHtml(r.created)}</td>
        </tr>`).join('')}
    </tbody>
  </table>
  <div class="note" style="margin-top:10px;color:#6b7280;">If the print dialog doesn‚Äôt open automatically, press Ctrl+P.</div>
<!-- ETG Realtime (Socket.IO) -->
</body>
</html>`;

    // Create hidden iframe and print
    const frame = document.createElement('iframe');
    frame.style.position = 'fixed';
    frame.style.right = '0';
    frame.style.bottom = '0';
    frame.style.width = '0';
    frame.style.height = '0';
    frame.style.border = '0';
    frame.setAttribute('aria-hidden','true');
    document.body.appendChild(frame);

    const cleanup = ()=>{
      try{ document.body.removeChild(frame); }catch(e){}
    };

    try{
      frame.onload = ()=>{
        try{
          frame.contentWindow && frame.contentWindow.focus();
          // Slight delay helps some browsers render before print
          setTimeout(()=>{
            try{ frame.contentWindow && frame.contentWindow.print(); }catch(e){}
            // Cleanup after print dialog opens
            setTimeout(cleanup, 800);
          }, 120);
        }catch(e){
          cleanup();
        }
      };

      // srcdoc works for local file testing without popups
      frame.srcdoc = html;
    }catch(e){
      cleanup();
      alert('Unable to generate printable report in this browser.');
    }
  }

  
  // ===== Analytics (synced with My Trips + Report) =====

  function parseTripDate(t){
    const v = t.createdAt || t.created || t.submittedAt || t.updatedAt || '';
    const d = v ? new Date(v) : null;
    return (d && !isNaN(d.getTime())) ? d : null;
  }

  function getAnalyticsRangeDays(){
    const sel = document.getElementById('analyticsRange');
    const v = sel ? sel.value : 'all';
    const n = parseInt(v, 10);
    return isNaN(n) ? null : n;
  }

  function filterTripsByRange(trips){
    const days = getAnalyticsRangeDays();
    if(!days) return trips;
    const now = new Date();
    const from = new Date(now.getTime() - days*24*60*60*1000);
    return (trips||[]).filter(t=>{
      const d = parseTripDate(t);
      return d ? d >= from && d <= now : true;
    });
  }

  function toMoney(v){
    const n = Number(String(v||'').replace(/[^0-9.\-]/g,''));
    if(isNaN(n)) return null;
    return n;
  }

  function fmtCompact(n){
    if(n == null || isNaN(n)) return '‚Äî';
    try{ return new Intl.NumberFormat(undefined, {maximumFractionDigits:0}).format(n); }catch(e){ return String(Math.round(n)); }
  }

  function fmtMonthKey(d){
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    return `${y}-${m}`;
  }
  function fmtMonthLabel(key){
    // key: YYYY-MM
    const [y,m] = String(key).split('-');
    const dt = new Date(Number(y), Number(m)-1, 1);
    try{ return dt.toLocaleString(undefined, {month:'short', year:'numeric'}); }catch(e){ return key; }
  }

  function buildBarRow(label, value, max){
    const pct = max>0 ? Math.round((value/max)*100) : 0;
    return `
      <div class="barrow">
        <div class="barlabel">${escapeHtml(label)}</div>
        <div class="bartrack"><div class="barfill" style="width:${pct}%;"></div></div>
        <div class="barvalue">${escapeHtml(String(value))}</div>
      </div>
    `;
  }

  function renderAnalyticsSafe(){
    try{
      const allTrips = loadTripsForReportSafe();
      const trips = filterTripsByRange(allTrips);

      const empty = document.getElementById('analyticsEmpty');
      const hasAny = (trips||[]).length > 0;

      // KPIs
      const total = trips.length;
      const completed = trips.filter(t => String(t.status||'').toLowerCase().includes('complete')).length;
      const pending = total - completed;

      const costs = trips.map(t=>toMoney(t.totalCost || t.estimatedTotal || t.grandTotal)).filter(v=>v!=null && !isNaN(v));
      const avgCost = costs.length ? (costs.reduce((a,b)=>a+b,0) / costs.length) : null;

      const setTxt = (id, val)=>{ const el=document.getElementById(id); if(el) el.textContent = val; };
      setTxt('anTotalTrips', String(total));
      setTxt('anCompletedTrips', String(completed));
      setTxt('anPendingTrips', String(pending));
      setTxt('anAvgCost', avgCost==null ? '‚Äî' : fmtCompact(avgCost));

      // Subtexts
      setTxt('anTotalTripsSub', getAnalyticsRangeDays() ? 'Filtered view' : 'All trips');
      setTxt('anCompletedTripsSub', total? `${Math.round((completed/total)*100)}%` : '‚Äî');
      setTxt('anPendingTripsSub', total? `${Math.round((pending/total)*100)}%` : '‚Äî');

      if(!hasAny){
        empty?.classList.remove('hidden');
      }else{
        empty?.classList.add('hidden');
      }

      // Bars: by month (last 8 buckets)
      const byMonth = {};
      (trips||[]).forEach(t=>{
        const d = parseTripDate(t) || new Date();
        const k = fmtMonthKey(d);
        byMonth[k] = (byMonth[k]||0)+1;
      });
      const monthKeys = Object.keys(byMonth).sort().slice(-8);
      const maxMonth = monthKeys.reduce((m,k)=>Math.max(m, byMonth[k]||0), 0);
      const monthWrap = document.getElementById('anByMonthBars');
      if(monthWrap){
        monthWrap.innerHTML = monthKeys.length
          ? monthKeys.map(k=>buildBarRow(fmtMonthLabel(k), byMonth[k], maxMonth)).join('')
          : '<div style="color:var(--muted);font-size:13px;">No dated data found.</div>';
      }

      // Bars: status
      const byStatus = {
        'Completed': completed,
        'Pending': pending
      };
      const maxStatus = Math.max(byStatus['Completed'], byStatus['Pending'], 1);
      const stWrap = document.getElementById('anByStatusBars');
      if(stWrap){
        stWrap.innerHTML = Object.keys(byStatus).map(k=>buildBarRow(k, byStatus[k], maxStatus)).join('');
      }

      // Bars: travel type
      const byType = {};
      (trips||[]).forEach(t=>{
        const k = (t.travelType || t.tripType || 'Unknown').toString().trim() || 'Unknown';
        byType[k] = (byType[k]||0)+1;
      });
      const typeKeys = Object.keys(byType).sort((a,b)=>(byType[b]-byType[a])).slice(0,6);
      const maxType = typeKeys.reduce((m,k)=>Math.max(m, byType[k]||0), 0) || 1;
      const tyWrap = document.getElementById('anByTypeBars');
      if(tyWrap){
        tyWrap.innerHTML = typeKeys.map(k=>buildBarRow(k, byType[k], maxType)).join('');
      }

      // Top routes table
      const byRoute = {};
      (trips||[]).forEach(t=>{
        const from = (t.fromCity || t.origin || '‚Äî').toString().trim() || '‚Äî';
        const to = (t.toCity || t.destination || '‚Äî').toString().trim() || '‚Äî';
        const key = `${from} ‚Üí ${to}`;
        if(!byRoute[key]) byRoute[key] = { total:0, completed:0, pending:0 };
        byRoute[key].total += 1;
        if(String(t.status||'').toLowerCase().includes('complete')) byRoute[key].completed += 1;
        else byRoute[key].pending += 1;
      });
      const topRoutes = Object.entries(byRoute)
        .sort((a,b)=> (b[1].total - a[1].total))
        .slice(0,8);

      const topBody = document.getElementById('anTopRoutesBody');
      if(topBody){
        topBody.innerHTML = topRoutes.length ? topRoutes.map(([route,stats])=>`
          <tr>
            <td>${escapeHtml(route)}</td>
            <td>${escapeHtml(String(stats.total))}</td>
            <td>${escapeHtml(String(stats.completed))}</td>
            <td>${escapeHtml(String(stats.pending))}</td>
          </tr>
        `).join('') : `<tr><td colspan="4" style="color:var(--muted);padding:12px;">No routes to show.</td></tr>`;
      }

      // Keep a snapshot for exports
      window.__analyticsTrips = trips.map(normalizeTripForView);

    }catch(e){
      console.error(e);
    }
  }

  function exportAnalyticsExcel(){
    // Corporate-friendly export: detailed trips + key fields (same source as Report)
    const trips = filterTripsByRange(loadTripsForReportSafe());
    const rows = (trips||[]).map(normalizeTripForView).map(t=>{
      const tripId = (t.id || t.tripId || t.requestId || t.requestID || t.reqId || '').toString().trim();
      const user = (t.requesterName || t.employeeName || t.fullName || '') || (t.requesterEmail || t.email || '');
      const route = [t.fromCity || t.origin || '‚Äî', t.toCity || t.destination || '‚Äî'].join(' ‚Üí ');
      const travelDate = t.departDate || t.travelDate || t.journeyDate || t.fromDate || '';
      const travelType = t.travelType || t.tripType || '';
      const totalCost = t.totalCost || t.estimatedTotal || t.grandTotal || '';
      const status = t.status || '';
      const created = t.createdAt || t.created || '';
      return { tripId, user, route, travelDate: travelDate || '‚Äî', travelType: travelType || '‚Äî', totalCost: (totalCost!=='' && totalCost!=null)? totalCost : '‚Äî', status: status || '‚Äî', created: created || '‚Äî' };
    });
    const headers = ['Trip ID','User','Route','Travel Date','Travel Type','Total Cost','Status','Created'];
    const csv = [
      headers.join(','),
      ...rows.map(r=>[
        r.tripId, r.user, r.route, r.travelDate, r.travelType, r.totalCost, r.status, r.created
      ].map(v=>'"'+String(v||'').replace(/"/g,'""')+'"').join(','))
    ].join('\n');
    downloadTextFile('Trip_Analytics.xlsx.csv', csv, 'text/csv;charset=utf-8');
  }

  function exportAnalyticsPdf(){
    // Export as printable corporate snapshot (user can Save as PDF)
    const trips = filterTripsByRange(loadTripsForReportSafe()).map(normalizeTripForView);
    const total = trips.length;
    const completed = trips.filter(t => String(t.status||'').toLowerCase().includes('complete')).length;
    const pending = total - completed;

    const html = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Trip Analytics</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;font-size:12px;padding:18px;color:#111;}
    h1{font-size:16px;margin:0 0 6px;}
    .sub{color:#555;margin:0 0 12px;}
    .kpis{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px;}
    .kpi{border:1px solid #cfd8dc;border-radius:10px;padding:10px 12px;min-width:160px;}
    .kpi .k{font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:#666;margin-bottom:6px;font-weight:bold;}
    .kpi .v{font-size:18px;font-weight:bold;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{border:1px solid #cfd8dc;padding:6px 8px;text-align:left;vertical-align:top;}
    th{background:#f3f6f8;}
  </style>
</head>
<body>
  <h1>Trip Analytics</h1>
  <p class="sub">Generated from local trip data (demo mode).</p>

  <div class="kpis">
    <div class="kpi"><div class="k">Total Trips</div><div class="v">${total}</div></div>
    <div class="kpi"><div class="k">Completed</div><div class="v">${completed}</div></div>
    <div class="kpi"><div class="k">Pending</div><div class="v">${pending}</div></div>
  </div>

  <h2 style="font-size:13px;margin:14px 0 6px;letter-spacing:.08em;text-transform:uppercase;color:#555;">Trips (Detail)</h2>
  <table>
    <thead>
      <tr>
        <th>Trip ID</th>
        <th>Route</th>
        <th>Travel Date</th>
        <th>Type</th>
        <th>Total Cost</th>
        <th>Status</th>
        <th>Created</th>
      </tr>
    </thead>
    <tbody>
      ${(function(){
        const trips = filterTripsByRange(loadTripsForReportSafe());
        return (trips||[]).map(normalizeTripForView).map(t=>{
          const tripId = (t.id || t.tripId || t.requestId || t.requestID || t.reqId || '').toString().trim();
          const route = [t.fromCity || t.origin || '‚Äî', t.toCity || t.destination || '‚Äî'].join(' ‚Üí ');
          const travelDate = t.departDate || t.travelDate || t.journeyDate || t.fromDate || '‚Äî';
          const travelType = t.travelType || t.tripType || '‚Äî';
          const totalCost = t.totalCost || t.estimatedTotal || t.grandTotal || '‚Äî';
          const status = t.status || '‚Äî';
          const created = t.createdAt || t.created || '‚Äî';
          return {tripId, route, travelDate, travelType, totalCost, status, created};
        });
      })().map(r=>`
        <tr>
          <td>${escapeHtml(r.tripId)}</td>
          <td>${escapeHtml(r.route)}</td>
          <td>${escapeHtml(r.travelDate)}</td>
          <td>${escapeHtml(r.travelType)}</td>
          <td>${escapeHtml(r.totalCost)}</td>
          <td>${escapeHtml(r.status)}</td>
          <td>${escapeHtml(r.created)}</td>
        </tr>`).join('')}
    </tbody>
  </table>

  <div style="margin-top:10px;color:#6b7280;">Use the print dialog to ‚ÄúSave as PDF‚Äù.</div>
</body>
</html>`;

    const frame = document.createElement('iframe');
    frame.style.position='fixed';
    frame.style.right='0';
    frame.style.bottom='0';
    frame.style.width='0';
    frame.style.height='0';
    frame.style.border='0';
    frame.setAttribute('aria-hidden','true');
    document.body.appendChild(frame);

    const cleanup = ()=>{ try{ document.body.removeChild(frame);}catch(e){} };

    frame.onload = ()=>{
      try{
        frame.contentWindow && frame.contentWindow.focus();
        setTimeout(()=>{
          try{ frame.contentWindow && frame.contentWindow.print(); }catch(e){}
          setTimeout(cleanup, 800);
        }, 120);
      }catch(e){ cleanup(); }
    };
    frame.srcdoc = html;
  }

  // Hook Analytics controls
  document.getElementById('analyticsExportCsvBtn')?.addEventListener('click', exportAnalyticsExcel);
  document.getElementById('analyticsExportPdfBtn')?.addEventListener('click', exportAnalyticsPdf);
  document.getElementById('analyticsRange')?.addEventListener('change', renderAnalyticsSafe);
  document.getElementById('analyticsCreateBtn')?.addEventListener('click', ()=>{
    showOnly(tripSection);
    setActiveNav('navCreate');
    resetTripForm();
  });


// Hook Report export buttons
  document.getElementById('reportExportCsvBtn')?.addEventListener('click', exportReportExcel);
  document.getElementById('reportExportPdfBtn')?.addEventListener('click', exportReportPdf);


function renderReport(){
    const trips = loadTripsForReport();
    window.__reportTrips = trips.map(normalizeTripForView);

    const total = trips.length;
    const completed = trips.filter(t => String(t.status||'').toLowerCase().includes('complete')).length;
    const pending = trips.filter(t => {
      const s = String(t.status||'').toLowerCase();
      return s && s !== 'completed';
    }).length;
    const international = trips.filter(t => String(t.travelType||'').toLowerCase()==='international').length;

    const elTotal = document.getElementById('repTotalTrips');
    const elCompleted = document.getElementById('repCompletedTrips');
    const elPending = document.getElementById('repPendingTrips');
    const elIntl = document.getElementById('repInternationalTrips');
    if(elTotal) elTotal.textContent = String(total);
    if(elCompleted) elCompleted.textContent = String(completed);
    if(elPending) elPending.textContent = String(pending);
    if(elIntl) elIntl.textContent = String(international);

    const body = document.getElementById('reportTableBody');
    const empty = document.getElementById('reportEmpty');
    if(!body) return;

    body.innerHTML = '';
    if(total === 0){
      empty?.classList.remove('hidden');
      return;
    }
    empty?.classList.add('hidden');

    // newest first
    const sorted = [...trips].sort((a,b)=>{
      const ta = a.createdAt ? new Date(a.createdAt).getTime() : 0;
      const tb = b.createdAt ? new Date(b.createdAt).getTime() : 0;
      return tb - ta;
    });

    // Prefer a human title if available; otherwise show the Trip/Request ID (so it never appears as "Untitled Trip").
    const getTripDisplayName = (t)=>{
      const rawTitle = (t.tripTitle || '').trim();
      if(rawTitle && rawTitle.toLowerCase() !== 'untitled trip') return rawTitle;
      const id = (t.id || t.tripId || t.requestId || t.requestID || t.reqId || '').toString().trim();
      if(id) return `Trip ${id}`;
      return 'Trip';
    };

    body.innerHTML = sorted.map(t=>{
      const title = escapeHtml(getTripDisplayName(t));
      const route = escapeHtml([t.fromCity || t.origin || '‚Äî', t.toCity || t.destination || '‚Äî'].join(' ‚Üí '));
      const ttype = escapeHtml(t.travelType || '‚Äî');
      const status = escapeHtml(t.status || 'Draft');
      const created = t.createdAt ? escapeHtml(formatDate(t.createdAt)) : '‚Äî';
      return `<tr>
        <td>${title}</td>
        <td>${route}</td>
        <td>${ttype}</td>
        <td><span class="pill">${status}</span></td>
        <td>${created}</td>
      </tr>`;
    }).join('');
  }

  // Report CTA
  document.getElementById('reportCreateBtn')?.addEventListener('click', ()=>{
    showOnly(tripSection);
    setActiveNav('navCreate');
    resetTripForm();
  });

function openTripModal(trip){
      const modal = document.getElementById('tripModal');
      const grid = document.getElementById('tripModalGrid');
      const title = document.getElementById('tripModalTitle');
      if(!modal || !grid) return;

      trip = normalizeTripForView(trip);
      const fields = [
        ['Request ID', trip.id || '‚Äî'],
        ['Status', trip.status || 'Draft'],
        ['Created', trip.createdAt ? formatDate(trip.createdAt) : '‚Äî'],
        ['Requester', trip.requesterName || '‚Äî'],
        ['Requester Email', trip.requesterEmail || '‚Äî'],
        ['Employee ID', trip.employeeId || '‚Äî'],
        ['Manager Email', trip.managerEmail || '‚Äî'],
        ['From', trip.fromCity || '‚Äî'],
        ['To', trip.toCity || '‚Äî'],
        ['Departure', trip.departDate || '‚Äî'],
        ['Return', trip.returnDate || '‚Äî'],
        ['Travel Type', trip.travelType || '‚Äî'],
        ['Hotel City', trip.hotelCity || '‚Äî'],
        ['Check-in', trip.checkIn || '‚Äî'],
        ['Check-out', trip.checkOut || '‚Äî'],
        ['Number of Nights', trip.hotelNights || '‚Äî'],
        ['Visa Link', trip.visaDocLink2 || trip.visaDocLink || '‚Äî'],
      ];

      grid.innerHTML = fields.map(([k,v])=>`
        <div class="trip-field">
          <div class="k">${escapeHtml(k)}</div>
          <div class="v">${escapeHtml(v)}</div>
        </div>
      `).join('');

      // ‚úÖ Confirmation details (auto populated after TravelDesk clicks "Send confirmation" in Stage 8)
      try{
        if(trip && trip.confirmation){
          const sent = trip.confirmation.sent ? 'Yes' : 'Draft';
          const sentAt = trip.confirmation.sentAt ? formatDate(trip.confirmation.sentAt) : '‚Äî';
          const c = trip.confirmation;
          const lines = [];
          if(c.overview?.travelerName) lines.push(`Traveler: ${c.overview.travelerName}`);
          if(c.overview?.purpose) lines.push(`Purpose: ${c.overview.purpose}`);
          if(c.flight?.pnr || c.flight?.ticketNo) lines.push(`Flight: PNR ${c.flight.pnr || '‚Äî'} | Ticket ${c.flight.ticketNo || '‚Äî'}`);
          if(c.hotel?.name) lines.push(`Hotel: ${c.hotel.name}`);
          if(c.cab?.pickup) lines.push(`Cab pickup: ${c.cab.pickup}`);
          const summary = lines.length ? lines.join('\\n') : 'Confirmation details are available.';
          grid.insertAdjacentHTML('beforeend', `
            <div class="trip-field" style="grid-column:1 / -1;background:rgba(15,185,177,.06);border:1px dashed var(--border);">
              <div class="k">Confirmation Sent</div>
              <div class="v">${escapeHtml(sent)} (Sent at: ${escapeHtml(sentAt)})</div>
            </div>
            <div class="trip-field" style="grid-column:1 / -1;">
              <div class="k">Confirmation Summary</div>
              <div class="v" style="white-space:pre-wrap;">${escapeHtml(summary)}</div>
            </div>
            <div style="grid-column:1 / -1;display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
              <button class="btn btn-primary btn-sm" type="button" id="openConfirmationBtn">Open Confirmation</button>
            </div>
          `);
          setTimeout(()=>{
            const b = document.getElementById('openConfirmationBtn');
            if(b){
              b.addEventListener('click', ()=>{
                openConfirmationDetails(trip);
              });
            }
          }, 0);
        }
      }catch(e){}


      if(title) title.textContent = `Trip Details ‚Äî ${trip.id || ''}`.trim();
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }

    
    function openConfirmationDetails(trip){
      try{
        // Always re-load latest trip from GLOBAL store so user can see what TravelDesk sent
        const rid = (trip && (trip.id || trip.tripId || trip.requestId)) ? String(trip.id || trip.tripId || trip.requestId) : '';
        const latest = rid ? (findTripById ? findTripById(rid) : null) : null;
        const t = normalizeTripForView(latest || trip || {});

        const c = t.confirmation || null;
        if(!c || (!c.sent && !c.emailHtml && !c.pdfDataUrl && !c.pdfUrl && !c.fileUrl && !c.url && !c.documentUrl)){
          alert('Confirmation details are not available for this request yet. It will appear here once TravelDesk sends the confirmation.');
          return;
        }

        // Prefer voucher/document URL/data URL if TravelDesk attached one
        const docUrl = c.voucherPdfDataUrl || c.voucherPdfUrl || c.pdfDataUrl || c.pdfUrl || c.fileUrl || c.url || c.documentUrl || '';
        if(docUrl){
          // Try to open via a user-gesture anchor click (less likely to be blocked than window.open)
          try{
            const a = document.createElement('a');
            a.href = docUrl;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            document.body.appendChild(a);
            a.click();
            a.remove();
          }catch(e){}
          // Also show inside the in-page modal as a fallback (no popups needed)
          showConfirmationVoucherModal(t, c, docUrl);
          return;
        }

        // If TravelDesk generated an email HTML, render it (best user experience)
        if(c.emailHtml){
          showConfirmationVoucherModal(t, c, '', c.emailHtml);
          return;
        }

        // Otherwise show a readable confirmation summary
        const pretty = (obj)=>{ try{ return JSON.stringify(obj, null, 2); }catch(e){ return String(obj); } };
        const html = `<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Confirmation ‚Äî ${String(t.id||'')}</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6fbfb;color:#0b2a2a;}
  header{padding:16px 20px;border-bottom:1px solid #cfe4e4;background:#fff;position:sticky;top:0}
  h1{margin:0;font-size:18px}
  .sub{opacity:.7;font-size:13px;margin-top:4px}
  .wrap{padding:18px 20px}
  .card{background:#fff;border:1px solid #cfe4e4;border-radius:14px;padding:14px 14px;margin-bottom:14px}
  pre{white-space:pre-wrap;word-break:break-word;margin:0;font-size:12px;line-height:1.5}
</style>
</head>
<body>
<header>
  <h1>Confirmation Details ‚Äî ${escapeHtml(t.id||'')}</h1>
  <div class="sub">Status: ${escapeHtml(t.status||'‚Äî')} ‚Ä¢ Created: ${escapeHtml(t.createdAt ? formatDate(t.createdAt) : '‚Äî')}</div>
</header>
<div class="wrap">
  <div class="card"><pre>${escapeHtml(pretty(c))}</pre></div>
</div>
</body></html>`;
        showConfirmationVoucherModal(t, c, '', html);
      }catch(e){
        alert('Unable to open confirmation details.');
      }
    }


function wireViewButtons(root, list){
      if(!root) return;
      root.querySelectorAll('[data-open-trip]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.getAttribute('data-open-trip'));
          const trip = list[idx];
          if(trip) openTripModal(trip);
        });
      });
    }
    wireViewButtons(allTripsList, filtered);
    wireViewButtons(pendingTripsList, pending);
    function wireItinButtons(root, list){
      if(!root) return;
      root.querySelectorAll('[data-view-itin]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.getAttribute('data-view-itin'));
          const trip = list[idx];
          if(!trip || !trip.id) return;
          try{ localStorage.setItem('etg-selected-trip-id', String(trip.id)); }catch(e){}
          window.location.href = 'Stage6_User_Confirmation_policy_violation_mandatory_comment.html?rid=' + encodeURIComponent(String(trip.id));
        });
      });
    }
    wireItinButtons(allTripsList, filtered);
    wireItinButtons(pendingTripsList, pending);

    
    function showConfirmationVoucherModal(tripNorm, confirmationObj, docUrl, fallbackHtml){
      const modal = document.getElementById('confirmVoucherModal');
      const body = document.getElementById('confirmVoucherBody');
      const openNew = document.getElementById('confirmVoucherOpenNew');
      const closeBtn = document.getElementById('confirmVoucherCloseBtn');
      if(!modal || !body) return;

      // Close handlers
      const close = ()=>{ modal.style.display='none'; body.innerHTML=''; openNew.href='#'; };
      closeBtn && closeBtn.addEventListener('click', close, { once:false });
      modal.addEventListener('click', (e)=>{ if(e.target===modal) close(); }, { once:false });

      // Set "open in new tab" link
      if(docUrl){
        openNew.style.display = '';
        openNew.href = docUrl;
      }else{
        openNew.style.display = 'none';
        openNew.href = '#';
      }

      // Render content
      if(docUrl && (String(docUrl).startsWith('data:') || String(docUrl).startsWith('blob:') || String(docUrl).startsWith('http') || String(docUrl).startsWith('file:'))){
        // Use iframe for PDFs/links (works for many URLs; data/blob also ok in modern browsers)
        body.innerHTML = '<iframe src="'+String(docUrl).replace(/"/g,'&quot;')+'" style="width:100%;height:100%;border:0;"></iframe>';
      }else if(fallbackHtml){
        body.innerHTML = fallbackHtml;
      }else{
        // Generic fallback
        const pretty = (obj)=>{ try{ return JSON.stringify(obj, null, 2); }catch(e){ return String(obj); } };
        body.innerHTML = '<div style="padding:14px;"><pre style="white-space:pre-wrap;word-break:break-word;margin:0;font-size:12px;line-height:1.5;">'+
          escapeHtml(pretty(confirmationObj||{}))+
          '</pre></div>';
      }

      modal.style.display='flex';
    }

    function openConfirmationVoucher(trip){
      try{
        const t = normalizeTripForView(trip || {});
        const c = t.confirmation || null;
        if(!c){
          alert('Confirmation voucher is not available yet. It will appear here once TravelDesk sends the confirmation.');
          return;
        }
        // Prefer direct voucher document URL / data URL
        const docUrl = c.voucherPdfDataUrl || c.voucherPdfUrl || c.pdfDataUrl || c.pdfUrl || c.fileUrl || c.url || c.documentUrl || '';
        if(docUrl){
          // Try to open via a user-gesture anchor click (less likely to be blocked than window.open)
          try{
            const a = document.createElement('a');
            a.href = docUrl;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            document.body.appendChild(a);
            a.click();
            a.remove();
          }catch(e){}
          // Also show inside the in-page modal as a fallback (no popups needed)
          showConfirmationVoucherModal(t, c, docUrl);
          return;
        }

        // If confirmation is structured but no file URL, show a simple voucher page with key info.
        const pretty = (obj)=>{ try{ return JSON.stringify(obj, null, 2); }catch(e){ return String(obj); } };
        const html = `<!doctype html>
<html><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Confirmation Voucher ‚Äî ${String(t.id||'')}</title>
<style>
  body{font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;margin:0;background:#f6fbfb;color:#0b2a2a;}
  header{padding:16px 20px;border-bottom:1px solid #cfe4e4;background:#fff;position:sticky;top:0}
  h1{margin:0;font-size:18px}
  .sub{opacity:.7;font-size:13px;margin-top:4px}
  .wrap{padding:18px 20px}
  .card{background:#fff;border:1px solid #cfe4e4;border-radius:14px;padding:14px 14px;margin-bottom:14px}
  pre{white-space:pre-wrap;word-break:break-word;margin:0;font-size:12px;line-height:1.5}
</style>
</head>
<body>
<header>
  <h1>Confirmation Voucher ‚Äî ${escapeHtml(t.id||'')}</h1>
  <div class="sub">If TravelDesk shared a PDF voucher link, it will open directly. Otherwise this page shows the details they sent.</div>
</header>
<div class="wrap">
  <div class="card"><pre>${escapeHtml(pretty(c))}</pre></div>
</div>
</body></html>`;
        showConfirmationVoucherModal(t, c, '', html);
      }catch(e){
        alert('Unable to open confirmation voucher.');
      }
    }

    function wireConfirmVoucherButtons(root, list){
      if(!root) return;
      root.querySelectorAll('[data-view-confirmv]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.getAttribute('data-view-confirmv'));
          const trip = list[idx];
          if(!trip) return;
          openConfirmationVoucher(trip);
        });
      });
    }
    wireConfirmVoucherButtons(allTripsList, filtered);
    wireConfirmVoucherButtons(pendingTripsList, pending);

    function isCompletedStatus(s){
      s = String(s||'').toLowerCase();
      return s.includes('complete') || s.includes('approved') || s.includes('closed') || s.includes('confirm') || s.includes('ticket') || s.includes('done');
    }
    function wireViewDetailButtons(root, list){
      if(!root) return;
      root.querySelectorAll('[data-viewdetail-trip]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const idx = Number(btn.getAttribute('data-viewdetail-trip'));
          const trip = list[idx];
          if(!trip) return;
          const t = normalizeTripForView(trip);
          // For completed trips show confirmation, otherwise show request details
          if(isCompletedStatus(t.status)){
            openConfirmationDetails(t);
          }else{
            openTripModal(t);
          }
        });
      });
    }
    wireViewDetailButtons(allTripsList, filtered);
    wireViewDetailButtons(pendingTripsList, pending);

  }

  function escapeHtml(str){
    return String(str ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  // Dropdown
  if(profileMenuBtn && profileDropdown){
    profileMenuBtn.addEventListener('click', (e)=>{
      e.preventDefault();
      e.stopPropagation();
      profileDropdown.classList.toggle('open');
    });
    document.addEventListener('click', ()=>{
      profileDropdown.classList.remove('open');
    });
    profileDropdown.addEventListener('click', (e)=> e.stopPropagation());
  }

  // Profile modal
  function openProfile(){
    const ctx = requireLogin();
    if(!ctx) return;

    try{
      window.__lastVisibleSectionId = document.querySelector('main section:not(.hidden)')?.id || 'heroSection';
    }catch(e){
      window.__lastVisibleSectionId = 'heroSection';
    }

    [heroSection, wizardSection, myTripsSection, approvalsSection, reportSection, analyticsSection].forEach(s => s && s.classList.add('hidden'));
    hydrateUserUi();

    if(profileModal){
      profileModal.classList.add('open');
      profileModal.setAttribute('aria-hidden','false');
    }
    profileDropdown?.classList.remove('open');
  }

  function closeProfile(){
    profileModal?.classList.remove('open');
    profileModal?.setAttribute('aria-hidden','true');

    const id = window.__lastVisibleSectionId || 'heroSection';
    const target = document.getElementById(id) || heroSection;
    showOnly(target);
  }


  // Policy modal (view for all, upload for admin)
  function isAdminUser(){
    const ctx = getLoginContext();
    const role = String(ctx?.role || '').toUpperCase();
    return role === 'SUPER_ADMIN' || role === 'APP_SUPER_ADMIN';
  }

  function renderPolicy(policy){
    const has = !!(policy && policy.dataUrl);
    if(policyEmpty) policyEmpty.style.display = has ? 'none' : 'block';
    if(policyFrame) policyFrame.style.display = has ? 'block' : 'none';

    if(policyOpenLink) policyOpenLink.style.display = has ? 'inline-flex' : 'none';
    if(policyDownloadLink) policyDownloadLink.style.display = has ? 'inline-flex' : 'none';

    if(!has){
      if(policyMetaEl) policyMetaEl.textContent = '‚Äî';
      if(policyFrame) policyFrame.removeAttribute('src');
      if(policyOpenLink) policyOpenLink.href = '#';
      if(policyDownloadLink) policyDownloadLink.href = '#';
      if(policyDownloadLink) policyDownloadLink.removeAttribute('download');
      return;
    }

    const meta = [];
    if(policy.name) meta.push(policy.name);
    if(policy.uploadedAt) meta.push('Updated: ' + formatDate(policy.uploadedAt));
    if(policy.uploadedBy) meta.push('By: ' + policy.uploadedBy);
    if(policyMetaEl) policyMetaEl.textContent = meta.filter(Boolean).join(' ¬∑ ') || '‚Äî';

    // Preview best effort:
    // - PDF/images: iframe src works
    // - DOC/DOCX: show download/open only (iframe may not render)
    const t = String(policy.type || '').toLowerCase();
    const canPreview = t.includes('pdf') || t.includes('image') || t.includes('png') || t.includes('jpeg') || t.includes('jpg');
    if(policyFrame){
      if(canPreview) policyFrame.src = policy.dataUrl;
      else policyFrame.removeAttribute('src');
    }

    if(policyOpenLink) policyOpenLink.href = policy.dataUrl;
    if(policyDownloadLink){
      policyDownloadLink.href = policy.dataUrl;
      policyDownloadLink.download = policy.name || 'travel-policy';
    }
  }

  function loadPolicy(){
    try{
      const raw = localStorage.getItem(POLICY_KEY);
      if(!raw) return DEFAULT_POLICY;
      const obj = JSON.parse(raw);
      return (obj && typeof obj === 'object' && obj.dataUrl) ? obj : DEFAULT_POLICY;
    }catch(e){
      return DEFAULT_POLICY;
    }
  }

  function savePolicyToStore(obj){
    try{ localStorage.setItem(POLICY_KEY, JSON.stringify(obj || {})); }catch(e){}
  }

  function setPolicyError(msg){
    if(!policyErr) return;
    if(msg){
      policyErr.textContent = msg;
      policyErr.classList.remove('hidden');
    }else{
      policyErr.textContent = '';
      policyErr.classList.add('hidden');
    }
  }

  function openPolicy(){
    const ctx = requireLogin();
    if(!ctx) return;

    try{
      window.__lastVisibleSectionId = document.querySelector('main section:not(.hidden)')?.id || 'heroSection';
    }catch(e){
      window.__lastVisibleSectionId = 'heroSection';
    }

    // hide all sections (like profile)
    [heroSection, wizardSection, myTripsSection, approvalsSection, reportSection, analyticsSection].forEach(s => s && s.classList.add('hidden'));

    const admin = isAdminUser();
    if(policyAdminBlock){
      policyAdminBlock.classList.toggle('hidden', !admin);
      policyAdminBlock.setAttribute('aria-hidden', admin ? 'false' : 'true');
    }

    setPolicyError('');
    if(policyFile) policyFile.value = '';

    renderPolicy(loadPolicy());

    // View-only for all users. Hide download for non-admin.
    if(!admin && policyDownloadLink) policyDownloadLink.style.display = 'none';


    policyModal?.classList.add('open');
    policyModal?.setAttribute('aria-hidden','false');
    profileDropdown?.classList.remove('open');
  }

  function closePolicy(){
    policyModal?.classList.remove('open');
    policyModal?.setAttribute('aria-hidden','true');

    const id = window.__lastVisibleSectionId || 'heroSection';
    const target = document.getElementById(id) || heroSection;
    showOnly(target);
  }

  openPolicyBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openPolicy(); });
  closePolicyBtn?.addEventListener('click', closePolicy);
  policyBackdrop?.addEventListener('click', closePolicy);

  // Save uploaded policy (admin)
  policySaveBtn?.addEventListener('click', ()=>{
    if(!isAdminUser()){
      alert('Only admin can upload the policy document.');
      return;
    }
    const file = policyFile?.files?.[0];
    if(!file){
      setPolicyError('Please choose a file to upload.');
      return;
    }
    const maxBytes = 8 * 1024 * 1024; // 8MB
    if(file.size > maxBytes){
      setPolicyError('File is too large. Please upload a file smaller than 8 MB.');
      return;
    }
    setPolicyError('');

    const reader = new FileReader();
    reader.onload = ()=>{
      const ctx = (window.getLoginContext ? window.getLoginContext() : {}) || {};
      const payload = {
        name: file.name,
        type: file.type || '',
        size: file.size || 0,
        dataUrl: reader.result,
        uploadedAt: new Date().toISOString(),
        uploadedBy: ctx.email || ctx.name || 'Admin'
      };
      savePolicyToStore(payload);
      renderPolicy(payload);
      alert('Policy document saved successfully.');
    };
    reader.onerror = ()=> setPolicyError('Unable to read this file. Please try another file.');
    reader.readAsDataURL(file);
  });

  policyClearBtn?.addEventListener('click', ()=>{
    if(!isAdminUser()){
      alert('Only admin can clear the policy document.');
      return;
    }
    try{ localStorage.removeItem(POLICY_KEY); }catch(e){}
    if(policyFile) policyFile.value = '';
    setPolicyError('');
    renderPolicy(null);
    alert('Policy document cleared.');
  });


  openProfileBtn?.addEventListener('click', (e)=>{ e.preventDefault(); openProfile(); });
  closeProfileBtn?.addEventListener('click', closeProfile);
  profileBackdrop?.addEventListener('click', closeProfile);
  document.addEventListener('keydown', (e)=>{
    if(e.key !== 'Escape') return;
    if(policyModal && policyModal.classList.contains('open')){ closePolicy(); return; }
    if(profileModal && profileModal.classList.contains('open')){ closeProfile(); return; }
  });


  
  // Sign out
  const btnSignOut = document.getElementById('btnSignOut');
  btnSignOut?.addEventListener('click', (e)=>{
    e.preventDefault();

    // Persist any last-known password/role/name into the user store before clearing login context
    try{
      const ctx = getLoginContext();
      if(ctx && ctx.email){
        const pwd = ctx.password || ctx.pass || ctx.pwd;
        const patch = {};
        if(ctx.role) patch.role = ctx.role;
        if(ctx.name){
          const parts = String(ctx.name).trim().split(/\s+/).filter(Boolean);
          if(parts.length >= 1) patch.firstName = parts[0];
          if(parts.length >= 2) patch.lastName = parts.slice(1).join(' ');
        }
        if(pwd) patch.password = String(pwd);
        if(Object.keys(patch).length) upsertUser(ctx.email, patch);
      }
    }catch(err){}

    try{
      localStorage.removeItem(LOGIN_KEY);
      sessionStorage.removeItem(LOGIN_KEY);
    }catch(err){}
    window.location.href = 'Stage 1 (User log in Template).html';
  });

// Navigation
  navHome?.addEventListener('click', (e)=>{
    e.preventDefault();
    showOnly(heroSection);
    hydrateUserUi();
    profileDropdown?.classList.remove('open');
  });

  navCreate?.addEventListener('click', (e)=>{
    e.preventDefault();
    showOnly(wizardSection);
    hydrateUserUi(); // ‚úÖ prefill Contact Information using logged-in user
    profileDropdown?.classList.remove('open');
  });

  navTrips?.addEventListener('click', (e)=>{
    e.preventDefault();
    showOnly(myTripsSection);
    renderTrips();
    profileDropdown?.classList.remove('open');
  });


  createTripBtn?.addEventListener('click', ()=>{ showOnly(wizardSection); setActiveNav('navHome'); hydrateUserUi(); });
  myTripsCreateBtn?.addEventListener('click', ()=>{ showOnly(wizardSection); hydrateUserUi(); });

  tripsSearch?.addEventListener('input', ()=> renderTrips());
  tripsSort?.addEventListener('change', ()=> renderTrips());

  // Tabs: All vs Pending
  function setTripsTab(which){
    const allOn = which === 'all';
    if(allTripsList) allTripsList.classList.toggle('hidden', !allOn);
    if(pendingTripsList) pendingTripsList.classList.toggle('hidden', allOn);
    if(tabAllTrips) tabAllTrips.classList.toggle('active', allOn);
    if(tabPendingTrips) tabPendingTrips.classList.toggle('active', !allOn);
  }
  tabAllTrips?.addEventListener('click', ()=>{ setTripsTab('all'); });
  tabPendingTrips?.addEventListener('click', ()=>{ setTripsTab('pending'); });
  setTripsTab('all');

  // Trip modal close
  const tripModal = document.getElementById('tripModal');
  const tripModalClose = document.getElementById('tripModalClose');
  const tripModalBackdrop = document.getElementById('tripModalBackdrop');
  function closeTripModal(){
    tripModal?.classList.remove('open');
    tripModal?.setAttribute('aria-hidden','true');
  }
  tripModalClose?.addEventListener('click', closeTripModal);
  tripModalBackdrop?.addEventListener('click', closeTripModal);


  // Default view
  showOnly(heroSection);

  // Keep My Trips list in sync when wizard saves a trip (wizard sets localStorage)
  window.addEventListener('storage', (e)=>{
    const key = e.key;
    if((key === TRIPS_KEY || key === GLOBAL_TRIPS_KEY) && !myTripsSection.classList.contains('hidden')){
      renderTrips();
    }
    if((key === TRIPS_KEY || key === GLOBAL_TRIPS_KEY) && !reportSection.classList.contains('hidden')){
      renderReportSafe();
    }
    if((key === TRIPS_KEY || key === GLOBAL_TRIPS_KEY) && !analyticsSection.classList.contains('hidden')){
      renderAnalyticsSafe();
    }
  });

  // ‚úÖ Extra sync layer: storage events don't fire in the same tab.
  // This lightweight watcher keeps the dashboard/report/analytics in sync even if TravelDesk updates happen
  // via scripts in the same window or storage events are blocked (some file:// setups).
  let __lastGlobalRaw = null;
  let __lastLegacyRaw = null;

  function _syncUiFromStorage(){
    let gRaw = null, lRaw = null;
    try{ gRaw = localStorage.getItem(GLOBAL_TRIPS_KEY) || ''; }catch(e){ gRaw = null; }
    try{ lRaw = localStorage.getItem(TRIPS_KEY) || ''; }catch(e){ lRaw = null; }

    if(gRaw === __lastGlobalRaw && lRaw === __lastLegacyRaw) return;
    __lastGlobalRaw = gRaw;
    __lastLegacyRaw = lRaw;

    // Only re-render what's visible
    if(!myTripsSection.classList.contains('hidden') && typeof renderTrips === 'function') renderTrips();
    if(!reportSection.classList.contains('hidden') && typeof renderReportSafe === 'function') renderReportSafe();
    if(!analyticsSection.classList.contains('hidden') && typeof renderAnalyticsSafe === 'function') renderAnalyticsSafe();
  }

  // Poll + on focus/visibility
  setInterval(_syncUiFromStorage, 900);
  window.addEventListener('focus', _syncUiFromStorage);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) _syncUiFromStorage(); });


})();

;

  const $ = (id) => document.getElementById(id);

  const isValidEmail = (v) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
  const isTenDigits = (v) => {
    const digits = String(v||'').replace(/\D/g,'');
    return digits.length >= 10 && digits.length <= 15;
  };
  const isComEmail = (v) => isValidEmail(v) && v.toLowerCase().endsWith('.com');

  // ‚úÖ NEW: URL validator (optional, but must be valid if provided)
  const DEFAULT_VISA_TOOL_URL = 'https://www.traveldoc.aero/';

  const isValidUrl = (v) => {
    if(!v) return true;
    try { new URL(v); return true; } catch(e){ return false; }
  };
  // ‚úÖ Default Visa/Passport status tool link (visible to all users)
  function initVisaDocToolLink(){
    const in1 = document.getElementById('visaDocLink');
    const in2 = document.getElementById('visaDocLink2');
    const a1 = document.getElementById('visaDocOpenBtn');
    const a2 = document.getElementById('visaDocOpenBtn2');

    const setDefault = (inp, anchor)=>{
      if(!inp) return;
      const v = String(inp.value || '').trim();
      const next = v ? v : DEFAULT_VISA_TOOL_URL;
      inp.value = next;
      if(anchor) anchor.href = next;

      inp.addEventListener('input', ()=>{
        const vv = String(inp.value || '').trim();
        if(anchor) anchor.href = vv || DEFAULT_VISA_TOOL_URL;
      });
    };

    setDefault(in1, a1);
    setDefault(in2, a2);
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initVisaDocToolLink);
  }else{
    initVisaDocToolLink();
  }


  function setError(fieldEl, errEl, msg){
    if(!fieldEl || !errEl) return;
    if(msg){
      fieldEl.classList.add('is-invalid');
      errEl.textContent=msg;
      errEl.classList.remove('hidden');
    } else {
      fieldEl.classList.remove('is-invalid');
      errEl.textContent='';
      errEl.classList.add('hidden');
    }
  }

  function toast(msg){
    alert(msg);
  }

  function updateStepper(step){}

  
  function isInternationalTrip(){
    return ($('travelType')?.value || '').toLowerCase() === 'international';
  }

  function toggleInternationalDocs(){
    const block = $('travelDocsBlock');
    if(!block) return;

    const intl = isInternationalTrip();
    block.classList.toggle('hidden', !intl);
    block.setAttribute('aria-hidden', intl ? 'false' : 'true');

    // required toggles
    const reqIds = ['passportNumber','passportExpiry','passportNationality','issuingCountry','visaStatus','visaNumber','visaDocLink2'];
    reqIds.forEach(id=>{
      const el = $(id);
      if(!el) return;
      if(intl){
        el.setAttribute('required','required');
      }else{
        el.removeAttribute('required');
        // clear values so they don't leak into domestic trips
        if(el.tagName === 'SELECT') el.value = '';
        else el.value = '';
      }
      const err = $('err_'+id);
      if(err) setError(el, err, '');
    });

    // keep the visa link in sync (you already have visaDocLink on step2)
    const v1 = $('visaDocLink');
    const v2 = $('visaDocLink2');
    if(intl && v1 && v2 && !v2.value) v2.value = (v1.value || '');
  }

  function validateInternationalDocs(){
    if(!isInternationalTrip()) return true;

    const checks = [
      ['passportNumber','Passport number is required'],
      ['passportExpiry','Passport expiry date is required'],
      ['passportNationality','Nationality is required'],
      ['issuingCountry','Issuing country is required'],
      ['visaStatus','Visa type is required'],
      ['visaNumber','Visa number is required'],
      ['visaDocLink2','Visa document link is required'],
    ];

    let hasError = false;
    checks.forEach(([id,msg])=>{
      const el = $(id);
      const err = $('err_'+id);
      if(!el) return;
      const val = (el.value || '').trim();
      if(!val){
        if(err) setError(el, err, msg);
        hasError = true;
      }else{
        if(err) setError(el, err, '');
      }
    });

    if(hasError){
      (document.querySelector('.is-invalid')||document.querySelector('.field-error:not(.hidden)'))?.focus?.();
      return false;
    }
    return true;
  }


  function buildReview(){
    const box=$('reviewBox');
    if(!box) return;

    const e = (v)=>String(v??'').replace(/[&<>"']/g, (c)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]));
    const isIntl = isInternationalTrip();

    const row = (label, valueHtml)=>`
      <div class="review-row">
        <div class="review-label">${e(label)}</div>
        <div class="review-value">${valueHtml}</div>
      </div>
    `;

    const stack = (lines)=>`<div class="stack">${lines.filter(Boolean).map(l=>`<div>${e(l)}</div>`).join('')}</div>`;

    // --- Flight / Trip overview ---
    const tripType = $('tripType')?.value || '';
    const tripTypeLabel = tripType==='round' ? 'Round-trip' : (tripType==='one' ? 'One-way' : 'Multi-city');

    const fromVal = $('fromCity')?.value || '';
    const toVal   = $('toCity')?.value || '';
    const dd      = $('departDate')?.value || '';
    const rd      = $('returnDate')?.value || '';

    // Multi-city segments (best-effort display based on whatever inputs exist in rows)
    let multiSegLines = [];
    if(tripType==='multi'){
      const holder = $('segments');
      if(holder){
        multiSegLines = Array.from(holder.children).map((r,idx)=>{
          const vals = Array.from(r.querySelectorAll('input,select')).map(x=>(x.value||'').trim()).filter(Boolean);
          return vals.length ? `#${idx+1}: ${vals.join(' ¬∑ ')}` : '';
        }).filter(Boolean);
      }
    }

    const routeHtml = tripType==='multi'
      ? (multiSegLines.length ? stack(multiSegLines) : e('‚Äî'))
      : e(`${fromVal} ‚Üí ${toVal}`);

    const flightWhen = (tripType==='round' && rd) ? e(dd + ' ‚Üí ' + rd) : e(dd || '‚Äî');

    // Optional visa link from step 2
    const visaLink = $('visaDocLink')?.value?.trim?.() || '';
    const visaLinkHtml = visaLink
      ? `<a class="doc-link" href="${e(visaLink)}" target="_blank" rel="noopener">Visa requirements ‚Äì ${e(visaLink.replace(/^https?:\/\//,'').replace(/\/$/,''))} ‚Üó</a>`
      : '‚Äî';

    // --- Hotel segments (if hotel service is enabled/visible) ---
    let hotelHtml = '‚Äî';
    const hotelBlock = $('hotelBlock');
    if(hotelBlock && !hotelBlock.classList.contains('hidden')){
      const holder = $('hotelSegments');
      if(holder && holder.children.length){
        const segs = Array.from(holder.children).map((row,idx)=>{
          const city = row.querySelector('.hCity')?.value || '';
          const cin  = row.querySelector('.hIn')?.value || '';
          const cout = row.querySelector('.hOut')?.value || '';
          const nights = row.querySelector('.hNights')?.value || '';
          return (city||cin||cout)
            ? `#${idx+1}: ${city} ¬∑ ${cin} ‚Üí ${cout}${nights?` (${nights} night${Number(nights)===1?'':'s'})`:''}`
            : '';
        }).filter(Boolean);
        hotelHtml = segs.length ? stack(segs) : '‚Äî';
      }
    }

    // --- Cab segments (if cab service is enabled/visible) ---
    let cabHtml = '‚Äî';
    const cabBlock = $('cabBlock');
    if(cabBlock && !cabBlock.classList.contains('hidden')){
      const holder = $('cabSegments');
      if(holder && holder.children.length){
        const segs = Array.from(holder.children).map((row,idx)=>{
          const p = row.querySelector('.cPick')?.value || '';
          const d = row.querySelector('.cDrop')?.value || '';
          const dt= row.querySelector('.cDate')?.value || '';
          const tm= row.querySelector('.cTime')?.value || '';
          return (p||d||dt||tm) ? `#${idx+1}: ${p} ‚Üí ${d} ¬∑ ${dt}${tm?` ${tm}`:''}` : '';
        }).filter(Boolean);
        cabHtml = segs.length ? stack(segs) : '‚Äî';
      }
    }

    // --- Passport & Visa (International only) ---
    let passVisaCard = '';
    if(isIntl){
      const pn = $('passportNumber')?.value || '‚Äî';
      const pe = $('passportExpiry')?.value || '‚Äî';
      const nat = $('nationality')?.value || '‚Äî';
      const ic = $('issuingCountry')?.value || '‚Äî';
      const vt = $('visaStatus')?.value || '‚Äî';
      const vn = $('visaNumber')?.value || '‚Äî';
      const vdoc = $('visaDocLink2')?.value?.trim?.() || '‚Äî';

      const vdocHtml = (vdoc && vdoc!=='‚Äî' && isValidUrl(vdoc))
        ? `<a class="doc-link" href="${e(vdoc)}" target="_blank" rel="noopener">Open document ‚Üó</a>`
        : e(vdoc);

      passVisaCard = `
        <div class="review-card half">
          <div class="review-card-title">üõÇ Passport &amp; Visa <small>(International)</small></div>
          <div class="review-rows">
            ${row('Passport Number', e(pn))}
            ${row('Passport Expiry', e(pe))}
            ${row('Nationality', e(nat))}
            ${row('Issuing Country', e(ic))}
            ${row('Visa Type', e(vt))}
            ${row('Visa Number', e(vn))}
            ${row('Visa Document', vdocHtml)}
          </div>
        </div>
      `;
    }

    box.innerHTML = `
      <div class="review-top">
        <div>
          <div class="review-h">Review your request before submission</div>
          <div class="review-sub">Please verify your travel and document details. This cannot be edited after submission.</div>
        </div>
        <div class="review-links">
          <button type="button" class="review-link" id="editTripBtn">‚úèÔ∏è Edit trip details</button>
          ${isIntl ? `<button type="button" class="review-link" id="editDocsBtn">‚úèÔ∏è Edit passport &amp; visa</button>` : ``}
        </div>
      </div>

      <div class="review-grid">
        <div class="review-card half">
          <div class="review-card-title">‚úàÔ∏è Trip Overview</div>
          <div class="review-rows">
            ${row('Trip Type', e(tripTypeLabel))}
            ${row('Travel From', e(fromVal || '‚Äî'))}
            ${row('Travel To', e(toVal || '‚Äî'))}
            ${row('Travel Date', (tripType==='round' && rd) ? e(dd + ' ‚Üí ' + rd) : e(dd || '‚Äî'))}
            ${row('Visa information link', visaLinkHtml)}
          </div>
        </div>

        <div class="review-card half">
          <div class="review-card-title">üè® Hotel</div>
          <div class="review-rows">
            ${row('Itinerary', hotelHtml)}
          </div>
        </div>

        <div class="review-card half">
          <div class="review-card-title">üöï Cab</div>
          <div class="review-rows">
            ${row('Itinerary', cabHtml)}
          </div>
        </div>

        ${passVisaCard}
      </div>
    `;

    // Edit shortcuts
    $('editTripBtn')?.addEventListener('click', ()=>{
      $('step3')?.classList.add('hidden');
      $('step2')?.classList.remove('hidden');
      updateStepper(2);
    });

    $('editDocsBtn')?.addEventListener('click', ()=>{
      $('step3')?.classList.add('hidden');
      $('step3docs')?.classList.remove('hidden');
      updateStepper(3);
      toggleInternationalDocs();
    });
  }

// Step 1 -> 2 (minimal for this file)
  
  // --- Step 1 validation & save (local demo store) ---
  const USERS_KEY = 'etg-users';
  const LOGIN_KEY = 'etg-login';

  function getLoginEmail(){
    try{
      const local = localStorage.getItem(LOGIN_KEY);
      const sess  = sessionStorage.getItem(LOGIN_KEY);
      const ctx = local ? JSON.parse(local) : (sess ? JSON.parse(sess) : null);
      return (ctx && ctx.email) ? String(ctx.email).trim().toLowerCase() : '';
    }catch(e){ return ''; }
  }
  function upsertUserLocal(patch){
    const emailKey = getLoginEmail();
    if(!emailKey) return;
    let store = {};
    try{ store = JSON.parse(localStorage.getItem(USERS_KEY) || '{}') || {}; }catch(e){ store = {}; }
    const existing = store[emailKey] || {};
    store[emailKey] = Object.assign({}, existing, patch, {
      updatedAt: new Date().toISOString(),
      createdAt: existing.createdAt || new Date().toISOString(),
    });
    try{ localStorage.setItem(USERS_KEY, JSON.stringify(store)); }catch(e){}
  }

  function validateStep1(){
    const fullName = $('fullName');
    const email = $('email');
    const phone = $('phone');
    const costCenter = $('costCenter');
    const subBusinessUnitName = $('subBusinessUnitName');
    const costCenterLocation = $('costCenterLocation');
    const managerEmail = $('managerEmail');
    const employeeId = $('employeeId');

    // clear errors
    ['fullName','email','phone','costCenter','subBusinessUnitName','costCenterLocation','managerEmail','employeeId'].forEach(id=>{
      const el = $(id);
      const err = $('err_'+id);
      if(el && err) setError(el, err, '');
    });

    let hasError = false;

    if(!fullName?.value?.trim()){
      setError(fullName, $('err_fullName'), 'Full name is required');
      hasError = true;
    }
    if(!email?.value?.trim() || !isValidEmail(email.value.trim())){
      setError(email, $('err_email'), 'Valid email is required');
      hasError = true;
    }
    if(!phone?.value?.trim() || !isTenDigits(phone.value.trim())){
      setError(phone, $('err_phone'), 'Enter a valid phone number');
      hasError = true;
    }
    if(!costCenter?.value?.trim()){
      setError(costCenter, $('err_costCenter'), 'Business Unit Name is required');
      hasError = true;
    }
    if(!subBusinessUnitName?.value?.trim()){
      setError(subBusinessUnitName, $('err_subBusinessUnitName'), 'Sub Business Unit Name is required');
      hasError = true;
    }
    if(!costCenterLocation?.value?.trim()){
      setError(costCenterLocation, $('err_costCenterLocation'), 'Cost Center Location is required');
      hasError = true;
    }
    if(!employeeId?.value?.trim()){
      setError(employeeId, $('err_employeeId'), 'Employee ID is required');
      hasError = true;
    }
    if(!managerEmail?.value?.trim() || !isValidEmail(managerEmail.value.trim())){
      setError(managerEmail, $('err_managerEmail'), 'Valid manager email is required');
      hasError = true;
    }

    if(hasError){
      (document.querySelector('.is-invalid')||document.querySelector('.field-error:not(.hidden)'))?.focus?.();
      return false;
    }

    // save to local user store (so profile + autofill works)
    upsertUserLocal({
      fullName: fullName.value.trim(),
      phoneCode: $('phoneCode')?.value || '',
      phone: phone.value.trim(),
      mobile: ( $('phoneCode')?.value ? ($('phoneCode').value + ' ' + phone.value.trim()) : phone.value.trim() ),
      costCenter: costCenter.value.trim(),
      subBusinessUnitName: subBusinessUnitName.value.trim(),
      costCenterLocation: costCenterLocation.value.trim(),
      managerEmail: managerEmail.value.trim(),
      employeeId: employeeId.value.trim(),
      travelerType: $('travelerType')?.value || '',
      nationality: $('nationalityEmp')?.value || ''
    });

    return true;
  }

  $('btnNext')?.addEventListener('click',()=>{
    if(!validateStep1()) return;
    $('step1').classList.add('hidden');
    $('step2').classList.remove('hidden');
    updateStepper(2);
  });

$('btnBack1')?.addEventListener('click',()=>{
    $('step2').classList.add('hidden');
    $('step1').classList.remove('hidden');
    updateStepper(1);
  });

  // Step 3docs -> Review
  $('btnNextDocs')?.addEventListener('click',()=>{
    if(!validateInternationalDocs()) return;
    buildReview();
    $('step3docs').classList.add('hidden');
    $('step3').classList.remove('hidden');
    updateStepper(3);
  });;

  // Back from docs to trip details
  $('btnBackDocs')?.addEventListener('click',()=>{
    $('step3docs').classList.add('hidden');
    $('step2').classList.remove('hidden');
    updateStepper(2);
  });


  // Step 2 -> 3 with validation (includes Visa Document URL)
  $('btnNext2')?.addEventListener('click',()=>{
    // reset errors (simple fields)
    [
      'fromCity','toCity','departDate','returnDate','visaDocLink'
    ].forEach(id=>{
      const el=$(id);
      const err=$('err_'+id);
      if(el&&err) setError(el,err,'');
    });

    let hasError=false;

    const f=$('fromCity'),
          to=$('toCity'),
          dd=$('departDate'),
          rd=$('returnDate');

    if(!f.value.trim()){
      setError(f,$('err_fromCity'),'From is required');
      hasError=true;
    }
    if(!to.value.trim()){
      setError(to,$('err_toCity'),'To is required');
      hasError=true;
    }
    if(!dd.value){
      setError(dd,$('err_departDate'),'Departure date is required');
      hasError=true;
    }
    if($('tripType').value==='round' && !rd.value){
      setError(rd,$('err_returnDate'),'Return date is required');
      hasError=true;
    }

    // Visa Document link on step 2: optional, but if provided must be a valid URL
    const visaEl = $('visaDocLink');
    if(visaEl && visaEl.value.trim() && !isValidUrl(visaEl.value.trim())){
      setError(visaEl, $('err_visaDocLink'), 'Please enter a valid website link (example: https://...)');
      hasError = true;
    }

    if(hasError){
      (document.querySelector('.is-invalid')||document.querySelector('.field-error:not(.hidden)'))?.focus?.();
      return;
    }

    toggleInternationalDocs();

    // ‚úÖ International -> go to Passport & Visa step (Step 3)
    if(isInternationalTrip()){
      $('step2').classList.add('hidden');
      $('step3docs').classList.remove('hidden');
      updateStepper(3);
      return;
    }

    // ‚úÖ Domestic -> build review and go straight to review (Step 4 UI)
    buildReview();
    $('step2').classList.add('hidden');
    $('step3').classList.remove('hidden');
    updateStepper(3);
  });

  $('btnBack2')?.addEventListener('click',()=>{
    $('step3').classList.add('hidden');

    if(isInternationalTrip()){
      $('step3docs').classList.remove('hidden');
      updateStepper(3);
      toggleInternationalDocs();
      return;
    }

    $('step2').classList.remove('hidden');
    updateStepper(2);
  });

  // Submit (includes Visa Document link)
  $('btnSubmit')?.addEventListener('click',()=>{
    const visaLink = $('visaDocLink') ? $('visaDocLink').value.trim() : '';

    let body = `New Travel Request%0D%0A%0D%0A`;
    body += `üõ´ Flight Details%0D%0A`;
    body += `‚Ä¢ Route: ${$('fromCity').value} ‚Üí ${$('toCity').value}%0D%0A`;
    body += `‚Ä¢ Departure: ${$('departDate').value}%0D%0A`;
    if($('tripType').value==='round'){
      body += `‚Ä¢ Return: ${$('returnDate').value}%0D%0A`;
    }
    body += `‚Ä¢ Travel Type: ${$('travelType').value}%0D%0A`;

    if(isInternationalTrip()){
      body += `%0D%0AüõÇ Passport & Visa%0D%0A`;
      body += `‚Ä¢ Passport No: ${$('passportNumber')?.value || ''}%0D%0A`;
      body += `‚Ä¢ Passport Expiry: ${$('passportExpiry')?.value || ''}%0D%0A`;
      body += `‚Ä¢ Nationality: ${$('passportNationality')?.value || ''}%0D%0A`;
      body += `‚Ä¢ Issuing Country: ${$('issuingCountry')?.value || ''}%0D%0A`;
      body += `‚Ä¢ Visa Type: ${$('visaStatus')?.value || ''}%0D%0A`;
      body += `‚Ä¢ Visa No: ${$('visaNumber')?.value || ''}%0D%0A`;
      const v2 = $('visaDocLink2')?.value?.trim?.() || visaLink;
      if(v2) body += `‚Ä¢ Visa Document Link: ${v2}%0D%0A`;
    }

    // ‚úÖ NEW: Visa Document link in email
    if(visaLink){
      body += `‚Ä¢ Visa Document Link: ${visaLink}%0D%0A`;
    }

    const reqId = 'TR-' + Math.random().toString(36).slice(2,8).toUpperCase();
    $('reqId').textContent = reqId;

    // Save trip record (demo)
    const ctx = (window.getLoginContext ? window.getLoginContext() : {}) || {};
    const u = (window.getUserByEmail ? window.getUserByEmail(ctx.email || '') : null) || {};
    const fallbackName = (ctx.name || ctx.fullName || [u.firstName,u.lastName].filter(Boolean).join(' ') || u.name || '').trim();
    const fallbackEmail = (ctx.email || u.email || '').trim();
    const fallbackEmpId = (ctx.employeeId || ctx.empId || u.employeeId || u.empId || '').trim();
    const fallbackMgr = (ctx.managerEmail || ctx.reportingManagerEmail || ctx.rmEmail || u.managerEmail || u.reportingManagerEmail || '').trim();

    // Save trip record (demo)
    const tripRecord = {
      id: reqId,
      createdAt: new Date().toISOString(),
      status: 'Pending with Travel Desk',

      // These were blank for many users because the form fields are not always filled.
      // We now reliably fall back to login context / user store.
      requesterName: ($('fullName')?.value?.trim?.() || '') || fallbackName,
      requesterEmail: ($('email')?.value?.trim?.() || '') || fallbackEmail,
      employeeId: ($('employeeId')?.value?.trim?.() || '') || fallbackEmpId,
      managerEmail: ($('managerEmail')?.value?.trim?.() || '') || fallbackMgr,
      // Aliases used by later stages (Stage 8 prefill expects these)
      employeeCode: ($('employeeId')?.value?.trim?.() || '') || fallbackEmpId,
      purpose: ($('purpose')?.value?.trim?.() || ''),

      requester: {
        name: ($('fullName')?.value?.trim?.() || '') || fallbackName,
        fullName: ($('fullName')?.value?.trim?.() || '') || fallbackName,
        email: ($('email')?.value?.trim?.() || '') || fallbackEmail,
        employeeId: ($('employeeId')?.value?.trim?.() || '') || fallbackEmpId
      },

      itinerary: {
        purpose: ($('purpose')?.value?.trim?.() || '')
      },


      fromCity: $('fromCity').value,
      toCity: $('toCity').value,
      departDate: $('departDate').value,
      returnDate: $('returnDate').value,
      travelType: $('travelType').value,

      // Hotel (simple mode - stored for summary)
      hotelCity: $('hotelCity')?.value?.trim?.() || '',
      checkIn: $('checkIn')?.value || '',
      checkOut: $('checkOut')?.value || '',
      hotelNights: $('hotelNights')?.value || '',

      // Visa/passport (international)
      visaDocLink: visaLink,
      passportNumber: $('passportNumber')?.value || '',
      passportExpiry: $('passportExpiry')?.value || '',
      passportNationality: $('passportNationality')?.value || '',
      issuingCountry: $('issuingCountry')?.value || '',
      visaStatus: $('visaStatus')?.value || '',
      visaNumber: $('visaNumber')?.value || '',
      visaDocLink2: $('visaDocLink2')?.value?.trim?.() || ''
    };
    // Keep last submitted trip accessible for other buttons
    window.__lastTripRecord = tripRecord;

    try{
      const existing = loadTrips();
      existing.unshift(tripRecord);
      saveTrips(existing.slice(0,50));
      if(window.upsertGlobalTrip) window.upsertGlobalTrip(tripRecord);
    }catch(e){}

    // ‚úÖ Move to Confirmation UI first (so we don't lose the user to mailto navigation)
    $('step3').classList.add('hidden');
    $('step4').classList.remove('hidden');
    updateStepper(4);
    try{ $('step4').scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}

    // Mailto demo (opens user's email client)
    const toEmail = 'traveldesk2@etgworld.com';
    const subject = encodeURIComponent('New Travel Request - ' + reqId);
    const mgr = ($('managerEmail')?.value || '').trim();
    const cc = (mgr && isValidEmail(mgr)) ? `&cc=${encodeURIComponent(mgr)}` : '';
    const mailtoUrl = `mailto:${toEmail}?subject=${subject}${cc}&body=${body}`;

    // Always set a visible fallback link on the confirmation screen
    const ml = document.getElementById('mailtoLink');
    if(ml){ ml.href = mailtoUrl; }

    // Try to open in a new tab/window WITHOUT navigating away from this page.
    // If the browser blocks it, the fallback link remains.
    setTimeout(()=>{
      try{
        const a = document.createElement('a');
        a.href = mailtoUrl;
        a.target = '_blank';
        a.rel = 'noopener';
        document.body.appendChild(a);
        a.click();
        a.remove();
      }catch(e){}
    }, 80);
});

  $('btnStartOver')?.addEventListener('click',()=> location.reload());

  // ‚úÖ Go to Travel Desk Dashboard
  $('btnGoDesk')?.addEventListener('click', ()=>{
    // Navigate to TravelDesk with encoded payload (works even in file:// where localStorage may be blocked)
try{
  const payload = btoa(unescape(encodeURIComponent(JSON.stringify(window.__lastTripRecord || {})))).replace(/=+$/,'');
  window.location.href = 'Stage3_Traveldesk_Dashboard.html#trip=' + encodeURIComponent(payload);
}catch(e){
  window.location.href = 'Stage3_Traveldesk_Dashboard.html';
}
  });

  // Back to Dashboard (from Create Trip wizard)
  (function(){
    const back = document.getElementById('btnBackDashboard');
    const hero = document.getElementById('heroSection');
    const wizard = document.getElementById('wizardSection');
    if(back){
      back.addEventListener('click', ()=>{
        wizard && wizard.classList.add('hidden');
        hero && hero.classList.remove('hidden');
        try{ hero && hero.scrollIntoView({behavior:'smooth', block:'start'}); }catch(e){}
      });
    }
  })();


;

(function(){
  function $(id){ return document.getElementById(id); }

  function calcNights(inVal, outVal){
    try{
      if(!inVal || !outVal) return '';
      const a = new Date(inVal);
      const b = new Date(outVal);
      if(isNaN(a) || isNaN(b)) return '';
      const ms = b.getTime() - a.getTime();
      const days = Math.round(ms / (1000*60*60*24));
      return days > 0 ? String(days) : '';
    }catch(e){ return ''; }
  }

  function syncHotelNightsSimple(){
    const cin = $('checkIn')?.value || '';
    const cout = $('checkOut')?.value || '';
    const nights = calcNights(cin, cout);
    const out = $('hotelNights');
    if(out) out.value = nights;
  }

  function syncHotelNightsMultiRow(row){
    if(!row) return;
    const cin = row.querySelector('.hIn')?.value || '';
    const cout = row.querySelector('.hOut')?.value || '';
    const nights = calcNights(cin, cout);
    const out = row.querySelector('.hNights');
    if(out) out.value = nights;
  }

  function bindHotelNightCalculations(){
    // Simple
    $('checkIn')?.addEventListener('change', syncHotelNightsSimple);
    $('checkOut')?.addEventListener('change', syncHotelNightsSimple);

    // Multi (delegated)
    const holder = $('hotelSegments');
    if(holder){
      holder.addEventListener('change', (e)=>{
        const row = e.target?.closest?.('[data-seg]');
        if(row) syncHotelNightsMultiRow(row);
      });
      // initial
      Array.from(holder.children).forEach(r=> syncHotelNightsMultiRow(r));
    }
    // initial
    syncHotelNightsSimple();
  }

    function setTripType(val){
    const sel = $('tripType');
    if(sel){ sel.value = val; }
    const map = { round:'ttRound', oneway:'ttOne', multi:'ttMulti' };
    Object.entries(map).forEach(([v,btnId])=>{
      const b = $(btnId);
      if(b){ b.setAttribute('aria-pressed', v===val ? 'true':'false'); }
    });

    const returnWrap = $('returnWrap');
    const returnDate = $('returnDate');
    const routeSimple = $('routeSimple');
    const routeMulti = $('routeMulti');

    // Toggle route blocks
    if(routeSimple) routeSimple.classList.toggle('hidden', val==='multi');
    if(routeMulti) routeMulti.classList.toggle('hidden', val!=='multi');

    // Toggle return date
    const isOneWay = val==='oneway';
    if(returnWrap) returnWrap.classList.toggle('hidden', isOneWay || val==='multi');
    if(returnDate){
      returnDate.required = !(isOneWay || val==='multi');
      if(isOneWay || val==='multi') returnDate.value = '';
    }

    // keep UI + nights in sync after changing trip type
    updateServiceTripTypeUI();
    bindHotelNightCalculations();
  }

  function bindTripTypeTabs(){
    const round = $('ttRound'), one = $('ttOne'), multi = $('ttMulti');
    if(round) round.addEventListener('click', ()=>setTripType('round'));
    if(one) one.addEventListener('click', ()=>setTripType('oneway'));
    if(multi) multi.addEventListener('click', ()=>setTripType('multi'));

    // Initialize based on hidden select (or default)
    const sel = $('tripType');
    const initial = sel?.value || 'round';
    setTripType(initial);
  }

  function bindSwap(){
    const btn = $('swapBtn');
    const from = $('fromCity');
    const to = $('toCity');
    if(!btn || !from || !to) return;
    btn.addEventListener('click', ()=>{
      const a = from.value;
      from.value = to.value;
      to.value = a;
    });
  }

  // Multi-city segments (FLIGHT)
function createFlightSegRow(i){
  const row = document.createElement('div');
  row.className = 'row';
  row.style.marginTop = '10px';
  row.dataset.seg = String(i);
  row.innerHTML = `
    <div class="col-3">
      <label>From *</label>
      <input class="fFrom" list="airportList" placeholder="City, Airport or IATA (e.g., DEL)"/>
    </div>
    <div class="col-3">
      <label>To *</label>
      <input class="fTo" list="airportList" placeholder="City, Airport or IATA (e.g., BOM)"/>
    </div>
    <div class="col-3">
      <label>Departure Date *</label>
      <input class="fDate" type="date"/>
    </div>
    <div class="col-2">
      <label>Seat Class *</label>
      <select class="fClass">
        <option>Economy</option>
        <option>Premium Economy</option>
        <option>Business</option>
      </select>
    </div>
    <div class="col-1" style="display:flex;align-items:end;justify-content:flex-end">
      <button type="button" class="btn ghost fDel" title="Remove">‚úñ</button>
    </div>
  `;
  row.querySelector('.fDel')?.addEventListener('click', ()=>{
    row.remove();
    // Keep at least 2 segments for multi-city flight
    const holder = document.getElementById('segments');
    if(holder && holder.children.length < 2){
      while(holder.children.length < 2){
        holder.appendChild(createFlightSegRow(holder.children.length+1));
      }
    }
    updateServiceTripTypeUI();
  });
  return row;
}

// Multi-city segments (HOTEL)
function createHotelSegRow(i){
  const row = document.createElement('div');
  row.className = 'row';
  row.style.marginTop = '10px';
  row.dataset.seg = String(i);
  row.innerHTML = `
    <div class="col-3">
      <label>City *</label>
      <input class="hCity" placeholder="e.g., New Delhi"/>
    </div>
    <div class="col-3">
      <label>Check-in *</label>
      <input class="hIn" type="date"/>
    </div>
    <div class="col-3">
      <label>Check-out *</label>
      <input class="hOut" type="date"/>
    </div>
    <div class="col-2">
      <label>Nights</label>
      <input class="hNights" type="number" min="1" placeholder="Auto" readonly/>
    </div>
    <div class="col-1" style="display:flex;align-items:end;justify-content:flex-end">
      <button type="button" class="btn ghost hDel" title="Remove">‚úñ</button>
    </div>
  `;
  row.querySelector('.hDel')?.addEventListener('click', ()=>{
    row.remove();
    // Keep at least 1 segment
    const holder = document.getElementById('hotelSegments');
    if(holder && holder.children.length===0){
      holder.appendChild(createHotelSegRow(1));
    }
    updateServiceTripTypeUI();
  });
  return row;
}

function bindHotelSegments(){
    const holder = $('hotelSegments');
    const add = $('btnAddHotelSeg');
    const clear = $('btnClearHotelSegs');
    if(!holder) return;

    function ensureAtLeast(n){
      while(holder.children.length < n){
        holder.appendChild(createHotelSegRow(holder.children.length+1));
      }
    }

    if(add) add.addEventListener('click', ()=> ensureAtLeast(holder.children.length+1));
    if(clear) clear.addEventListener('click', ()=>{ holder.innerHTML=''; ensureAtLeast(2); updateServiceTripTypeUI(); });

    // Default 2 segments for multi-city
    ensureAtLeast(2);
  }

  function createCabSegRow(i){
    const wrap = document.createElement('div');
    wrap.className = 'cabSegWrap';
    wrap.style.marginTop = '10px';
    wrap.dataset.seg = String(i);

    wrap.innerHTML = `
      <div class="row">
        <div class="col-3">
          <label>Pickup *</label>
          <input class="cPick" placeholder="Pickup location"/>
        </div>
        <div class="col-3">
          <label>Pickup link</label>
          <input class="cPickLink" type="url" placeholder="https://maps.google.com/..."/>
        </div>
        <div class="col-3">
          <label>Drop *</label>
          <input class="cDrop" placeholder="Drop location"/>
        </div>
        <div class="col-3">
          <label>Drop link</label>
          <input class="cDropLink" type="url" placeholder="https://maps.google.com/..."/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <div class="col-4">
          <label>Date *</label>
          <input class="cDate" type="date"/>
        </div>
        <div class="col-3">
          <label>Time *</label>
          <input class="cTime" type="time"/>
        </div>
        <div class="col-4"></div>
        <div class="col-1" style="display:flex;align-items:end;justify-content:flex-end">
          <button type="button" class="btn ghost cDel" title="Remove">‚úñ</button>
        </div>
      </div>
    `;

    wrap.querySelector('.cDel')?.addEventListener('click', ()=>{
      wrap.remove();
      // Keep at least 1 segment
      const holder = document.getElementById('cabSegments');
      if(holder && holder.children.length===0){
        holder.appendChild(createCabSegRow(1));
      }
      updateServiceTripTypeUI();
    });
    return wrap;
  }

  function bindCabSegments(){
    const holder = $('cabSegments');
    const add = $('btnAddCabSeg');
    const clear = $('btnClearCabSegs');
    if(!holder) return;

    function ensureAtLeast(n){
      while(holder.children.length < n){
        holder.appendChild(createCabSegRow(holder.children.length+1));
      }
    }

    if(add) add.addEventListener('click', ()=> ensureAtLeast(holder.children.length+1));
    if(clear) clear.addEventListener('click', ()=>{ holder.innerHTML=''; ensureAtLeast(2); updateServiceTripTypeUI(); });

    ensureAtLeast(2);
  }

  function updateServiceTripTypeUI(){
    const val = $('tripType')?.value || 'round';
    const onH = !!document.getElementById('svcHotel')?.checked;
    const onC = !!document.getElementById('svcCab')?.checked;

    const hotelSimple = $('hotelSimple');
    const hotelMulti  = $('hotelMulti');
    const cabSimple   = $('cabSimple');
    const cabMulti    = $('cabMulti');

    // Show multi segment controls ONLY when multi-city AND that service is enabled
    const showMulti = (val === 'multi');

    if(hotelSimple) hotelSimple.classList.toggle('hidden', showMulti);
    if(hotelMulti)  hotelMulti.classList.toggle('hidden', !showMulti);
    if(cabSimple)   cabSimple.classList.toggle('hidden', showMulti);
    if(cabMulti)    cabMulti.classList.toggle('hidden', !showMulti);

    // Hide segment UIs entirely if service not selected
    if(hotelMulti) hotelMulti.classList.toggle('hidden', !showMulti || !onH);
    if(cabMulti)   cabMulti.classList.toggle('hidden', !showMulti || !onC);

    const setReq = (el, on)=>{
      if(!el) return;
      if(on) el.setAttribute('required','required');
      else el.removeAttribute('required');
    };

    // Simple hotel required only when not multi
    ['hotelCity','checkIn','checkOut'].forEach(id=> setReq(document.getElementById(id), onH && !showMulti));
    // Multi hotel required when multi
    document.querySelectorAll('#hotelSegments .hCity, #hotelSegments .hIn, #hotelSegments .hOut')
      .forEach(el=> setReq(el, onH && showMulti));

    // Simple cab required only when not multi
    ['cabPickup','cabDrop','cabDate','cabTime'].forEach(id=> setReq(document.getElementById(id), onC && !showMulti));
    // Multi cab required when multi
    document.querySelectorAll('#cabSegments .cPick, #cabSegments .cDrop, #cabSegments .cDate, #cabSegments .cTime')
      .forEach(el=> setReq(el, onC && showMulti));
  }

function bindSegments(){
    const holder = $('segments');
    const add = $('btnAddSeg');
    const clear = $('btnClearSegs');
    if(!holder) return;

    function ensureAtLeast(n){
      while(holder.children.length < n){
        holder.appendChild(createFlightSegRow(holder.children.length+1));
      }
    }

    if(add) add.addEventListener('click', ()=> ensureAtLeast(holder.children.length+1));
    if(clear) clear.addEventListener('click', ()=>{ holder.innerHTML=''; ensureAtLeast(2); });

    // default 2 segments for multi-city
    ensureAtLeast(2);
  }

  function bindServices(){
    const svcFlight = document.getElementById('svcFlight');
    const svcHotel  = document.getElementById('svcHotel');
    const svcCab    = document.getElementById('svcCab');

    const flightBlock = document.getElementById('flightBlock');
    const hotelBlock  = document.getElementById('hotelBlock');
    const cabBlock    = document.getElementById('cabBlock');

    const err = document.getElementById('err_services');

    if(!svcFlight || !svcHotel || !svcCab) return;

    const setReq = (id, on)=>{
      const el = document.getElementById(id);
      if(!el) return;
      if(on) el.setAttribute('required','required');
      else el.removeAttribute('required');
    };

    const setReqEl = (el, on)=>{
      if(!el) return;
      if(on) el.setAttribute('required','required');
      else el.removeAttribute('required');
    };

    const sync = ()=>{
      const onF = !!svcFlight.checked;
      const onH = !!svcHotel.checked;
      const onC = !!svcCab.checked;

      if(flightBlock) flightBlock.classList.toggle('hidden', !onF);
      if(hotelBlock)  hotelBlock.classList.toggle('hidden', !onH);
      if(cabBlock)    cabBlock.classList.toggle('hidden', !onC);

      // Required fields per block
      // Flight (ids already in page)
      ['fromCity','toCity','seatClassSimple','departDate'].forEach(id=> setReq(id, onF && !showMulti));
      // Multi-city flight segments required when multi
      document.querySelectorAll('#segments .fFrom, #segments .fTo, #segments .fDate, #segments .fClass')
        .forEach(el=> setReqEl(el, onF && showMulti));
      // Return date only when round-trip
      const tripType = document.getElementById('tripType');
      const isRound = !tripType || (tripType.value === 'round');
      setReq('returnDate', onF && isRound);

            // Hotel/Cab required fields handled by updateServiceTripTypeUI()
      updateServiceTripTypeUI();

// Validation message
      if(err){
        const any = onF || onH || onC;
        err.classList.toggle('hidden', any);
        err.textContent = any ? '' : 'Select at least one service (Flight / Hotel / Cab).';
      }
    };

    // Click/toggle handling (label contains input so change is enough)
    [svcFlight, svcHotel, svcCab].forEach(el=> el.addEventListener('change', sync));

    // Initial state
    sync();
  }


  function init(){
    // Only on pages where trip UI exists
    if(document.getElementById('tripType')){
      bindTripTypeTabs();
      bindSwap();
      bindSegments();
      bindHotelSegments();
      bindCabSegments();
      bindServices();
      updateServiceTripTypeUI();
      $("travelType")?.addEventListener("change", ()=>{ toggleInternationalDocs(); updateServiceTripTypeUI(); });
      toggleInternationalDocs();
}
  }

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', init);
  }else{
    init();
  }
})();

</script>

<!-- ‚úÖ Profile Edit Fix: Works on file:// and localhost (stores per-user profile in localStorage) -->
<script>
(function () {
  const $ = (id) => document.getElementById(id);

  function getEmail(){
    const qp = new URLSearchParams(location.search).get("email");
    const fromStorage =
      localStorage.getItem("etg-current-user-email") ||
      (localStorage.getItem("etg-login") ? (JSON.parse(localStorage.getItem("etg-login"))||{}).email : "") ||
      (sessionStorage.getItem("etg-login") ? (JSON.parse(sessionStorage.getItem("etg-login"))||{}).email : "");
    return (qp || fromStorage || "").toString().trim().toLowerCase();
  }

  const email = getEmail();
  if (!email) {
    // No logged-in user context; keep the UI as-is.
    return;
  }

  const STORAGE_KEY = "etg-profile:" + email;

  function guessNameFromEmail(em) {
    const left = (em.split("@")[0] || "").replace(/[._-]+/g, " ").trim();
    return left ? left.split(/\s+/).map(w=>w? w[0].toUpperCase()+w.slice(1):"").join(" ") : em;
  }

  function loadProfile() {
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}; }
    catch { return {}; }
  }

  function saveProfile(data) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function initials(name) {
    const parts = String(name || "").trim().split(/\s+/).filter(Boolean);
    const a = (parts[0]||"")[0] || "";
    const b = (parts[1]||parts[0]||"")[0] || "";
    return (a+b).toUpperCase() || "--";
  }

  // --- Ensure modal opens and renders editable inputs ---
  const openBtn = $("openProfile");
  const modal = $("profileModal");
  const closeBtn = $("closeProfileBtn");
  const backdrop = $("profileBackdrop");
  const fields = $("profileFields");
  const avatar = $("profileAvatar");
  const sub = $("profileSub");

  if (!openBtn || !modal || !fields) return;

  function renderProfile() {
    const p = loadProfile();
    const name = p.name || localStorage.getItem("etg-current-user-name") || guessNameFromEmail(email);

    if (avatar) avatar.textContent = initials(name);
    if (sub) sub.textContent = email;

    fields.innerHTML = `
      ${field("NAME", "name", name, "text")}
      ${field("DATE OF BIRTH", "dob", p.dob || "", "date")}
      ${selectField("GENDER", "gender", p.gender || "")}
      ${field("EMAIL", "email", email, "text", true)}
      ${field("MOBILE NUMBER", "mobile", p.mobile || "", "tel")}
      ${field("PASSWORD", "password", p.password || "", "password")}
      ${field("DEPARTMENT", "department", p.department || "", "text")}
      ${field("EMPLOYEE ID", "empId", p.empId || "", "text")}
      <div style="grid-column:1 / -1; display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
        <button type="button" id="profileCancelBtn" class="btn secondary">Cancel</button>
        <button type="button" id="profileSaveBtn" class="btn">Save</button>
      </div>
    `;

    const cancelBtn = $("profileCancelBtn");
    const saveBtn = $("profileSaveBtn");
    if (cancelBtn) cancelBtn.onclick = close;
    if (saveBtn) saveBtn.onclick = onSave;
  }

  function field(label, key, value, type, disabled=false) {
    const safeVal = String(value ?? "").replace(/"/g, "&quot;");
    const dis = disabled ? "disabled" : "";
    return `
      <div class="profile-field">
        <div class="profile-label">${label}</div>
        <input id="pf_${key}" type="${type}" value="${safeVal}" ${dis} />
      </div>
    `;
  }

  function selectField(label, key, value){
    const v = String(value||"");
    return `
      <div class="profile-field">
        <div class="profile-label">${label}</div>
        <select id="pf_${key}">
          <option value="" ${v===""?"selected":""}>Select</option>
          <option value="Male" ${v==="Male"?"selected":""}>Male</option>
          <option value="Female" ${v==="Female"?"selected":""}>Female</option>
          <option value="Other" ${v==="Other"?"selected":""}>Other</option>
          <option value="Prefer not to say" ${v==="Prefer not to say"?"selected":""}>Prefer not to say</option>
        </select>
      </div>
    `;
  }

  function close(){
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden","true");
    openBtn.setAttribute("aria-expanded","false");
  }

  function open(){
    renderProfile();
    modal.classList.add("open");
    modal.setAttribute("aria-hidden","false");
    openBtn.setAttribute("aria-expanded","true");
  }

  function onSave(){
    const data = {
      email,
      name: ($("pf_name")?.value || "").trim(),
      dob: $("pf_dob")?.value || "",
      gender: $("pf_gender")?.value || "",
      mobile: ($("pf_mobile")?.value || "").trim(),
      password: $("pf_password")?.value || "",
      department: ($("pf_department")?.value || "").trim(),
      empId: ($("pf_empId")?.value || "").trim(),
      updatedAt: new Date().toISOString()
    };
    if (!data.name) data.name = guessNameFromEmail(email);

    saveProfile(data);

    // Update header widgets immediately (if present)
    const userNameText = $("userNameText");
    const welcomeName = $("welcomeName");
    const userAvatar = $("userAvatar");
    const userInitialsLarge = $("userInitialsLarge");

    if (userNameText) userNameText.textContent = data.name;
    if (welcomeName) welcomeName.textContent = data.name;
    const ini = initials(data.name);
    if (userAvatar) userAvatar.textContent = ini;
    if (userInitialsLarge) userInitialsLarge.textContent = ini;

    // Keep shared keys in sync for other stages
    try{
      localStorage.setItem("etg-current-user-name", data.name);
      localStorage.setItem("etg-current-user-email", email);
    }catch(e){}

    close();
    alert("Profile saved successfully.");
  }

  // Wire open/close (override any existing listeners safely)
  openBtn.onclick = open;
  if (closeBtn) closeBtn.onclick = close;
  if (backdrop) backdrop.onclick = close;

  // Optional: Esc closes
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && modal.classList.contains("open")) close();
  });

})();
</script>



<script>
/* ‚úÖ Auto-fill Step 1 fields from "My Profile" (per logged-in email)
   - Reads: localStorage["etg-profile:<email>"]
   - Fills Step 1 inputs only if they are empty (won't overwrite user typing)
*/
(function(){
  const $ = (id)=>document.getElementById(id);

  function getQueryParam(name){
    try{ return new URL(window.location.href).searchParams.get(name) || ''; }
    catch(e){
      const m = new RegExp('[?&]'+name+'=([^&]*)').exec(window.location.search || '');
      return m ? decodeURIComponent(m[1].replace(/\+/g,' ')) : '';
    }
  }

  function getLoginEmail(){
    // 1) URL param
    const qp = String(getQueryParam('email') || '').trim().toLowerCase();
    if(qp) return qp;

    // 2) etg-login context (local/session)
    try{
      const local = localStorage.getItem('etg-login');
      const sess  = sessionStorage.getItem('etg-login');
      const ctx = local ? JSON.parse(local) : (sess ? JSON.parse(sess) : null);
      const e = ctx && ctx.email ? String(ctx.email).trim().toLowerCase() : '';
      if(e) return e;
    }catch(e){}

    // 3) legacy
    const legacy = String(localStorage.getItem('etg-current-user-email') || '').trim().toLowerCase();
    return legacy || '';
  }

  function loadProfile(email){
    if(!email) return null;
    try{
      const raw = localStorage.getItem('etg-profile:' + email);
      return raw ? (JSON.parse(raw) || null) : null;
    }catch(e){ return null; }
  }

  function splitMobile(mobile){
    // Accepts: "+91 9876543210" OR "+91-987..." OR "987..."
    const s = String(mobile || '').trim();
    if(!s) return { phoneCode:'', phone:'' };
    const m = s.match(/^(\+\d{1,4})[\s-]*([0-9\s]{6,})$/);
    if(m) return { phoneCode: m[1], phone: m[2].replace(/\s+/g,'').trim() };
    return { phoneCode:'', phone: s.replace(/\s+/g,'').trim() };
  }

  function setIfEmpty(el, value){
    if(!el) return;
    const cur = String(el.value || '').trim();
    if(cur) return;
    if(value === undefined || value === null) return;
    const v = String(value).trim();
    if(!v) return;
    el.value = v;
    el.dispatchEvent(new Event('input', { bubbles:true }));
    el.dispatchEvent(new Event('change', { bubbles:true }));
  }

  function fillFromProfile(){
    const email = getLoginEmail();
    const p = loadProfile(email);
    if(!p) return;

    // Map profile -> Step 1 fields
    const fullName = p.name || p.fullName || '';
    const dept = p.department || p.costCenter || '';
    const empId = p.empId || p.employeeId || '';
    const mgr = p.managerEmail || '';
    const travelerType = p.travelerType || '';
    const nationality = p.nationality || '';

    const mob = splitMobile(p.mobile || p.phone || '');

    // Contact Information
    setIfEmpty($('fullName'), fullName);
    setIfEmpty($('email'), email || (p.email || ''));
    if(mob.phoneCode) setIfEmpty($('phoneCode'), mob.phoneCode);
    if(mob.phone) setIfEmpty($('phone'), mob.phone);

    if(travelerType) setIfEmpty($('travelerType'), travelerType);
    if(nationality) setIfEmpty($('nationalityEmp'), nationality);

    // Organization
    setIfEmpty($('costCenter'), dept);
    setIfEmpty($('subBusinessUnitName'), p.subBusinessUnitName || p.subBusinessUnit || '');
    setIfEmpty($('costCenterLocation'), p.costCenterLocation || p.location || '');
    setIfEmpty($('employeeId'), empId);
    setIfEmpty($('managerEmail'), mgr);
  }

  // Run once now
  document.addEventListener('DOMContentLoaded', ()=> {
    fillFromProfile();

    // Also run whenever the user enters the wizard (Create Trip buttons)
    ['createTripBtn','myTripsCreateBtn','reportCreateBtn'].forEach(id=>{
      const btn = $(id);
      if(btn){
        btn.addEventListener('click', ()=>{
          setTimeout(fillFromProfile, 50);
        });
      }
    });

    // If profile is saved in the modal, we refresh the form fill too.
    // (Our profile fix uses a Save button with id="saveProfileBtn" inside the modal.)
    document.addEventListener('click', (e)=>{
      const t = e.target;
      if(t && t.id === 'saveProfileBtn'){
        setTimeout(fillFromProfile, 50);
      }
    });
  });
})();
</script>


<script>
(function(){
  const $ = (id)=>document.getElementById(id);

  function getQueryParam(name){
    try { return new URL(location.href).searchParams.get(name) || ''; }
    catch(e){ return ''; }
  }

  function currentEmail(){
    return (localStorage.getItem('etg-current-user-email') || getQueryParam('email') || '').toString().trim().toLowerCase();
  }
  function key(email){ return 'etg-roles-approvers:' + (email||'').toLowerCase(); }

  function load(email){
    try{ return JSON.parse(localStorage.getItem(key(email))||'{}') || {}; }catch(e){ return {}; }
  }
  function save(email, data){
    localStorage.setItem(key(email), JSON.stringify(Object.assign({}, data, {email, updatedAt:new Date().toISOString()})));
  }

  // Open/close modal
  const btnOpen = $('openRolesApprovers');
  const modal = $('rolesApproversModal');
  const btnClose = $('closeRolesApproversBtn');
  const backdrop = $('rolesApproversBackdrop');
  const btnCancel = $('raCancelBtn');
  const btnSave = $('raSaveBtn');

  if(!btnOpen || !modal) return;

  function open(){
    const email = currentEmail();
    const data = load(email);

    // Set avatar initials from current user
    const name = (localStorage.getItem('etg-current-user-name')||'').toString().trim();
    const initials = (name ? name.split(/\s+/).slice(0,2).map(s=>s[0]).join('') : (email ? email[0] : '--')).toUpperCase();
    const av = $('rolesApproversAvatar'); if(av) av.textContent = initials || '--';

    const rm = data.reportingManagerEmail || data.managerEmail || '';
    const td = data.travelDeskEmail || '';
    const fin = data.financeEmail || '';
    const ex = data.exceptionalApproverEmail || '';
    const admin = data.appSuperAdminEmail || '';

    const rmEl = $('ra-reportingManagerEmail'); if(rmEl) rmEl.value = rm;
    const tdEl = $('ra-travelDeskEmail'); if(tdEl) tdEl.value = td;
    const finEl = $('ra-financeEmail'); if(finEl) finEl.value = fin;
    const exEl = $('ra-exceptionalApproverEmail'); if(exEl) exEl.value = ex;
    const adEl = $('ra-appSuperAdminEmail'); if(adEl) adEl.value = admin;

    modal.classList.add('open');
  }
  function close(){ modal.classList.remove('open'); }

  btnOpen.addEventListener('click', open);
  if(btnClose) btnClose.addEventListener('click', close);
  if(backdrop) backdrop.addEventListener('click', close);
  if(btnCancel) btnCancel.addEventListener('click', close);

  if(btnSave){
    btnSave.addEventListener('click', ()=>{
      const email = currentEmail();
      if(!email){ alert('No logged-in user detected. Please login again.'); return; }

      const reportingManagerEmail = ($('ra-reportingManagerEmail') ? $('ra-reportingManagerEmail').value.trim() : '');
      const travelDeskEmail = ($('ra-travelDeskEmail') ? $('ra-travelDeskEmail').value.trim() : '');
      const financeEmail = ($('ra-financeEmail') ? $('ra-financeEmail').value.trim() : '');
      const exceptionalApproverEmail = ($('ra-exceptionalApproverEmail') ? $('ra-exceptionalApproverEmail').value.trim() : '');
      const appSuperAdminEmail = ($('ra-appSuperAdminEmail') ? $('ra-appSuperAdminEmail').value.trim() : '');

      save(email, { reportingManagerEmail, travelDeskEmail, financeEmail, exceptionalApproverEmail, appSuperAdminEmail });

      // If Step 1 manager email input exists and empty, auto-fill it from Reporting manager
      const mgrInput = $('managerEmail');
      if(mgrInput && !mgrInput.value.trim() && reportingManagerEmail) mgrInput.value = reportingManagerEmail;

      // Also store into profile record so other autofill logic can reuse it
      try{
        const profileKey = 'etg-profile:' + email;
        const profile = JSON.parse(localStorage.getItem(profileKey)||'{}') || {};
        if(reportingManagerEmail) profile.managerEmail = reportingManagerEmail; // keep backward compatible key
        if(travelDeskEmail) profile.travelDeskEmail = travelDeskEmail;
        if(financeEmail) profile.financeEmail = financeEmail;
        if(exceptionalApproverEmail) profile.exceptionalApproverEmail = exceptionalApproverEmail;
        if(appSuperAdminEmail) profile.appSuperAdminEmail = appSuperAdminEmail;
        localStorage.setItem(profileKey, JSON.stringify(profile));
      }catch(e){}

      alert('Approver list saved.');
      close();
    });
  }

  // One-time: on page load, if roles/approvers exists, fill managerEmail if blank
  (function bootstrap(){
    const email = currentEmail();
    if(!email) return;
    const data = load(email);
    const mgrInput = $('managerEmail');
    if(mgrInput && !mgrInput.value.trim() && (data.reportingManagerEmail || data.managerEmail)) mgrInput.value = (data.reportingManagerEmail || data.managerEmail);
  })();

})();
</script>


<script>
/* ===========================
   Global Airport List (IATA)
   - Populates the datalist used by From/To
   - Offline-friendly: embedded dataset (major airports)
   - You can extend the AIRPORTS array anytime
=========================== */
(function(){
  const AIRPORTS = [{"iata": "BLR", "name": "Kempegowda International Airport", "city": "Bengaluru", "country": "India"}, {"iata": "DEL", "name": "Indira Gandhi International Airport", "city": "New Delhi", "country": "India"}, {"iata": "BOM", "name": "Chhatrapati Shivaji Maharaj International Airport", "city": "Mumbai", "country": "India"}, {"iata": "MAA", "name": "Chennai International Airport", "city": "Chennai", "country": "India"}, {"iata": "HYD", "name": "Rajiv Gandhi International Airport", "city": "Hyderabad", "country": "India"}, {"iata": "CCU", "name": "Netaji Subhas Chandra Bose International Airport", "city": "Kolkata", "country": "India"}, {"iata": "COK", "name": "Cochin International Airport", "city": "Kochi", "country": "India"}, {"iata": "PNQ", "name": "Pune Airport", "city": "Pune", "country": "India"}, {"iata": "AMD", "name": "Sardar Vallabhbhai Patel International Airport", "city": "Ahmedabad", "country": "India"}, {"iata": "GOI", "name": "Goa International Airport", "city": "Goa", "country": "India"}, {"iata": "DXB", "name": "Dubai International Airport", "city": "Dubai", "country": "United Arab Emirates"}, {"iata": "AUH", "name": "Zayed International Airport", "city": "Abu Dhabi", "country": "United Arab Emirates"}, {"iata": "DOH", "name": "Hamad International Airport", "city": "Doha", "country": "Qatar"}, {"iata": "RUH", "name": "King Khalid International Airport", "city": "Riyadh", "country": "Saudi Arabia"}, {"iata": "JED", "name": "King Abdulaziz International Airport", "city": "Jeddah", "country": "Saudi Arabia"}, {"iata": "MCT", "name": "Muscat International Airport", "city": "Muscat", "country": "Oman"}, {"iata": "SIN", "name": "Singapore Changi Airport", "city": "Singapore", "country": "Singapore"}, {"iata": "KUL", "name": "Kuala Lumpur International Airport", "city": "Kuala Lumpur", "country": "Malaysia"}, {"iata": "BKK", "name": "Suvarnabhumi Airport", "city": "Bangkok", "country": "Thailand"}, {"iata": "HKG", "name": "Hong Kong International Airport", "city": "Hong Kong", "country": "Hong Kong"}, {"iata": "TPE", "name": "Taiwan Taoyuan International Airport", "city": "Taipei", "country": "Taiwan"}, {"iata": "ICN", "name": "Incheon International Airport", "city": "Seoul", "country": "South Korea"}, {"iata": "HND", "name": "Haneda Airport", "city": "Tokyo", "country": "Japan"}, {"iata": "NRT", "name": "Narita International Airport", "city": "Tokyo", "country": "Japan"}, {"iata": "PEK", "name": "Beijing Capital International Airport", "city": "Beijing", "country": "China"}, {"iata": "PVG", "name": "Shanghai Pudong International Airport", "city": "Shanghai", "country": "China"}, {"iata": "SYD", "name": "Sydney Kingsford Smith Airport", "city": "Sydney", "country": "Australia"}, {"iata": "MEL", "name": "Melbourne Airport", "city": "Melbourne", "country": "Australia"}, {"iata": "AKL", "name": "Auckland Airport", "city": "Auckland", "country": "New Zealand"}, {"iata": "LHR", "name": "Heathrow Airport", "city": "London", "country": "United Kingdom"}, {"iata": "CDG", "name": "Charles de Gaulle Airport", "city": "Paris", "country": "France"}, {"iata": "AMS", "name": "Amsterdam Airport Schiphol", "city": "Amsterdam", "country": "Netherlands"}, {"iata": "FRA", "name": "Frankfurt Airport", "city": "Frankfurt", "country": "Germany"}, {"iata": "ZRH", "name": "Zurich Airport", "city": "Zurich", "country": "Switzerland"}, {"iata": "MAD", "name": "Adolfo Su√°rez Madrid‚ÄìBarajas Airport", "city": "Madrid", "country": "Spain"}, {"iata": "BCN", "name": "Barcelona‚ÄìEl Prat Airport", "city": "Barcelona", "country": "Spain"}, {"iata": "FCO", "name": "Rome‚ÄìFiumicino International Airport", "city": "Rome", "country": "Italy"}, {"iata": "IST", "name": "Istanbul Airport", "city": "Istanbul", "country": "Turkey"}, {"iata": "JFK", "name": "John F. Kennedy International Airport", "city": "New York", "country": "United States"}, {"iata": "EWR", "name": "Newark Liberty International Airport", "city": "Newark", "country": "United States"}, {"iata": "LAX", "name": "Los Angeles International Airport", "city": "Los Angeles", "country": "United States"}, {"iata": "SFO", "name": "San Francisco International Airport", "city": "San Francisco", "country": "United States"}, {"iata": "ORD", "name": "O'Hare International Airport", "city": "Chicago", "country": "United States"}, {"iata": "DFW", "name": "Dallas/Fort Worth International Airport", "city": "Dallas", "country": "United States"}, {"iata": "MIA", "name": "Miami International Airport", "city": "Miami", "country": "United States"}, {"iata": "ATL", "name": "Hartsfield‚ÄìJackson Atlanta International Airport", "city": "Atlanta", "country": "United States"}, {"iata": "YYZ", "name": "Toronto Pearson International Airport", "city": "Toronto", "country": "Canada"}, {"iata": "YVR", "name": "Vancouver International Airport", "city": "Vancouver", "country": "Canada"}, {"iata": "MEX", "name": "Mexico City International Airport", "city": "Mexico City", "country": "Mexico"}, {"iata": "GRU", "name": "S√£o Paulo/Guarulhos International Airport", "city": "S√£o Paulo", "country": "Brazil"}, {"iata": "EZE", "name": "Ministro Pistarini International Airport", "city": "Buenos Aires", "country": "Argentina"}, {"iata": "JNB", "name": "O. R. Tambo International Airport", "city": "Johannesburg", "country": "South Africa"}, {"iata": "CAI", "name": "Cairo International Airport", "city": "Cairo", "country": "Egypt"}];

  const dl = document.getElementById('airportList');
  if(!dl) return;

  function label(a){
    const city = a.city ? a.city.trim() : '';
    const name = a.name ? a.name.trim() : '';
    const iata = (a.iata||'').trim().toUpperCase();
    const country = a.country ? a.country.trim() : '';
    return `${city} ‚Äî ${name} (${iata})${country ? ' ‚Äì ' + country : ''}`;
  }

  function build(){
    dl.innerHTML = '<!-- Populated automatically with global airports (City ‚Äî Airport Name (IATA)) -->';
    const seen = new Set();
    AIRPORTS.forEach(a=>{
      const iata = (a.iata||'').toUpperCase();
      if(!iata || seen.has(iata)) return;
      seen.add(iata);
      const opt = document.createElement('option');
      opt.value = label(a);
      dl.appendChild(opt);
    });
  }

  function normalizeOnBlur(inputId){
    const el = document.getElementById(inputId);
    if(!el) return;
    el.addEventListener('blur', ()=>{
      const raw = (el.value||'').trim();
      if(!raw) return;
      const m = raw.match(/^([A-Za-z]{3})$/);
      const code = m ? m[1].toUpperCase() : null;
      if(!code) return;
      const found = AIRPORTS.find(a => (a.iata||'').toUpperCase() === code);
      if(found) el.value = label(found);
    });
  }

  build();
  normalizeOnBlur('fromCity');
  normalizeOnBlur('toCity');
})();
</script>



<script>window.ETG_API_BASE = window.ETG_API_BASE || '';</script>
<script src="/socket.io/socket.io.js"></script>
<script src="/etg-realtime.js"></script>

</body>
</html>
